<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>使用 Node.js + express + MySQL 建立一個後端服務 REST API | 永誌不忘 • 筆記簿</title>
<meta name=keywords content="Node.js,express,mysql,JWT,webapi">
<meta name=description content="Node.js + express 來建立 REST API 服務，同時為提高網路安全性採取了 JWT JSON Web Token）來實作使用者驗證機制。資料庫的部份是使用 MySQL，為方便起見，採用 Docker 來執行 MySQL。">
<meta name=author content="Theme PaperMod">
<link rel=canonical href=https://calvinegs.github.io/posts/nodejs-restapi-mysql/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://calvinegs.github.io/img/favicon.png>
<link rel=icon type=image/png sizes=16x16 href=https://calvinegs.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://calvinegs.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://calvinegs.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://calvinegs.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.89.3">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="使用 Node.js + express + MySQL 建立一個後端服務 REST API">
<meta property="og:description" content="Node.js + express 來建立 REST API 服務，同時為提高網路安全性採取了 JWT JSON Web Token）來實作使用者驗證機制。資料庫的部份是使用 MySQL，為方便起見，採用 Docker 來執行 MySQL。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://calvinegs.github.io/posts/nodejs-restapi-mysql/"><meta property="og:image" content="https://calvinegs.github.io/papermod-cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-07-04T00:00:00+00:00">
<meta property="article:modified_time" content="2022-07-04T00:00:00+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://calvinegs.github.io/papermod-cover.png">
<meta name=twitter:title content="使用 Node.js + express + MySQL 建立一個後端服務 REST API">
<meta name=twitter:description content="Node.js + express 來建立 REST API 服務，同時為提高網路安全性採取了 JWT JSON Web Token）來實作使用者驗證機制。資料庫的部份是使用 MySQL，為方便起見，採用 Docker 來執行 MySQL。">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://calvinegs.github.io/posts/"},{"@type":"ListItem","position":2,"name":"使用 Node.js + express + MySQL 建立一個後端服務 REST API","item":"https://calvinegs.github.io/posts/nodejs-restapi-mysql/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用 Node.js + express + MySQL 建立一個後端服務 REST API","name":"使用 Node.js \u002b express \u002b MySQL 建立一個後端服務 REST API","description":"Node.js + express 來建立 REST API 服務，同時為提高網路安全性採取了 JWT JSON Web Token）來實作使用者驗證機制。資料庫的部份是使用 MySQL，為方便起見，採用 Docker 來執行 MySQL。","keywords":["Node.js","express","mysql","JWT","webapi"],"articleBody":"github Source code\nTechnology:\n NodeJs 17.6.0 Express 4.18.1 cors 2.8.5 crypto-js 4.1.1 # 加解密套件 jsonwebtoken 8.5.1 # Json Web Token 的功能套件 sequelize 6.20.2 # ORM 套件 mysql2 2.3.3 # MySQL client for Node.js MySQL 8.0 # 使用的資料庫  專案完成後的檔案結構 ./專案目錄 ├── app/ │ ├── config/ │ │ └── db.config.js │ ├── middleware/ │ │ ├── auth.jwt.js │ │ ├── index.js │ │ └── verify.signup.js │ ├── models/ │ │ ├── index.js │ │ ├── role.model.js │ │ ├── todo.model.js │ │ └── user.model.js │ ├── routes/ │ │ ├── auth.routes.js │ │ ├── todo.routes.js │ │ └── user.routes.js │ └── services/ │ ├── auth.service.js │ ├── todo.service.js │ └── user.service.js ├── node_modules/ ├── .env ├── .gitignore ├── package.json ├── README.md ├── server.js └── yarn-lock 專案完成後所提供的 API 端點    Methods Urls Actions     POST /api/auth/signup 註冊新使用者帳號   POST /api/auth/signin 使用者帳號登入   GET /api/todos get all Todos   GET /api/todos/:id get Todo by id   GET /api/todos/done find all done Todos   GET /api/todos/title=[keyword] find all Todos whick title contains keyword   POST /api/todos add New Todo   PUT /api/todos/:id update Todo by id   DELETE /api/todos/:id remove Todo by id   DELETE /api/todos remove all Todos    設置專案環境 $ node --version # 檢測環境已裝妥 node.js (若已安裝會顯示目前安裝的版本） v17.6.0 $ mkdir nodejs-webapi-jwt-mysql \u0026\u0026 cd nodejs-webapi-jwt-mysql ＃ 建立一個專案目錄 $ npm init\t＃ 産生一專案設定檔 package.json $ touch server.js\t＃ 産生一個新檔案 package.json 預設的內容\n{ \"name\": \"nodejs-webapi-jwt-mysql\", \"version\": \"1.0.0\", \"description\": \"Node.js + express + JWT + MySQL\", \"main\": \"server.js\", \"scripts\": { \"test\": \"echo \\\"Error: no test specified\\\" \u0026\u0026 exit 1\" }, \"keywords\": [ \"node.js\", \"express\", \"jwt\", \"mysql\" ], \"author\": \"calvin\", \"license\": \"ISC\" } 安裝相依套件 $ yarn add express dotenv sequelize mysql2 # 加入相依套件 $ yarn add --dev nodemon # 加入開發時期相依套件 $ yarn add crypto-js jsonwebtoken # 使用者密碼加解密 / Json Web Token $ yarn add cors # 可跨網域提供 Webapi service 建立 git 初始版本\n$ git init $ echo 'node_modules/'  .gitignore # 新增 git ignore 設定檔，並設定 node_modules/ 目錄不加入版控 $ echo 'yarn.lock'  .gitignore $ git add . \u0026\u0026 git commit -m \"Initial commit\" 建立 git 初始版本的資訊 開啟 VSCode\n$ code . 設定專案啟動指令（如第七行的指令設定），當輸入 npm start 時系統自動以 node 來執行 server.js 程式，並即時監測 server.js 檔案有變化存檔時馬上重新啟動 node server.js 來執行該程式。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  { \"name\": \"nodejs-webapi-jwt-mysql\", \"version\": \"1.0.0\", \"description\": \"Node.js + exporess + JWT + MySQL\", \"main\": \"server.js\", \"scripts\": { \"start\": \"nodemon server.js\"  }, \"keywords\": [ \"node.js\", \"express\", \"jwt\", \"mysql\" ], \"author\": \"calvin\", \"license\": \"ISC\", \"dependencies\": { \"dotenv\": \"^16.0.1\", \"express\": \"^4.18.1\", \"pg\": \"^8.7.3\", \"pg-hstore\": \"^2.3.4\", \"sequelize\": \"^6.20.1\" }, \"devDependencies\": { \"nodemon\": \"^2.0.16\" } }    在 server.js 中加入此行程式，並在 vscode Terminal 中輸入 npm start\n console.log(\"Hi NodeJS...\")\t 顯示結果如下\n  nodejs-webapi-jwt-mysql@1.0.0 start  nodemon server.js [nodemon] 2.0.18 [nodemon] to restart at any time, enter `rs` [nodemon] watching path(s): *.* [nodemon] watching extensions: js,mjs,json [nodemon] starting `node server.js` Hi NodeJS... [nodemon] clean exit - waiting for changes before restart 建立一個 Express 應用程式  使用以下程式覆蓋 server.js 檔案\n const express = require(\"express\"); const app = express(); app.get('/', function (req, res) { res.send('Hello World') }); app.get(\"/api/test\", (req, res) = { console.log(\"test is successful\"); res.send(\"test is successful\"); }); const PORT = process.env.PORT || 5000; app.listen(PORT, () = { console.log(`Backend server is running on port ${PORT}`); })  存檔後，開啟 瀏覽器，輸入 localhost:5000/api/test，在 vscode terminal 視窗中會顯示：\n Backend server is running on port 5000 test is successful 使用 Node.js 連結 MySQL 若你還沒有安裝 MySQL 可以參考這筆記先將資料庫管理系統備妥 使用 Docker 執行 MySQL\n在程式中使用了 sequelize 這個套件的功能來連結 mysql 資料庫，直接透過 Sequelize constructor 來給定連結資料庫的參數，包含 “資料庫名稱“、”User Id\"、“Password”、“Host Name\"、“資料庫類別“(dialect)等。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const express = require(\"express\"); const app = express(); const { Sequelize } = require('sequelize'); const sequelize = new Sequelize('testdb', 'root', 'mysql@12345', { host: 'localhost', dialect: 'mysql' }); try { sequelize.authenticate(); console.log('Connection has been established successfully.'); } catch (error) { console.error('Unable to connect to the database:', error); } app.get(\"/api/test\", (req, res) = { console.log(\"test is successful\"); res.send(\"test is successful\"); }); const PORT = process.env.PORT || 5000; app.listen(PORT, () = { console.log(`Backend server is running on port ${PORT}`); })    存檔後，在 vscode terminal 視窗中會顯示：\n Connection has been established successfully. Backend server is running on port 5000  表示連結成功。\n 專案目錄 接下來要陸續完成相關程式，為使程式架構更顯清晰，專案目錄規劃如下：\n./專案目錄 ├── app/ # 程式目錄 │ ├── config/ # 設置連結 MySQL 資料庫的參數 │ ├── middleware/ │ ├── models/ │ ├── routes/ │ └── services/ # 業務邏輯 ├── node_modules/ ├── .env # 程式中的相關“設定值” ├── .gitignore ├── package.json ├── README.md ├── server.js # 主程式 └── yarn.loc 彈性管理參數值 管理程式中的“資料庫連結設定值” 在 app/config/目錄中新增一支 db.config.js 程式內容如下：\nmodule.exports = { HOST: \"localhost\", // Host Name  USER: \"mysql\", // User Name  PASSWORD: \"12345\", // Password  DB: \"testdb\", // Database Name  dialect: \"mysql\", // 資料庫類別  pool: { max: 5, //　連結池中最大的 connection 數  min: 0, acquire: 30000, //　連結 Timeout 時間(毫秒)  idle: 10000 //　連結被釋放的 idle 時間(毫秒)  } }; 管理程式中的“設定值” 使用 dotenv 套件的功能來管理程式中相關的設定值\n 首先在專案根目錄下建立一個名為 “.env” 的檔案，內容如下：  JWT_SEC=Jason-Web-Token-Secret-key-jaslkdjfhjwkej01kd1954  在程式中先匯入 dotenv 套件(第1行），再“啟動它”(第2行），使用時透過 “process.env.JWT_SEC” 語法取得 JWT_SEC 的設定值 第四行程式碼中的 process.env.PORT 為相同的原則可在 .evn 檔案中加入 PORT 的設定值調整  const dotenv = require(\"dotenv\"); dotenv.config(); // ... const PORT = process.env.PORT || 5000; // port 預設為 5000 ，並可以在 .env 檔案中進行客製化 （如：PORT＝5001） app.listen(PORT, () = { console.log(`Backend server is running on port ${PORT}`); }) 定義 Sequelize 模型 在 app/models/目錄中新增一支 user.model.js 程式內容如下，這個設定資料可搭合 sequelize.sync() 功能自動在 MySQL 資料庫中建立一個名為 users 的資料表(table)，共有三個皆為 string 型態的欄位，分別為 username、email、password。\nmodule.exports = (sequelize, Sequelize) = { const User = sequelize.define(\"users\", { username: { type: Sequelize.STRING }, email: { type: Sequelize.STRING }, password: { type: Sequelize.STRING } }); return User; }; 同時在 initial Sequelize 後，我們不需要編寫 CRUD 函數，Sequelize 支持所有這些函數\n 建立一個新的 user: create(object) 透過 id 找到一個　user: findByPk(id) 透過 email 找到一個　user: findOne({ where: { email: … } }) 取得所有使用者: findAll() 透過 username 找到符合的　user: findAll({ where: { username: … } })  在 app/models/目錄中新增一支 role.model.js 程式內容如下\nmodule.exports = (sequelize, Sequelize) = { const Role = sequelize.define(\"roles\", { id: { type: Sequelize.INTEGER, primaryKey: true }, name: { type: Sequelize.STRING } }); return Role; }; 在 app/models/目錄中新增一支 role.model.js 程式內容如下\nmodule.exports = (sequelize, Sequelize) = { const Role = sequelize.define(\"roles\", { id: { type: Sequelize.INTEGER, primaryKey: true }, name: { type: Sequelize.STRING } }); return Role; }; 初始化 Sequelize 在 app/models/目錄中新增一支 index.js 程式內容如下\nconst config = require(\"../config/db.config.js\"); // 引入資料庫連結設定檔 const Sequelize = require(\"sequelize\"); const sequelize = new Sequelize( // 由資料庫連結設定檔的設定值來備置 Sequelize  config.DB, config.USER, config.PASSWORD, { host: config.HOST, dialect: config.dialect, operatorsAliases: 0, pool: { max: config.pool.max, min: config.pool.min, acquire: config.pool.acquire, idle: config.pool.idle } } ); const db = {}; db.Sequelize = Sequelize; db.sequelize = sequelize; db.user = require(\"../models/user.model.js\")(sequelize, Sequelize); db.role = require(\"../models/role.model.js\")(sequelize, Sequelize); // 設定兩資料表的對應關係（多對多，所以會多出一個新的表 user_roles） // 一個使用者可能有多個角色 // 一個角色也可能有多個使用者 db.role.belongsToMany(db.user, { through: \"user_roles\", foreignKey: \"roleId\", otherKey: \"userId\" }); db.user.belongsToMany(db.role, { through: \"user_roles\", foreignKey: \"userId\", otherKey: \"roleId\" }); db.ROLES = [\"user\", \"admin\"]; module.exports = db; 執行程式産生資料表與資料 在 server.js 主程式中加入以下程式 const db = require(\"./app/models\"); // 引入 app/models/index.js 匯出的程式碼(即 sequelize model 定義檔) const Role = db.role; // 呼叫 sync function 將會依 model 定義內容産生資料表，force 參數值為 true 將會重建已存在的資料表 db.sequelize.sync({ force: true }).then(() = { console.log('Drop and Resync Database with { force: true }'); initial(); // 産生資料表後，呼叫 initial function 為 roles table 新增二筆初始資料 }).catch((err) = { console.log(err); }); const PORT = process.env.PORT || 5000; // port 預設為 5000 ，並可以在 .env 檔案中進行客製化 （如：PORT＝5001） app.listen(PORT, () = { console.log(`Backend server is running on port ${PORT}`); }) // 為 roles table 新增二筆初始資料 function initial() { Role.create({ id: 1, name: \"user\" }); Role.create({ id: 2, name: \"admin\" }); } 執行程式産生資料表 程式執行成功後可以查看資料庫已順利産生四個資料表以及 roles table 中的二筆初始資料\n了解 Node.js 路由 建立 user.routes.js router file 新增 routes 目錄，在此目錄下新增 user.routes.js 檔案\n routes/user.routes.js\n const router = require(\"express\").Router(); router.get(\"/usertest\", (req, res) = { res.send(\"user test is successful\"); }); module.exports = router; 在 server.js 程式中先匯入 “./app/routes/user.routes” 這個 router 設定檔，再透過 app.use 語法來使用這個 router(第9行)。\n1 2 3 4 5 6 7 8 9 10 11 12 13  const express = require(\"express\"); const app = express(); const dotenv = require(\"dotenv\"); const userRoute = require(\"./app/routes/user.routes\");  dotenv.config(); app.use(\"/api/users\", userRoute);  app.listen(process.env.PORT || 5000, ()={ console.log(\"Backend server is running...\"); });   開啟瀏覧器，輸入 http:5000/api/users/usertest，瀏覧器將呈現成功訊息\nuser test is successfull! 為 routes/user.routes.js 再新增一個 post method\n1 2 3 4 5 6 7 8 9 10 11  const router = require(\"express\").Router(); router.get(\"/usertest\", (req, res) = { res.send(\"user test is successful\"); }); router.post(\"/userposttest\", (req, res) = { const username = req.body.username; res.send(\"your username is: \" + username) });  module.exports = router;   使用 postman 來測試 post，結果回傳的是 Server Error，原因是 express 預設是不接受 json 格式的資料。\n在 server.js 程式中加入如第一行的設定\n1 2  app.use(express.json()); app.use(\"/api/users\", userRoute);   設定完成後就可正常了\n建立 auth.routes.js router file 將使用者資料註冊和資用者帳號驗證的機制獨立在這個 route file 中，讓程式結構更清晰。內容如下：\n1 2 3 4 5 6 7 8 9 10  // routes/auth.routes.js const router = require(\"express\").Router(); const authService = require(\"../services/auth.service\");  // 帳號註冊 router.post(\"/signup\", authService.signup); // 登入 router.post(\"/signin\", authService.signin);  module.exports = router;    在 auth.routes.js route 程式中基於｀關注點分離原則｀把｀商業邏輯｀的部份再分離至 services 中。\n  在 ./app 目錄下新增 services 子目錄，並新增一支 auth.service.js 程式，將使用者註冊及登入邏輯放在這支 service 程式中，內容如下：\n  在這支程式中會使用到額外的套件，必須先進行安裝。$ yarn add crypto-js jsonwebtoken。其中 crypto-js 用來進行使用者密碼加解密(程式第2、15、50、51行)，而 jsonwebtoken 套件則是支援 Json Web Token 功能(程式第55行使用 jwt.sign 産生合法 Token)。\n // auth.service.js const db = require(\"../models\"); const CryptoJS = require(\"crypto-js\"); const jwt = require(\"jsonwebtoken\"); const User = db.user; const Role = db.role; const Op = db.Sequelize.Op; const signup = (req, res) = { // Save User to Database User.create({ username: req.body.username, email: req.body.email, password: CryptoJS.AES.encrypt(req.body.password, process.env.PASS_SEC).toString()， }).then(user = { if (req.body.roles) { Role.findAll({ where: { name: { [Op.or]: req.body.roles } } }).then(roles = { user.setRoles(roles).then(() = { res.send({ message: \"User registered successfully!\" }); }); }); } else { // user role = 1 user.setRoles([1]).then(() = { res.send({ message: \"User registered successfully!\" }); }); } }).catch(err = { res.status(500).send({ message: err.message }); }); }; const signin = (req, res) = { User.findOne({ where: { username: req.body.username } }).then(user = { if (!user) { return res.status(404).send({ message: \"Wrong Credentials.\" }); } const hashedPassword = CryptoJS.AES.decrypt(user.password, process.env.PASS_SEC); const orginalPassword = hashedPassword.toString(CryptoJS.enc.Utf8); orginalPassword !== req.body.password \u0026\u0026 res.status(401).json(\"Wrong Credentials\"); const accessToken = jwt.sign( {id: user.id}, process.env.JWT_SEC, { expiresIn: \"3d\" } ); var authorities = []; user.getRoles().then(roles = { for (let i = 0; i { res.status(500).send({ message: err.message }); }); }; module.exports = { signup, signin };  在 server.js 引用這個新的 router\n 1 2 3 4 5 6 7 8 9 10 11 12  // ... const userRoute = require(\"./app/routes/user.routes\"); const authRoute = require(\"./app/routes/auth.routes\"); app.use(express.json()); app.use(\"/api/users\", userRoute); app.use(\"/api/auth\", authRoute);  const PORT = process.env.PORT || 5000; // port 預設為 5000 ，並可以在 .env 檔案中進行客製化 （如：PORT＝5001） app.listen(PORT, () = { console.log(`Backend server is running on port ${PORT}`); })   測試使用者註冊及登入功能 使用 postman 進行使用者註冊功能測試\n 註冊成功後，在資料庫中已新增一筆使用者資料\n 使用 postman 進行使用者登入功能測試\n 登入成功後會回傳一個 Token\n 在 Node.js 中使用 JWT 來進行 Token-Based 的使用者授權驗證 使用 jsonwebtoken套件可以實現 Token-base 的身份驗證與授權讓我們的 API 程式更安全\nJWT 實作的過程大致可以分成三個部分:\n 在登入成功後産生合法的 JWT Token 每次收到 request 時驗證是否為合法有效的 JWT Token 在特定 API Endpoint 上驗證是否帶有 “合法有效的 JWT Token”，以達到權限管理的需求  産生合法 JWT 在登入證驗中加入産生 Token 的邏輯，在檢核使用者輸入的密碼正確後，將 User ID (_id這個內部 Key)這個屬性值透過 sign function 來産生 access token，並回傳給前端。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  const jwt = require(\"jsonwebtoken\"); // 匯入 JsonWebToken套件 //...  const accessToken = jwt.sign({  id: user._id }, process.env.JWT_SEC,  { expiresIn: \"3d\" } ); var authorities = []; user.getRoles().then(roles = { for (let i = 0; i  roles.length; i++) { authorities.push(roles[i].name.toUpperCase()); } res.status(200).send({ id: user.id, username: user.username, email: user.email, roles: authorities, accessToken: accessToken }); });   encrypt function 參數除了要加密的字串外，需要一個加密 Key，為彈性起見，把它寫在 .env 檔案\n1 2  # .env JWT_SEC=Jason-Web-Token-Secret-key-thisisaprivatekey   使用 JWT 來驗證 Token 在前端取得合法的 JWT Token後，來看看當使用者在呼叫其他 API 時一併回傳的 Token　如何在 server 端來進行驗證。\n首先，我們要在 app/ 目錄下新增一個 middleware/ 的子目錄，並在其中新增一個名為 auth.jwt.js 的 express Middleware，程式內容如下\n在程式第14行中使用 jsonwebtoken 套件的 verify function 就是用來驗證 request 中的 Token 是否為合法 Token。驗證時一樣需要｀加密 Key｀來當參數。\n在這程式中除了驗證 request 中是否有合法的 Token 外，還有其他授權檢核的邏輯：驗證是否為管理者、驗證是否為版主、驗證是否為管理者或是版主等。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  const jwt = require(\"jsonwebtoken\"); const db = require(\"../models\"); const User = db.user; const verifyToken = (req, res, next) = {  let authHeader = req.headers.authorization; if (!authHeader) { return res.status(403).send({ message: \"Your are not authenticated!\" }); } const token = authHeader.split(\" \")[1]; jwt.verify(token, process.env.JWT_SEC, (err, decoded) = {  if (err) { return res.status(401).send({ message: \"Token is not valid!\" }); } req.userId = decoded.id; next(); }); }; const isAdmin = (req, res, next) = {  User.findByPk(req.userId).then(user = { user.getRoles().then(roles = { for (let i = 0; i  roles.length; i++) { if (roles[i].name === \"admin\") { next(); return; } } res.status(403).send({ message: \"Require Admin Role!\" }); return; }); }); }; const authJwt = {  verifyToken: verifyToken, isAdmin: isAdmin }; module.exports = authJwt;   為簡化 middleware 使用時的匯入路徑，我們在　middleware/ 的子目錄，再新增一個名為 index.js 的程式，內容如下\nconst authJwt = require(\"./auth.jwt\"); module.exports = { authJwt }; 在特定 API Endpoint 上驗證是否帶有 “合法有效的 JWT Token” 在前面完成了驗證 Token 的 Middleware 後，我們來看看如何在 router 中套用這些 middleware， 打開　routers/userroutes.js 程式檔，並將內容修改如下：\n在程式第九行 post 的第二個參數，加入呼叫 authJwt.verifyToken 這個 middleware 驗證 token 的 function。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const router = require(\"express\").Router(); const { authJwt } = require(\"../middleware\");  router.get(\"/usertest\", (req, res) = { res.send(\"user test is successful\"); }); router.post(\"/userposttest\", authJwt.verifyToken,  (req, res) = { const username = req.body.username; res.send(\"your username is: \" + username) } ) module.exports = router;   再次執行前面已執行過的 Postman 的 postusertest 這個 request，結果這次會回傳 ｀未授權｀的警告訊息。\n將登入成功時回傳的 token，加入到 Header 中，再執行一次 postusertest 即可執行成功。\n 若送出 request 中未包含 Token 則會回傳“未被授權執行本功能”。\n  若送出 request 中包含的是不合法的 Token 則會回傳“Token不合法“。\n 完成 todo list 相關功能 定義 todo 資料模型 在 app/models/目錄中新增一支 todo.model.js 程式內容如下\nmodule.exports = (sequelize, Sequelize) = { const Todo = sequelize.define(\"todo\", { title: { type: Sequelize.STRING }, description: { type: Sequelize.STRING }, status: { type: Sequelize.BOOLEAN } }); return Todo; }; 修改 app/models/index.js app/models/index.js 中加入 db.todo = require(\"../models/todo.model\")(sequelize, Sequelize);\nconst config = require(\"../config/db.config\"); const Sequelize = require(\"sequelize\"); const sequelize = new Sequelize( config.DB, config.USER, config.PASSWORD, { host: config.HOST, dialect: config.dialect, operatorsAliases: 0, pool: { max: config.pool.max, min: config.pool.min, acquire: config.pool.acquire, idle: config.pool.idle } } ); const db = {}; db.Sequelize = Sequelize; db.sequelize = sequelize; db.user = require(\"../models/user.model\")(sequelize, Sequelize); db.role = require(\"../models/role.model\")(sequelize, Sequelize); db.todo = require(\"../models/todo.model\")(sequelize, Sequelize); db.role.belongsToMany(db.user, { through: \"user_roles\", foreignKey: \"roleId\", otherKey: \"userId\" }); db.user.belongsToMany(db.role, { through: \"user_roles\", foreignKey: \"userId\", otherKey: \"roleId\" }); db.ROLES = [\"user\", \"admin\"]; module.exports = db; 新增 todo.service.js 將實際讀寫資料的動作寫在 service 中。\n//./app/services.todo.service.js const db = require(\"../models\"); const Todo = db.todo; const Op = db.Sequelize.Op; const create = (req, res) = { if (!req.body.title) { res.status(400).send({ message: \"內容不得為空白！\" }); return; } // 新增一個 Todo  const todo = { title: req.body.title, description: req.body.description, status: req.body.status ? req.body.status : false } // 將 todo 存入資料庫  Todo.create(todo) .then(data = { res.send(data); }).catch(err = { res.status(500).send({ message: err.message || \"資料存檔時發生錯誤！\" }); }); } const findAll = (req, res) = { const title = req.query.title; let condition = title ? { title: { [Op.like]: `%${title}%` } } : null; Todo.findAll({ where: condition }) .then(data = { res.send(data); }) .catch(err = { res.status(500).send({ message: err.message || \"由資料庫讀取 Todo 資料時發生錯誤！\" }); }); }; const findOne = (req, res) = { const id = req.params.id; Todo.findByPk(id) .then(data = { if (data) { res.send(data) } else { res.status(400).send({ message: `使用id=${id}搜尋時找到不 Todo 資料!` }) } }) .catch(err = { res.status(500).send({ message: `使用id=${id}搜尋時找到不 Todo 資料!` }); }); }; const update = (req, res) = { const id = req.params.id; Todo.update(req.body, { where: { id: id } }) .then(num = { if (num == 1) { res.send({ mdssage: \"Todo 更新完成！\" }); } else { res.status(500).send({ message: `使用 id= ${id}更新資料時發生錯誤！` }); }; }) }; const deleteOne = (req, res) = { const id = req.params.id; Todo.destroy({ where: { id: id } }) .then(num = { if (num === 1) { res.send({ message: \"Todo 刪除成功！\" }) } else { res.send({ message: `使用 id= ${id}刪除 Todo 時未找到任何資料！` }) }; }) .catch(err = { res.status(500).send({ message: `使用 id= ${id}刪除 Todo 時發生錯誤！` }) }) }; const deleteAll = (req, res) = { Todo.destroy({ where: {}, truncat: false }) .then(nums = { res.send({ message: `${nums}Todo 資料被刪除成功！` }) }) .catch(err = { res.status(500).send({ message: err.message || \"刪除所有資料時發生錯誤！\" }) }) }; const findAllDoneTodos = (req, res) = { Todo.findAll({ where: { status: true } }) .then(data = { res.send(data); }) .catch(err = { res.status(500).send({ message: err.message || \"讀取資料時發生錯誤！\" }) }) }; module.exports = { create, findAll, findOne, update, deleteAll, deleteOne, findAllDoneTodos }; 新增 todo.router.js // ./app/routers/todo.routes.js const router = require(\"express\").Router(); const todo = require(\"../services/todo.service\"); router.post(\"/\", todo.create); router.get(\"/\", todo.findAll); router.get(\"/done\", todo.findAllDoneTodos); router.get(\"/:id\", todo.findOne); router.put(\"/:id\", todo.update); router.delete(\"/:id\", todo.deleteOne); router.delete(\"/\", todo.deleteAll); module.exports = router; 將 todo router 加入到 service.js //... app.use(express.json()); const userRoute = require(\"./app/routes/user.routes\"); app.use(\"/api/users\", userRoute); const todoRoute = require(\"./app/routes/todo.routes\"); app.use(\"/api/todos\", todoRoute); const authRoute = require(\"./app/routes/auth.routes\"); app.use(\"/api/auth\", authRoute); const PORT = process.env.PORT || 5000; app.listen(PORT, () = { console.log(`Backend server is running on port ${PORT}`); }); //... 執行測試 新增一筆 Todo 找出所有的 Todos 找出 title 中有含某個 keyword 的所有 Todos 以 ID 找出 Todo 更新某一個 Todo 的 status 欄位 查詢所有已經完成的 Todos 刪除某一個 Todo 刪除所有的 Todos 使用 middleware 來進行檢核使用者角色 將 app/routes/todo.routes.js 內容修改成如下：\n 第五行：create 功能加入 authJwt.verifyToken middleware 檢核，必須是已登入的使用者才能執行 第六行：findall 功能加入 authJwt.verifyToken 以及 authJwt.isAdmin middleware 檢核，必須是已登入的使用者且具有管理者身份才能執行  1 2 3 4 5 6 7 8 9 10 11 12 13  const router = require(\"express\").Router(); const todo = require(\"../services/todo.service\"); const { authJwt } = require(\"../middleware\"); router.post(\"/\", authJwt.verifyToken, todo.create); router.get(\"/\", [authJwt.verifyToken, authJwt.isAdmin], todo.findAll); router.get(\"/done\", todo.findAllDoneTodos); router.get(\"/:id\", todo.findOne); router.put(\"/:id\", todo.update); router.delete(\"/:id\", todo.deleteOne); router.delete(\"/\", todo.deleteAll); module.exports = router;   再次執行 create Todo API endpoint，發現未登入的使用者已無法執行。\n以一般使用者進行登入\n打開 Postman 先使用已註冊的使用者帳號登入，取得 token\n再將這個 token (使表使用者是 tom) 加入 request authorization header 中，再次造再次執行 create Todo API endpoint，結果可正常新建一個 Todo\n再以相同 token (代表使用者是 tom) 造訪 get All Todos API endpoint ，結果回傳 “須為管理者角色者\"才能造訪。\n註冊一個新使用者且具備有 admin 角色\n改用新註冊的使用者 Jeff 來重新登入，並取得回傳的 token\n改採此 token (代表使用者是 jeff) 再次造訪 get All Todos API endpoint ，結果顯示可正常顯示所有的 Todos。\n使用 middleware 來進行其他資料檢核 程式至此已經可以透過 JWT 相關功能查核使用者是否已正確登入系統、是以何種身份（角色）登入的。\n最後要再呈現的是使用 middleware 功能來查核其他資料正確性，如：使用者註冊時是否使用了相同的使用者名稱？是否 email 已經被其他使用者使用過？\n在 app/middleware 目錄下新增 verify.signup.js，內容如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57  const db = require(\"../models\"); const ROLES = db.Roles; const User = db.user; checkDuplicateUsernameOrEmail = (req, res, next) = {  // Username  User.findOne({ where: { username: req.body.username } }).then(user = { if (user) { res.status(400).send({ message: \"Failed! Username is already in use!\" }); return; } // Email  User.findOne({ where: { email: req.body.email } }).then(user = { if (user) { res.status(400).send({ message: \"Failed! Email is already in use!\" }); return; } next(); }); }); }; checkRolesExisted = (req, res, next) = {  if (req.body.roles) { for (let i = 0; i  req.body.roles.length; i++) { if (!ROLES.includes(req.body.roles[i])) { res.status(400).send({ message: \"Failed! Role does not exist = \" + req.body.roles[i] }); return; } } } next(); }; const verifySignUp = { checkDuplicateUsernameOrEmail: checkDuplicateUsernameOrEmail, checkRolesExisted: checkRolesExisted }; module.exports = verifySignUp;   修改 app/middleware/index.js 檔案如下：\n1 2 3 4 5 6 7  const authJwt = require(\"./auth.jwt\"); const verifySignUp = require(\"./verify.signup\");  module.exports = { authJwt, verifySignUp };   將新的 middleware　功能放入到 SignUp 功能中。 打開　app/routes/auth.routes.js 程式檔，修改如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const router = require(\"express\").Router(); const authService = require(\"../services/auth.service\"); const { verifySignUp } = require(\"../middleware\") // 帳號註冊 router.post(\"/signup\", [ verifySignUp.checkDuplicateUsernameOrEmail, verifySignUp.checkRolesExisted ], authService.signup); // 登入 router.post(\"/signin\", authService.signin); module.exports = router;   先使用已經被註冊過的 EMail來進行測試，結果回傳 EMail 已被使用。\n再使用已被註冊過的 UserName 來進行註冊，結果回傳：\ncors 這個後端專案預計要給前端 Angular 來使用，跨域存取問題就用 cors 設定來解決。\n先安裝 cors 套件\n$ yarn add cors yarn add v1.22.19 [1/4] Resolving packages... [2/4] Fetching packages... [3/4] Linking dependencies... [4/4] Building fresh packages... success Saved lockfile. success Saved 2 new dependencies. info Direct dependencies └─ cors@2.8.5 info All dependencies ├─ cors@2.8.5 └─ object-assign@4.1.1 Done in 0.86s. 打開 server.js，修改如下：\n1 2 3 4 5 6 7 8 9 10 11  const express = require(\"express\"); const dotenv = require(\"dotenv\"); const cors = require(\"cors\"); dotenv.config(); const app = express(); const corsOptions = { origin: \"http://localhost:4200\" }; app.use(cors(corsOptions)); //...   ","wordCount":"3204","inLanguage":"en","datePublished":"2022-07-04T00:00:00Z","dateModified":"2022-07-04T00:00:00Z","author":{"@type":"Person","name":"Theme PaperMod"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://calvinegs.github.io/posts/nodejs-restapi-mysql/"},"publisher":{"@type":"Organization","name":"永誌不忘 • 筆記簿","logo":{"@type":"ImageObject","url":"https://calvinegs.github.io/img/favicon.png"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://calvinegs.github.io/ accesskey=h title="永誌不忘 • 筆記簿 (Alt + H)">永誌不忘 • 筆記簿</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://calvinegs.github.io/posts/ title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://calvinegs.github.io/archives/ title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://calvinegs.github.io/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://calvinegs.github.io/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://calvinegs.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://calvinegs.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://calvinegs.github.io/posts/>Posts</a></div>
<h1 class=post-title>
使用 Node.js + express + MySQL 建立一個後端服務 REST API
</h1>
<div class=post-description>
Node.js + express 來建立 REST API 服務，同時為提高網路安全性採取了 JWT JSON Web Token）來實作使用者驗證機制。資料庫的部份是使用 MySQL，為方便起見，採用 Docker 來執行 MySQL。
</div>
<div class=post-meta><span title="2022-07-04 00:00:00 +0000 UTC">July 4, 2022</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;Theme PaperMod&nbsp;|&nbsp;<a href=https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/posts/nodejs-restapi-mysql.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#%e5%b0%88%e6%a1%88%e5%ae%8c%e6%88%90%e5%be%8c%e7%9a%84%e6%aa%94%e6%a1%88%e7%b5%90%e6%a7%8b aria-label=專案完成後的檔案結構>專案完成後的檔案結構</a></li>
<li>
<a href=#%e5%b0%88%e6%a1%88%e5%ae%8c%e6%88%90%e5%be%8c%e6%89%80%e6%8f%90%e4%be%9b%e7%9a%84-api-%e7%ab%af%e9%bb%9e aria-label="專案完成後所提供的 API 端點">專案完成後所提供的 API 端點</a></li>
<li>
<a href=#%e8%a8%ad%e7%bd%ae%e5%b0%88%e6%a1%88%e7%92%b0%e5%a2%83 aria-label=設置專案環境>設置專案環境</a><ul>
<li>
<a href=#%e5%ae%89%e8%a3%9d%e7%9b%b8%e4%be%9d%e5%a5%97%e4%bb%b6 aria-label=安裝相依套件>安裝相依套件</a></li></ul>
</li>
<li>
<a href=#%e5%bb%ba%e7%ab%8b%e4%b8%80%e5%80%8b-express-%e6%87%89%e7%94%a8%e7%a8%8b%e5%bc%8f aria-label="建立一個 Express 應用程式">建立一個 Express 應用程式</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-nodejs-%e9%80%a3%e7%b5%90-mysql aria-label="使用 Node.js 連結 MySQL">使用 Node.js 連結 MySQL</a></li>
<li>
<a href=#%e5%b0%88%e6%a1%88%e7%9b%ae%e9%8c%84 aria-label=專案目錄>專案目錄</a></li>
<li>
<a href=#%e5%bd%88%e6%80%a7%e7%ae%a1%e7%90%86%e5%8f%83%e6%95%b8%e5%80%bc aria-label=彈性管理參數值>彈性管理參數值</a><ul>
<li>
<a href=#%e7%ae%a1%e7%90%86%e7%a8%8b%e5%bc%8f%e4%b8%ad%e7%9a%84%e8%b3%87%e6%96%99%e5%ba%ab%e9%80%a3%e7%b5%90%e8%a8%ad%e5%ae%9a%e5%80%bc aria-label=管理程式中的“資料庫連結設定值”>管理程式中的“資料庫連結設定值”</a></li>
<li>
<a href=#%e7%ae%a1%e7%90%86%e7%a8%8b%e5%bc%8f%e4%b8%ad%e7%9a%84%e8%a8%ad%e5%ae%9a%e5%80%bc aria-label=管理程式中的“設定值”>管理程式中的“設定值”</a></li></ul>
</li>
<li>
<a href=#%e5%ae%9a%e7%be%a9-sequelize-%e6%a8%a1%e5%9e%8b aria-label="定義 Sequelize 模型">定義 Sequelize 模型</a></li>
<li>
<a href=#%e5%88%9d%e5%a7%8b%e5%8c%96-sequelize aria-label="初始化 Sequelize">初始化 Sequelize</a></li>
<li>
<a href=#%e5%9f%b7%e8%a1%8c%e7%a8%8b%e5%bc%8f%e7%94%a3%e7%94%9f%e8%b3%87%e6%96%99%e8%a1%a8%e8%88%87%e8%b3%87%e6%96%99 aria-label=執行程式産生資料表與資料>執行程式産生資料表與資料</a><ul>
<li>
<a href=#%e5%9c%a8-serverjs-%e4%b8%bb%e7%a8%8b%e5%bc%8f%e4%b8%ad%e5%8a%a0%e5%85%a5%e4%bb%a5%e4%b8%8b%e7%a8%8b%e5%bc%8f aria-label="在 server.js 主程式中加入以下程式">在 server.js 主程式中加入以下程式</a></li>
<li>
<a href=#%e5%9f%b7%e8%a1%8c%e7%a8%8b%e5%bc%8f%e7%94%a3%e7%94%9f%e8%b3%87%e6%96%99%e8%a1%a8 aria-label=執行程式産生資料表>執行程式産生資料表</a></li></ul>
</li>
<li>
<a href=#%e4%ba%86%e8%a7%a3-nodejs-%e8%b7%af%e7%94%b1 aria-label="了解 Node.js 路由">了解 Node.js 路由</a><ul>
<li>
<a href=#%e5%bb%ba%e7%ab%8b-userroutesjs-router-file aria-label="建立 user.routes.js router file">建立 user.routes.js router file</a></li>
<li>
<a href=#%e5%bb%ba%e7%ab%8b-authroutesjs-router-file aria-label="建立 auth.routes.js router file">建立 auth.routes.js router file</a></li>
<li>
<a href=#%e6%b8%ac%e8%a9%a6%e4%bd%bf%e7%94%a8%e8%80%85%e8%a8%bb%e5%86%8a%e5%8f%8a%e7%99%bb%e5%85%a5%e5%8a%9f%e8%83%bd aria-label=測試使用者註冊及登入功能>測試使用者註冊及登入功能</a></li></ul>
</li>
<li>
<a href=#%e5%9c%a8-nodejs-%e4%b8%ad%e4%bd%bf%e7%94%a8-jwt-%e4%be%86%e9%80%b2%e8%a1%8c-token-based-%e7%9a%84%e4%bd%bf%e7%94%a8%e8%80%85%e6%8e%88%e6%ac%8a%e9%a9%97%e8%ad%89 aria-label="在 Node.js 中使用 JWT 來進行 Token-Based 的使用者授權驗證">在 Node.js 中使用 JWT 來進行 Token-Based 的使用者授權驗證</a><ul>
<li>
<a href=#%e7%94%a3%e7%94%9f%e5%90%88%e6%b3%95-jwt aria-label="産生合法 JWT">産生合法 JWT</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-jwt-%e4%be%86%e9%a9%97%e8%ad%89-token aria-label="使用 JWT 來驗證 Token">使用 JWT 來驗證 Token</a></li>
<li>
<a href=#%e5%9c%a8%e7%89%b9%e5%ae%9a-api-endpoint-%e4%b8%8a%e9%a9%97%e8%ad%89%e6%98%af%e5%90%a6%e5%b8%b6%e6%9c%89-%e5%90%88%e6%b3%95%e6%9c%89%e6%95%88%e7%9a%84-jwt-token aria-label="在特定 API Endpoint 上驗證是否帶有 “合法有效的 JWT Token”">在特定 API Endpoint 上驗證是否帶有 “合法有效的 JWT Token”</a></li></ul>
</li>
<li>
<a href=#%e5%ae%8c%e6%88%90-todo-list-%e7%9b%b8%e9%97%9c%e5%8a%9f%e8%83%bd aria-label="完成 todo list 相關功能">完成 todo list 相關功能</a><ul>
<li>
<a href=#%e5%ae%9a%e7%be%a9-todo-%e8%b3%87%e6%96%99%e6%a8%a1%e5%9e%8b aria-label="定義 todo 資料模型">定義 todo 資料模型</a></li>
<li>
<a href=#%e4%bf%ae%e6%94%b9-appmodelsindexjs aria-label="修改 app/models/index.js">修改 app/models/index.js</a></li>
<li>
<a href=#%e6%96%b0%e5%a2%9e-todoservicejs aria-label="新增 todo.service.js">新增 todo.service.js</a></li>
<li>
<a href=#%e6%96%b0%e5%a2%9e-todorouterjs aria-label="新增 todo.router.js">新增 todo.router.js</a></li>
<li>
<a href=#%e5%b0%87-todo-router-%e5%8a%a0%e5%85%a5%e5%88%b0-servicejs aria-label="將 todo router 加入到 service.js">將 todo router 加入到 service.js</a></li>
<li>
<a href=#%e5%9f%b7%e8%a1%8c%e6%b8%ac%e8%a9%a6 aria-label=執行測試>執行測試</a></li></ul>
</li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-middleware-%e4%be%86%e9%80%b2%e8%a1%8c%e6%aa%a2%e6%a0%b8%e4%bd%bf%e7%94%a8%e8%80%85%e8%a7%92%e8%89%b2 aria-label="使用 middleware 來進行檢核使用者角色">使用 middleware 來進行檢核使用者角色</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-middleware-%e4%be%86%e9%80%b2%e8%a1%8c%e5%85%b6%e4%bb%96%e8%b3%87%e6%96%99%e6%aa%a2%e6%a0%b8 aria-label="使用 middleware 來進行其他資料檢核">使用 middleware 來進行其他資料檢核</a></li>
<li>
<a href=#cors aria-label=cors>cors</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p><em><a href=https://github.com/calvinegs/nodejs-webapi-jwt-mysql.git>github Source code</a></em></p>
<p>Technology:</p>
<ul>
<li>NodeJs 17.6.0</li>
<li>Express 4.18.1</li>
<li>cors 2.8.5</li>
<li>crypto-js 4.1.1 # 加解密套件</li>
<li>jsonwebtoken 8.5.1 # Json Web Token 的功能套件</li>
<li>sequelize 6.20.2 # ORM 套件</li>
<li>mysql2 2.3.3 # MySQL client for Node.js</li>
<li>MySQL 8.0 # 使用的資料庫</li>
</ul>
<h2 id=專案完成後的檔案結構>專案完成後的檔案結構<a hidden class=anchor aria-hidden=true href=#專案完成後的檔案結構>#</a></h2>
<pre tabindex=0><code>./專案目錄
├── app/
│   ├── config/
│   │   └── db.config.js
│   ├── middleware/
│   │   ├── auth.jwt.js
│   │   ├── index.js
│   │   └── verify.signup.js
│   ├── models/
│   │   ├── index.js
│   │   ├── role.model.js
│   │   ├── todo.model.js
│   │   └── user.model.js
│   ├── routes/
│   │   ├── auth.routes.js
│   │   ├── todo.routes.js
│   │   └── user.routes.js
│   └── services/
│       ├── auth.service.js
│       ├── todo.service.js
│       └── user.service.js
├── node_modules/
├── .env
├── .gitignore
├── package.json
├── README.md
├── server.js
└── yarn-lock
</code></pre><h2 id=專案完成後所提供的-api-端點>專案完成後所提供的 API 端點<a hidden class=anchor aria-hidden=true href=#專案完成後所提供的-api-端點>#</a></h2>
<table>
<thead>
<tr>
<th>Methods</th>
<th>Urls</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/api/auth/signup</td>
<td>註冊新使用者帳號</td>
</tr>
<tr>
<td>POST</td>
<td>/api/auth/signin</td>
<td>使用者帳號登入</td>
</tr>
<tr>
<td>GET</td>
<td>/api/todos</td>
<td>get all Todos</td>
</tr>
<tr>
<td>GET</td>
<td>/api/todos/:id</td>
<td>get Todo by id</td>
</tr>
<tr>
<td>GET</td>
<td>/api/todos/done</td>
<td>find all done Todos</td>
</tr>
<tr>
<td>GET</td>
<td>/api/todos/title=[<code>keyword</code>]</td>
<td>find all Todos whick title contains <code>keyword</code></td>
</tr>
<tr>
<td>POST</td>
<td>/api/todos</td>
<td>add New Todo</td>
</tr>
<tr>
<td>PUT</td>
<td>/api/todos/:id</td>
<td>update Todo by id</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/todos/:id</td>
<td>remove Todo by id</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/todos</td>
<td>remove all Todos</td>
</tr>
</tbody>
</table>
<h2 id=設置專案環境>設置專案環境<a hidden class=anchor aria-hidden=true href=#設置專案環境>#</a></h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ node --version 	<span style=color:#75715e># 檢測環境已裝妥 node.js (若已安裝會顯示目前安裝的版本）</span>
v17.6.0

$ mkdir nodejs-webapi-jwt-mysql <span style=color:#f92672>&amp;&amp;</span> cd nodejs-webapi-jwt-mysql ＃ 建立一個專案目錄
$ npm init	＃ 産生一專案設定檔 package.json
$ touch server.js	＃ 産生一個新檔案
</code></pre></div><p>package.json 預設的內容</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;nodejs-webapi-jwt-mysql&#34;</span>,
  <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
  <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Node.js + express + JWT + MySQL&#34;</span>,
  <span style=color:#f92672>&#34;main&#34;</span>: <span style=color:#e6db74>&#34;server.js&#34;</span>,
  <span style=color:#f92672>&#34;scripts&#34;</span>: {
    <span style=color:#f92672>&#34;test&#34;</span>: <span style=color:#e6db74>&#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34;</span>
  },
  <span style=color:#f92672>&#34;keywords&#34;</span>: [
    <span style=color:#e6db74>&#34;node.js&#34;</span>,
    <span style=color:#e6db74>&#34;express&#34;</span>,
    <span style=color:#e6db74>&#34;jwt&#34;</span>,
    <span style=color:#e6db74>&#34;mysql&#34;</span>
  ],
  <span style=color:#f92672>&#34;author&#34;</span>: <span style=color:#e6db74>&#34;calvin&#34;</span>,
  <span style=color:#f92672>&#34;license&#34;</span>: <span style=color:#e6db74>&#34;ISC&#34;</span>
}
</code></pre></div><h3 id=安裝相依套件>安裝相依套件<a hidden class=anchor aria-hidden=true href=#安裝相依套件>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ yarn add express dotenv sequelize mysql2    <span style=color:#75715e># 加入相依套件</span>
$ yarn add --dev nodemon  <span style=color:#75715e># 加入開發時期相依套件</span>
$ yarn add crypto-js jsonwebtoken   <span style=color:#75715e># 使用者密碼加解密 / Json Web Token</span>
$ yarn add cors <span style=color:#75715e># 可跨網域提供 Webapi service</span>
</code></pre></div><p>建立 git 初始版本</p>
<pre tabindex=0><code>$ git init
$ echo 'node_modules/' &gt; .gitignore  # 新增 git ignore 設定檔，並設定 node_modules/ 目錄不加入版控
$ echo 'yarn.lock' &gt;&gt; .gitignore
$ git add . &amp;&amp; git commit -m &quot;Initial commit&quot; 建立 git 初始版本的資訊
</code></pre><p>開啟 VSCode</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ code .
</code></pre></div><p>設定專案啟動指令（如第七行的指令設定），當輸入 npm start 時系統自動以 node 來執行 server.js 程式，並即時監測 server.js 檔案有變化存檔時馬上重新啟動 node server.js 來執行該程式。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;nodejs-webapi-jwt-mysql&#34;</span>,
  <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
  <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Node.js + exporess + JWT + MySQL&#34;</span>,
  <span style=color:#f92672>&#34;main&#34;</span>: <span style=color:#e6db74>&#34;server.js&#34;</span>,
  <span style=color:#f92672>&#34;scripts&#34;</span>: {
<span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;nodemon server.js&#34;</span>
</span>  },
  <span style=color:#f92672>&#34;keywords&#34;</span>: [
    <span style=color:#e6db74>&#34;node.js&#34;</span>,
    <span style=color:#e6db74>&#34;express&#34;</span>,
    <span style=color:#e6db74>&#34;jwt&#34;</span>,
    <span style=color:#e6db74>&#34;mysql&#34;</span>
  ],
  <span style=color:#f92672>&#34;author&#34;</span>: <span style=color:#e6db74>&#34;calvin&#34;</span>,
  <span style=color:#f92672>&#34;license&#34;</span>: <span style=color:#e6db74>&#34;ISC&#34;</span>,
  <span style=color:#f92672>&#34;dependencies&#34;</span>: {
    <span style=color:#f92672>&#34;dotenv&#34;</span>: <span style=color:#e6db74>&#34;^16.0.1&#34;</span>,
    <span style=color:#f92672>&#34;express&#34;</span>: <span style=color:#e6db74>&#34;^4.18.1&#34;</span>,
    <span style=color:#f92672>&#34;pg&#34;</span>: <span style=color:#e6db74>&#34;^8.7.3&#34;</span>,
    <span style=color:#f92672>&#34;pg-hstore&#34;</span>: <span style=color:#e6db74>&#34;^2.3.4&#34;</span>,
    <span style=color:#f92672>&#34;sequelize&#34;</span>: <span style=color:#e6db74>&#34;^6.20.1&#34;</span>
  },
  <span style=color:#f92672>&#34;devDependencies&#34;</span>: {
    <span style=color:#f92672>&#34;nodemon&#34;</span>: <span style=color:#e6db74>&#34;^2.0.16&#34;</span>
  }
}
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>在 server.js 中加入此行程式，並在 vscode Terminal 中輸入 npm start</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Hi NodeJS...&#34;</span>)	
</code></pre></div><blockquote>
<p>顯示結果如下</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; nodejs-webapi-jwt-mysql@1.0.0 start
&gt; nodemon server.js

<span style=color:#f92672>[</span>nodemon<span style=color:#f92672>]</span> 2.0.18
<span style=color:#f92672>[</span>nodemon<span style=color:#f92672>]</span> to restart at any time, enter <span style=color:#e6db74>`</span>rs<span style=color:#e6db74>`</span>
<span style=color:#f92672>[</span>nodemon<span style=color:#f92672>]</span> watching path<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>: *.*
<span style=color:#f92672>[</span>nodemon<span style=color:#f92672>]</span> watching extensions: js,mjs,json
<span style=color:#f92672>[</span>nodemon<span style=color:#f92672>]</span> starting <span style=color:#e6db74>`</span>node server.js<span style=color:#e6db74>`</span>
Hi NodeJS...
<span style=color:#f92672>[</span>nodemon<span style=color:#f92672>]</span> clean exit - waiting <span style=color:#66d9ef>for</span> changes before restart
</code></pre></div><h2 id=建立一個-express-應用程式>建立一個 Express 應用程式<a hidden class=anchor aria-hidden=true href=#建立一個-express-應用程式>#</a></h2>
<blockquote>
<p>使用以下程式覆蓋 server.js 檔案</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span>  <span style=color:#a6e22e>express</span>();
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Hello World&#39;</span>)
  });
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/test&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
	<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;test is successful&#34;</span>);
    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;test is successful&#34;</span>);
});

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PORT</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>5000</span>;
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>PORT</span>, () =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Backend server is running on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
})
</code></pre></div><blockquote>
<p>存檔後，開啟 瀏覽器，輸入 localhost:5000/api/test，在 vscode terminal 視窗中會顯示：</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Backend server is running on port <span style=color:#ae81ff>5000</span>
test is successful
</code></pre></div><h2 id=使用-nodejs-連結-mysql>使用 Node.js 連結 MySQL<a hidden class=anchor aria-hidden=true href=#使用-nodejs-連結-mysql>#</a></h2>
<p>若你還沒有安裝 MySQL 可以參考這筆記先將資料庫管理系統備妥 <em><a href=https://calvinegs.github.io/posts/docker-mysql/>使用 Docker 執行 MySQL</a></em></p>
<p>在程式中使用了 sequelize 這個套件的功能來連結 mysql 資料庫，直接透過 Sequelize constructor 來給定連結資料庫的參數，包含 “資料庫名稱“、”User Id"、&ldquo;Password&rdquo;、“Host Name"、&ldquo;資料庫類別“(dialect)等。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>Sequelize</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;sequelize&#39;</span>);
</span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sequelize</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Sequelize</span>(<span style=color:#e6db74>&#39;testdb&#39;</span>, <span style=color:#e6db74>&#39;root&#39;</span>, <span style=color:#e6db74>&#39;mysql@12345&#39;</span>, {
    <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;localhost&#39;</span>,
    <span style=color:#a6e22e>dialect</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;mysql&#39;</span>
});
<span style=color:#66d9ef>try</span> {
  <span style=color:#a6e22e>sequelize</span>.<span style=color:#a6e22e>authenticate</span>();
  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Connection has been established successfully.&#39;</span>);
} <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Unable to connect to the database:&#39;</span>, <span style=color:#a6e22e>error</span>);
}

<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/test&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;test is successful&#34;</span>);
    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;test is successful&#34;</span>);
});

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PORT</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>5000</span>;
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>PORT</span>, () =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Backend server is running on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
})
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>存檔後，在 vscode terminal 視窗中會顯示：</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Connection has been established successfully.
Backend server is running on port <span style=color:#ae81ff>5000</span>
</code></pre></div><blockquote>
<p>表示連結成功。</p>
</blockquote>
<h2 id=專案目錄>專案目錄<a hidden class=anchor aria-hidden=true href=#專案目錄>#</a></h2>
<p>接下來要陸續完成相關程式，為使程式架構更顯清晰，專案目錄規劃如下：</p>
<pre tabindex=0><code>./專案目錄
├── app/  # 程式目錄
│   ├── config/  # 設置連結 MySQL 資料庫的參數
│   ├── middleware/  
│   ├── models/
│   ├── routes/
│   └── services/  # 業務邏輯
├── node_modules/
├── .env  # 程式中的相關“設定值”
├── .gitignore
├── package.json
├── README.md
├── server.js   # 主程式
└── yarn.loc
</code></pre><h2 id=彈性管理參數值>彈性管理參數值<a hidden class=anchor aria-hidden=true href=#彈性管理參數值>#</a></h2>
<h3 id=管理程式中的資料庫連結設定值>管理程式中的“資料庫連結設定值”<a hidden class=anchor aria-hidden=true href=#管理程式中的資料庫連結設定值>#</a></h3>
<p>在 app/config/目錄中新增一支 db.config.js 程式內容如下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
  <span style=color:#a6e22e>HOST</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;localhost&#34;</span>,    <span style=color:#75715e>// Host Name
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>USER</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;mysql&#34;</span>,     <span style=color:#75715e>// User Name
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>PASSWORD</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;12345&#34;</span>,    <span style=color:#75715e>// Password
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>DB</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;testdb&#34;</span>,         <span style=color:#75715e>// Database Name
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>dialect</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;mysql&#34;</span>,  <span style=color:#75715e>// 資料庫類別
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>pool</span><span style=color:#f92672>:</span> {
    <span style=color:#a6e22e>max</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span>,             <span style=color:#75715e>//　連結池中最大的 connection 數
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>min</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
    <span style=color:#a6e22e>acquire</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30000</span>,     <span style=color:#75715e>//　連結 Timeout 時間(毫秒)
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>idle</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10000</span>         <span style=color:#75715e>//　連結被釋放的 idle 時間(毫秒)
</span><span style=color:#75715e></span>  }
};
</code></pre></div><h3 id=管理程式中的設定值>管理程式中的“設定值”<a hidden class=anchor aria-hidden=true href=#管理程式中的設定值>#</a></h3>
<p>使用 dotenv 套件的功能來管理程式中相關的設定值</p>
<ul>
<li>首先在專案根目錄下建立一個名為 &ldquo;.env&rdquo; 的檔案，內容如下：</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#a6e22e>JWT_SEC</span><span style=color:#f92672>=</span><span style=color:#e6db74>Jason-Web-Token-Secret-key-jaslkdjfhjwkej01kd1954</span>
</code></pre></div><ul>
<li>在程式中先匯入 dotenv 套件(第1行），再“啟動它”(第2行），使用時透過 “process.env.JWT_SEC&rdquo; 語法取得 JWT_SEC 的設定值</li>
<li>第四行程式碼中的 process.env.PORT 為相同的原則可在 .evn 檔案中加入 PORT 的設定值調整</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dotenv</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;dotenv&#34;</span>);
<span style=color:#a6e22e>dotenv</span>.<span style=color:#a6e22e>config</span>();
<span style=color:#75715e>// ...
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PORT</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>5000</span>;  <span style=color:#75715e>// port 預設為 5000 ，並可以在 .env 檔案中進行客製化 （如：PORT＝5001）
</span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>PORT</span>, () =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Backend server is running on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
})
</code></pre></div><h2 id=定義-sequelize-模型>定義 Sequelize 模型<a hidden class=anchor aria-hidden=true href=#定義-sequelize-模型>#</a></h2>
<p>在 app/models/目錄中新增一支 user.model.js 程式內容如下，這個設定資料可搭合 sequelize.sync() 功能自動在 MySQL 資料庫中建立一個名為 users 的資料表(table)，共有三個皆為 string 型態的欄位，分別為 username、email、password。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>sequelize</span>, <span style=color:#a6e22e>Sequelize</span>) =&gt; {
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sequelize</span>.<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#34;users&#34;</span>, {
    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>STRING</span>
    },
    <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>STRING</span>
    },
    <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>STRING</span>
    }
  });
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>User</span>;
};
</code></pre></div><p>同時在 initial Sequelize 後，我們不需要編寫 CRUD 函數，Sequelize 支持所有這些函數</p>
<ul>
<li>建立一個新的 user: create(object)</li>
<li>透過 id 找到一個　user: findByPk(id)</li>
<li>透過 email 找到一個　user: findOne({ where: { email: &mldr; } })</li>
<li>取得所有使用者: findAll()</li>
<li>透過 username 找到符合的　user: findAll({ where: { username: &mldr; } })</li>
</ul>
<p>在 app/models/目錄中新增一支 role.model.js 程式內容如下</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>sequelize</span>, <span style=color:#a6e22e>Sequelize</span>) =&gt; {
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Role</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sequelize</span>.<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#34;roles&#34;</span>, {
    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>INTEGER</span>,
      <span style=color:#a6e22e>primaryKey</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
    },
    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>STRING</span>
    }
  });
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Role</span>;
};
</code></pre></div><p>在 app/models/目錄中新增一支 role.model.js 程式內容如下</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>sequelize</span>, <span style=color:#a6e22e>Sequelize</span>) =&gt; {
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Role</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sequelize</span>.<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#34;roles&#34;</span>, {
    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>INTEGER</span>,
      <span style=color:#a6e22e>primaryKey</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
    },
    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>STRING</span>
    }
  });
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Role</span>;
};
</code></pre></div><h2 id=初始化-sequelize>初始化 Sequelize<a hidden class=anchor aria-hidden=true href=#初始化-sequelize>#</a></h2>
<p>在 app/models/目錄中新增一支 index.js 程式內容如下</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../config/db.config.js&#34;</span>);   <span style=color:#75715e>// 引入資料庫連結設定檔
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Sequelize</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;sequelize&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sequelize</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Sequelize</span>(                    <span style=color:#75715e>// 由資料庫連結設定檔的設定值來備置 Sequelize
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>DB</span>,
  <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>USER</span>,
  <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>PASSWORD</span>,
  {
    <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>HOST</span>,
    <span style=color:#a6e22e>dialect</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>dialect</span>,
    <span style=color:#a6e22e>operatorsAliases</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
    <span style=color:#a6e22e>pool</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>max</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>max</span>,
      <span style=color:#a6e22e>min</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>min</span>,
      <span style=color:#a6e22e>acquire</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>acquire</span>,
      <span style=color:#a6e22e>idle</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>idle</span>
    }
  }
);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> {};
<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Sequelize</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Sequelize</span>;
<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>sequelize</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sequelize</span>;
<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../models/user.model.js&#34;</span>)(<span style=color:#a6e22e>sequelize</span>, <span style=color:#a6e22e>Sequelize</span>);
<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>role</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../models/role.model.js&#34;</span>)(<span style=color:#a6e22e>sequelize</span>, <span style=color:#a6e22e>Sequelize</span>);
<span style=color:#75715e>// 設定兩資料表的對應關係（多對多，所以會多出一個新的表 user_roles）
</span><span style=color:#75715e>// 一個使用者可能有多個角色
</span><span style=color:#75715e>// 一個角色也可能有多個使用者
</span><span style=color:#75715e></span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>belongsToMany</span>(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>user</span>, {
  <span style=color:#a6e22e>through</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;user_roles&#34;</span>,
  <span style=color:#a6e22e>foreignKey</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;roleId&#34;</span>,
  <span style=color:#a6e22e>otherKey</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;userId&#34;</span>
});
<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>belongsToMany</span>(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>role</span>, {
  <span style=color:#a6e22e>through</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;user_roles&#34;</span>,
  <span style=color:#a6e22e>foreignKey</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;userId&#34;</span>,
  <span style=color:#a6e22e>otherKey</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;roleId&#34;</span>
});
<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>ROLES</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;user&#34;</span>, <span style=color:#e6db74>&#34;admin&#34;</span>];
<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>;
</code></pre></div><h2 id=執行程式産生資料表與資料>執行程式産生資料表與資料<a hidden class=anchor aria-hidden=true href=#執行程式産生資料表與資料>#</a></h2>
<h3 id=在-serverjs-主程式中加入以下程式>在 server.js 主程式中加入以下程式<a hidden class=anchor aria-hidden=true href=#在-serverjs-主程式中加入以下程式>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./app/models&#34;</span>);     <span style=color:#75715e>// 引入 app/models/index.js 匯出的程式碼(即 sequelize model 定義檔)
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Role</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>role</span>;

<span style=color:#75715e>// 呼叫 sync function 將會依 model 定義內容産生資料表，force 參數值為 true 將會重建已存在的資料表
</span><span style=color:#75715e></span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>sequelize</span>.<span style=color:#a6e22e>sync</span>({ <span style=color:#a6e22e>force</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }).<span style=color:#a6e22e>then</span>(() =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Drop and Resync Database with { force: true }&#39;</span>);
    <span style=color:#a6e22e>initial</span>();  <span style=color:#75715e>// 産生資料表後，呼叫 initial function 為 roles table 新增二筆初始資料
</span><span style=color:#75715e></span>}).<span style=color:#66d9ef>catch</span>((<span style=color:#a6e22e>err</span>) =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>err</span>);
});

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PORT</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>5000</span>;  <span style=color:#75715e>// port 預設為 5000 ，並可以在 .env 檔案中進行客製化 （如：PORT＝5001）
</span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>PORT</span>, () =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Backend server is running on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
})

<span style=color:#75715e>// 為 roles table 新增二筆初始資料
</span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>initial</span>() {
    <span style=color:#a6e22e>Role</span>.<span style=color:#a6e22e>create</span>({
        <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>,
        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;user&#34;</span>
    });

    <span style=color:#a6e22e>Role</span>.<span style=color:#a6e22e>create</span>({
        <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>,
        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;admin&#34;</span>
    });
}
</code></pre></div><h3 id=執行程式産生資料表>執行程式産生資料表<a hidden class=anchor aria-hidden=true href=#執行程式産生資料表>#</a></h3>
<p>程式執行成功後可以查看資料庫已順利産生四個資料表以及 roles table 中的二筆初始資料</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/177307074-85a3ef93-55a2-4f7c-925c-76ab2c1a8315.png alt=image>
</p>
<h2 id=了解-nodejs-路由>了解 Node.js 路由<a hidden class=anchor aria-hidden=true href=#了解-nodejs-路由>#</a></h2>
<h3 id=建立-userroutesjs-router-file>建立 user.routes.js router file<a hidden class=anchor aria-hidden=true href=#建立-userroutesjs-router-file>#</a></h3>
<p>新增 routes 目錄，在此目錄下新增 user.routes.js 檔案</p>
<blockquote>
<p>routes/user.routes.js</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>).<span style=color:#a6e22e>Router</span>();
<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/usertest&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
	<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;user test is successful&#34;</span>);
});

<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</code></pre></div><p>在 server.js 程式中先匯入 &ldquo;./app/routes/user.routes&rdquo; 這個 router 設定檔，再透過 app.use 語法來使用這個 router(第9行)。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span>  <span style=color:#a6e22e>express</span>();
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dotenv</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;dotenv&#34;</span>);

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userRoute</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./app/routes/user.routes&#34;</span>);
</span>
<span style=color:#a6e22e>dotenv</span>.<span style=color:#a6e22e>config</span>();

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api/users&#34;</span>, <span style=color:#a6e22e>userRoute</span>);
</span>
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PORT</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>5000</span>, ()=&gt;{
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Backend server is running...&#34;</span>);
});
</code></pre></td></tr></table>
</div>
</div><p>開啟瀏覧器，輸入 http:5000/api/users/usertest，瀏覧器將呈現成功訊息</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>user test is successfull!
</code></pre></div><p>為 routes/user.routes.js 再新增一個 post method</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>).<span style=color:#a6e22e>Router</span>();
<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/usertest&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
	<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;user test is successful&#34;</span>);
});

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/userposttest&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>username</span>;
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;your username is: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>username</span>)
</span><span style=display:block;width:100%;background-color:#3c3d38>});
</span>
<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</code></pre></td></tr></table>
</div>
</div><p>使用 postman 來測試 post，結果回傳的是 Server Error，原因是 express 預設是不接受 json 格式的資料。</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/165109395-6fe656e9-4d12-448e-9fee-f47e4a6c6d3f.png alt=image>
</p>
<p>在 server.js 程式中加入如第一行的設定</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>json</span>());
</span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api/users&#34;</span>, <span style=color:#a6e22e>userRoute</span>);
</code></pre></td></tr></table>
</div>
</div><p>設定完成後就可正常了</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/165110665-149df942-59a9-40c4-8de8-8061c2f7af76.png alt=image>
</p>
<h3 id=建立-authroutesjs-router-file>建立 auth.routes.js router file<a hidden class=anchor aria-hidden=true href=#建立-authroutesjs-router-file>#</a></h3>
<p>將使用者資料註冊和資用者帳號驗證的機制獨立在這個 route file 中，讓程式結構更清晰。內容如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>// routes/auth.routes.js
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>).<span style=color:#a6e22e>Router</span>();
<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authService</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../services/auth.service&#34;</span>);
</span>
<span style=color:#75715e>// 帳號註冊
</span><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/signup&#34;</span>, <span style=color:#a6e22e>authService</span>.<span style=color:#a6e22e>signup</span>);
</span><span style=color:#75715e>// 登入
</span><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/signin&#34;</span>, <span style=color:#a6e22e>authService</span>.<span style=color:#a6e22e>signin</span>);
</span>
<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>在 auth.routes.js route 程式中基於｀關注點分離原則｀把｀商業邏輯｀的部份再分離至 services 中。</p>
</blockquote>
<blockquote>
<p>在 ./app 目錄下新增 services 子目錄，並新增一支 auth.service.js 程式，將使用者註冊及登入邏輯放在這支 service 程式中，內容如下：</p>
</blockquote>
<blockquote>
<p>在這支程式中會使用到額外的套件，必須先進行安裝。<code>$ yarn add crypto-js jsonwebtoken</code>。其中 crypto-js 用來進行使用者密碼加解密(程式第2、15、50、51行)，而 jsonwebtoken 套件則是支援 Json Web Token 功能(程式第55行使用 jwt.sign 産生合法 Token)。</p>
</blockquote>
<pre tabindex=0><code class="language-js　{linenos=table,hl_lines=[2,16,51,52,56],linenostart=1}" data-lang="js　{linenos=table,hl_lines=[2,16,51,52,56],linenostart=1}">// auth.service.js
const db = require(&quot;../models&quot;);
const CryptoJS = require(&quot;crypto-js&quot;);
const jwt = require(&quot;jsonwebtoken&quot;);

const User = db.user;
const Role = db.role;

const Op = db.Sequelize.Op;

const signup = (req, res) =&gt; {
    // Save User to Database
    User.create({
        username: req.body.username,
        email: req.body.email,
        password: CryptoJS.AES.encrypt(req.body.password, process.env.PASS_SEC).toString()，
    }).then(user =&gt; {
        if (req.body.roles) {
            Role.findAll({
                where: {
                    name: {
                        [Op.or]: req.body.roles
                    }
                }
            }).then(roles =&gt; {
                user.setRoles(roles).then(() =&gt; {
                    res.send({ message: &quot;User registered successfully!&quot; });
                });
            });
        } else {
            // user role = 1
            user.setRoles([1]).then(() =&gt; {
                res.send({ message: &quot;User registered successfully!&quot; });
            });
        }
    }).catch(err =&gt; {
        res.status(500).send({ message: err.message });
    });
};

const signin = (req, res) =&gt; {
    User.findOne({
        where: {
            username: req.body.username
        }
    }).then(user =&gt; {
        if (!user) {
            return res.status(404).send({ message: &quot;Wrong Credentials.&quot; });
        }

        const hashedPassword = CryptoJS.AES.decrypt(user.password, process.env.PASS_SEC);
        const orginalPassword = hashedPassword.toString(CryptoJS.enc.Utf8);

        orginalPassword !== req.body.password &amp;&amp; res.status(401).json(&quot;Wrong Credentials&quot;);

        const accessToken = jwt.sign(
            {id: user.id}, 
            process.env.JWT_SEC,
            { expiresIn: &quot;3d&quot; }
        );

        var authorities = [];
        user.getRoles().then(roles =&gt; {
            for (let i = 0; i &lt; roles.length; i++) {
                authorities.push(&quot;ROLE_&quot; + roles[i].name.toUpperCase());
            }
            res.status(200).send({
                id: user.id,
                username: user.username,
                email: user.email,
                roles: authorities,
                accessToken: accessToken
            });
        });
    }).catch(err =&gt; {
        res.status(500).send({ message: err.message });
    });
};

module.exports = { signup, signin };
</code></pre><blockquote>
<p>在 server.js 引用這個新的 router</p>
</blockquote>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>// ...
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userRoute</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./app/routes/user.routes&#34;</span>);
<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authRoute</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./app/routes/auth.routes&#34;</span>);
</span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>json</span>());
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api/users&#34;</span>, <span style=color:#a6e22e>userRoute</span>);

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api/auth&#34;</span>, <span style=color:#a6e22e>authRoute</span>);
</span>
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PORT</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>5000</span>;  <span style=color:#75715e>// port 預設為 5000 ，並可以在 .env 檔案中進行客製化 （如：PORT＝5001）
</span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>PORT</span>, () =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Backend server is running on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
})
</code></pre></td></tr></table>
</div>
</div><h3 id=測試使用者註冊及登入功能>測試使用者註冊及登入功能<a hidden class=anchor aria-hidden=true href=#測試使用者註冊及登入功能>#</a></h3>
<p>使用 postman 進行使用者註冊功能測試</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/172516923-b6163f6b-a42e-4648-ab7a-2260d54ebfb5.png alt=image>
</p>
<blockquote>
<p>註冊成功後，在資料庫中已新增一筆使用者資料</p>
</blockquote>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/172517325-9dc0d87f-f12d-4637-a799-10f6df019413.png alt="2022-06-08 10-19-46">
</p>
<p>使用 postman 進行使用者登入功能測試</p>
<blockquote>
<p>登入成功後會回傳一個 Token</p>
</blockquote>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/177312138-067c9842-4d60-46cf-b211-39036065eb02.png alt=image>
</p>
<h2 id=在-nodejs-中使用-jwt-來進行-token-based-的使用者授權驗證>在 Node.js 中使用 JWT 來進行 Token-Based 的使用者授權驗證<a hidden class=anchor aria-hidden=true href=#在-nodejs-中使用-jwt-來進行-token-based-的使用者授權驗證>#</a></h2>
<p>使用 <code>jsonwebtoken</code>套件可以實現 Token-base 的身份驗證與授權讓我們的 API 程式更安全</p>
<p>JWT 實作的過程大致可以分成三個部分:</p>
<ul>
<li>在登入成功後産生合法的 JWT Token</li>
<li>每次收到 request 時驗證是否為合法有效的 JWT Token</li>
<li>在特定 API Endpoint 上驗證是否帶有 “合法有效的 JWT Token”，以達到權限管理的需求</li>
</ul>
<h3 id=産生合法-jwt>産生合法 JWT<a hidden class=anchor aria-hidden=true href=#産生合法-jwt>#</a></h3>
<p>在登入證驗中加入産生 Token 的邏輯，在檢核使用者輸入的密碼正確後，將 User ID (_id這個內部 Key)這個屬性值透過 sign function 來産生 access token，並回傳給前端。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jwt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;jsonwebtoken&#34;</span>);  <span style=color:#75715e>// 匯入 JsonWebToken套件
</span></span><span style=color:#75715e>//...
</span><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>accessToken</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>sign</span>({
</span>            <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>_id</span>
<span style=display:block;width:100%;background-color:#3c3d38>        }, <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>JWT_SEC</span>,
</span>            { <span style=color:#a6e22e>expiresIn</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;3d&#34;</span> }
        );

        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>authorities</span> <span style=color:#f92672>=</span> [];
        <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>getRoles</span>().<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>roles</span> =&gt; {
            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
                <span style=color:#a6e22e>authorities</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>roles</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>name</span>.<span style=color:#a6e22e>toUpperCase</span>());
            }
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>send</span>({
                <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>id</span>,
                <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span>,
                <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>email</span>,
                <span style=color:#a6e22e>roles</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>authorities</span>,
                <span style=color:#a6e22e>accessToken</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>accessToken</span>
            });
        });

</code></pre></td></tr></table>
</div>
</div><p>encrypt function 參數除了要加密的字串外，需要一個加密 Key，為彈性起見，把它寫在 .env 檔案</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#75715e># .env</span>
<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#a6e22e>JWT_SEC</span><span style=color:#f92672>=</span><span style=color:#e6db74>Jason-Web-Token-Secret-key-thisisaprivatekey</span>
</span></code></pre></td></tr></table>
</div>
</div><h3 id=使用-jwt-來驗證-token>使用 JWT 來驗證 Token<a hidden class=anchor aria-hidden=true href=#使用-jwt-來驗證-token>#</a></h3>
<p>在前端取得合法的 JWT Token後，來看看當使用者在呼叫其他 API 時一併回傳的 Token　如何在 server 端來進行驗證。</p>
<p>首先，我們要在 app/ 目錄下新增一個 middleware/ 的子目錄，並在其中新增一個名為 auth.jwt.js 的 express Middleware，程式內容如下</p>
<p>在程式第14行中使用 jsonwebtoken 套件的 verify function 就是用來驗證 request 中的 Token 是否為合法 Token。驗證時一樣需要｀加密 Key｀來當參數。</p>
<p>在這程式中除了驗證 request 中是否有合法的 Token 外，還有其他授權檢核的邏輯：驗證是否為管理者、驗證是否為版主、驗證是否為管理者或是版主等。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jwt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;jsonwebtoken&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../models&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>user</span>;

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>verifyToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>authHeader</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#a6e22e>authorization</span>;
  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authHeader</span>) {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>send</span>({
      <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Your are not authenticated!&#34;</span>
    });
  }
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>authHeader</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#34; &#34;</span>)[<span style=color:#ae81ff>1</span>];

<span style=display:block;width:100%;background-color:#3c3d38>  <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>JWT_SEC</span>, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>decoded</span>) =&gt; {
</span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>send</span>({
        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Token is not valid!&#34;</span>
      });
    }
    <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decoded</span>.<span style=color:#a6e22e>id</span>;
    <span style=color:#a6e22e>next</span>();
  });
};

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isAdmin</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span>  <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findByPk</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>userId</span>).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>user</span> =&gt; {
    <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>getRoles</span>().<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>roles</span> =&gt; {
      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>roles</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>name</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;admin&#34;</span>) {
          <span style=color:#a6e22e>next</span>();
          <span style=color:#66d9ef>return</span>;
        }
      }

      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>send</span>({
        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Require Admin Role!&#34;</span>
      });
      <span style=color:#66d9ef>return</span>;
    });
  });
};

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authJwt</span> <span style=color:#f92672>=</span> {
</span>  <span style=color:#a6e22e>verifyToken</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>verifyToken</span>,
  <span style=color:#a6e22e>isAdmin</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>isAdmin</span>
};
<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>authJwt</span>;
</code></pre></td></tr></table>
</div>
</div><p>為簡化 middleware 使用時的匯入路徑，我們在　middleware/ 的子目錄，再新增一個名為 index.js 的程式，內容如下</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authJwt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./auth.jwt&#34;</span>);

<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
  <span style=color:#a6e22e>authJwt</span>
};
</code></pre></div><h3 id=在特定-api-endpoint-上驗證是否帶有-合法有效的-jwt-token>在特定 API Endpoint 上驗證是否帶有 “合法有效的 JWT Token”<a hidden class=anchor aria-hidden=true href=#在特定-api-endpoint-上驗證是否帶有-合法有效的-jwt-token>#</a></h3>
<p>在前面完成了驗證 Token 的 Middleware 後，我們來看看如何在 router 中套用這些 middleware， 打開　routers/userroutes.js 程式檔，並將內容修改如下：</p>
<p>在程式第九行 post 的第二個參數，加入呼叫 authJwt.verifyToken 這個 middleware 驗證 token 的 function。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>).<span style=color:#a6e22e>Router</span>();
<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>authJwt</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../middleware&#34;</span>);
</span>
<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/usertest&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
	<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;user test is successful&#34;</span>);
});

<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/userposttest&#34;</span>, 
<span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#a6e22e>authJwt</span>.<span style=color:#a6e22e>verifyToken</span>,
</span>    (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>username</span>;
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;your username is: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>username</span>)
    }
)

<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</code></pre></td></tr></table>
</div>
</div><p>再次執行前面已執行過的 Postman 的 postusertest 這個 request，結果這次會回傳 ｀未授權｀的警告訊息。</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/172527700-5f28b849-a17a-4e66-9c69-b32b8b11c55c.png alt=image>
</p>
<p>將登入成功時回傳的 token，加入到 Header 中，再執行一次 postusertest 即可執行成功。</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/172528020-8d70b2bb-d1df-4d6b-998d-ed6fcf1f2f95.png alt=image>
</p>
<blockquote>
<p>若送出 request 中未包含 Token 則會回傳“未被授權執行本功能”。</p>
</blockquote>
<blockquote>
<p>若送出 request 中包含的是不合法的 Token 則會回傳“Token不合法“。</p>
</blockquote>
<h2 id=完成-todo-list-相關功能>完成 todo list 相關功能<a hidden class=anchor aria-hidden=true href=#完成-todo-list-相關功能>#</a></h2>
<h3 id=定義-todo-資料模型>定義 todo 資料模型<a hidden class=anchor aria-hidden=true href=#定義-todo-資料模型>#</a></h3>
<p>在 app/models/目錄中新增一支 todo.model.js 程式內容如下</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>sequelize</span>, <span style=color:#a6e22e>Sequelize</span>) =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Todo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sequelize</span>.<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#34;todo&#34;</span>, {
        <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> {
            <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>STRING</span>
        },
        <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> {
            <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>STRING</span>
        },
        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> {
            <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>BOOLEAN</span>
        }
    });
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Todo</span>;
};
</code></pre></div><h3 id=修改-appmodelsindexjs>修改 app/models/index.js<a hidden class=anchor aria-hidden=true href=#修改-appmodelsindexjs>#</a></h3>
<p>app/models/index.js 中加入 <code>db.todo = require("../models/todo.model")(sequelize, Sequelize);</code></p>
<pre tabindex=0><code class="language-js{{linenos=table,hl_lines=[24]}" data-lang="js{{linenos=table,hl_lines=[24]}">const config = require(&quot;../config/db.config&quot;);
const Sequelize = require(&quot;sequelize&quot;);
const sequelize = new Sequelize(
    config.DB,
    config.USER,
    config.PASSWORD,
    {
        host: config.HOST,
        dialect: config.dialect,
        operatorsAliases: 0,
        pool: {
            max: config.pool.max,
            min: config.pool.min,
            acquire: config.pool.acquire,
            idle: config.pool.idle
        }
    }
);
const db = {};
db.Sequelize = Sequelize;
db.sequelize = sequelize;
db.user = require(&quot;../models/user.model&quot;)(sequelize, Sequelize);
db.role = require(&quot;../models/role.model&quot;)(sequelize, Sequelize);
db.todo = require(&quot;../models/todo.model&quot;)(sequelize, Sequelize);
db.role.belongsToMany(db.user, {
    through: &quot;user_roles&quot;,
    foreignKey: &quot;roleId&quot;,
    otherKey: &quot;userId&quot;
});
db.user.belongsToMany(db.role, {
    through: &quot;user_roles&quot;,
    foreignKey: &quot;userId&quot;,
    otherKey: &quot;roleId&quot;
});
db.ROLES = [&quot;user&quot;, &quot;admin&quot;];
module.exports = db;
</code></pre><h3 id=新增-todoservicejs>新增 todo.service.js<a hidden class=anchor aria-hidden=true href=#新增-todoservicejs>#</a></h3>
<p>將實際讀寫資料的動作寫在 service 中。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>//./app/services.todo.service.js
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../models&#34;</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Todo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>todo</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Op</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Sequelize</span>.<span style=color:#a6e22e>Op</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>create</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>title</span>) {
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>({
            <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;內容不得為空白！&#34;</span>
        });
        <span style=color:#66d9ef>return</span>;
    }
    <span style=color:#75715e>// 新增一個 Todo
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>todo</span> <span style=color:#f92672>=</span> {
        <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>title</span>,
        <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>description</span>,
        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>
    }

    <span style=color:#75715e>// 將 todo 存入資料庫
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>Todo</span>.<span style=color:#a6e22e>create</span>(<span style=color:#a6e22e>todo</span>)
        .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>data</span> =&gt; {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>data</span>);
        }).<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span> =&gt; {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>send</span>({
                <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;資料存檔時發生錯誤！&#34;</span>
            });
        });

}

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>findAll</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>title</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>title</span>;
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>condition</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>title</span> <span style=color:#f92672>?</span> { <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> { [<span style=color:#a6e22e>Op</span>.<span style=color:#a6e22e>like</span>]<span style=color:#f92672>:</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>title</span><span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span> } } <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>;
    <span style=color:#a6e22e>Todo</span>.<span style=color:#a6e22e>findAll</span>({ <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>condition</span> })
        .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>data</span> =&gt; {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>data</span>);
        })
        .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span> =&gt; {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>send</span>({
                <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;由資料庫讀取 Todo 資料時發生錯誤！&#34;</span>
            });
        });
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>findOne</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>id</span>;
    <span style=color:#a6e22e>Todo</span>.<span style=color:#a6e22e>findByPk</span>(<span style=color:#a6e22e>id</span>)
        .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>data</span> =&gt; {
            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>data</span>) {
                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>data</span>)
            } <span style=color:#66d9ef>else</span> {
                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>({
                    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`使用id=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>搜尋時找到不 Todo 資料!`</span>
                })
            }
        })
        .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span> =&gt; {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>send</span>({
                <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`使用id=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>搜尋時找到不 Todo 資料!`</span>
            });
        });
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>update</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>id</span>;
    <span style=color:#a6e22e>Todo</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>, {
        <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>id</span> }
    })
        .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>num</span> =&gt; {
            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>num</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>({
                    <span style=color:#a6e22e>mdssage</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Todo 更新完成！&#34;</span>
                });
            } <span style=color:#66d9ef>else</span> {
                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>send</span>({
                    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`使用 id= </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 更新資料時發生錯誤！`</span>
                });
            };
        })
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>deleteOne</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>id</span>;
    <span style=color:#a6e22e>Todo</span>.<span style=color:#a6e22e>destroy</span>({
        <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>id</span> }
    })
        .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>num</span> =&gt; {
            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>num</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>1</span>) {
                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>({
                    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Todo 刪除成功！&#34;</span>
                })
            } <span style=color:#66d9ef>else</span> {
                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>({
                    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`使用 id= </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 刪除 Todo 時未找到任何資料！`</span>
                })
            };
        })
        .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span> =&gt; {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>send</span>({
                <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`使用 id= </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 刪除 Todo 時發生錯誤！`</span>
            })
        })
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>deleteAll</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
    <span style=color:#a6e22e>Todo</span>.<span style=color:#a6e22e>destroy</span>({
        <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> {},
        <span style=color:#a6e22e>truncat</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>
    })
        .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>nums</span> =&gt; {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>({
                <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>nums</span><span style=color:#e6db74>}</span><span style=color:#e6db74> Todo 資料被刪除成功！`</span>
            })
        })
        .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span> =&gt; {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>send</span>({
                <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;刪除所有資料時發生錯誤！&#34;</span>
            })
        })
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>findAllDoneTodos</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
    <span style=color:#a6e22e>Todo</span>.<span style=color:#a6e22e>findAll</span>({ <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> } })
        .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>data</span> =&gt; {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>data</span>);
        })
        .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span> =&gt; {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>send</span>({
                <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;讀取資料時發生錯誤！&#34;</span>
            })
        })
};

<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>create</span>, <span style=color:#a6e22e>findAll</span>, <span style=color:#a6e22e>findOne</span>, <span style=color:#a6e22e>update</span>, <span style=color:#a6e22e>deleteAll</span>, <span style=color:#a6e22e>deleteOne</span>, <span style=color:#a6e22e>findAllDoneTodos</span> };
</code></pre></div><h3 id=新增-todorouterjs>新增 todo.router.js<a hidden class=anchor aria-hidden=true href=#新增-todorouterjs>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>// ./app/routers/todo.routes.js
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>).<span style=color:#a6e22e>Router</span>();
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>todo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../services/todo.service&#34;</span>);

<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>create</span>);
<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>findAll</span>);
<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/done&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>findAllDoneTodos</span>);
<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/:id&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>findOne</span>);
<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;/:id&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>update</span>);
<span style=color:#a6e22e>router</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#e6db74>&#34;/:id&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>deleteOne</span>);
<span style=color:#a6e22e>router</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>deleteAll</span>);

<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</code></pre></div><h3 id=將-todo-router-加入到-servicejs>將 todo router 加入到 service.js<a hidden class=anchor aria-hidden=true href=#將-todo-router-加入到-servicejs>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>//...
</span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>json</span>());

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userRoute</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./app/routes/user.routes&#34;</span>);
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api/users&#34;</span>, <span style=color:#a6e22e>userRoute</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>todoRoute</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./app/routes/todo.routes&#34;</span>);
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api/todos&#34;</span>, <span style=color:#a6e22e>todoRoute</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authRoute</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./app/routes/auth.routes&#34;</span>);
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api/auth&#34;</span>, <span style=color:#a6e22e>authRoute</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PORT</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>5000</span>;
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>PORT</span>, () =&gt; {
  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Backend server is running on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
});
<span style=color:#75715e>//...
</span></code></pre></div><h3 id=執行測試>執行測試<a hidden class=anchor aria-hidden=true href=#執行測試>#</a></h3>
<p>新增一筆 Todo
<img loading=lazy src=https://user-images.githubusercontent.com/21993717/177511326-2196eb6b-d084-4e87-ae0b-edb65a5f1cc4.png alt=image>
</p>
<p>找出所有的 Todos
<img loading=lazy src=https://user-images.githubusercontent.com/21993717/177512028-0693e505-4fbf-4bcd-867c-05b1766e6fdb.png alt=image>
</p>
<p>找出 title 中有含某個 keyword 的所有 Todos
<img loading=lazy src=https://user-images.githubusercontent.com/21993717/177514078-b8fdb244-9964-4901-ba9a-8e69474278e8.png alt=image>
</p>
<p>以 ID 找出 Todo
<img loading=lazy src=https://user-images.githubusercontent.com/21993717/177514387-63bedfca-f88f-45df-8ae0-c380c5684a38.png alt=image>
</p>
<p>更新某一個 Todo 的 status 欄位
<img loading=lazy src=https://user-images.githubusercontent.com/21993717/177514584-e85b71cf-7979-4094-bf31-a284cb3508eb.png alt=image>
</p>
<p>查詢所有已經完成的 Todos
<img loading=lazy src=https://user-images.githubusercontent.com/21993717/177514813-533a0280-d00c-422b-b282-081891ff0c0a.png alt=image>
</p>
<p>刪除某一個 Todo
<img loading=lazy src=https://user-images.githubusercontent.com/21993717/177515164-5367e006-12eb-444f-981f-07e3383cbebe.png alt=image>
</p>
<p>刪除所有的 Todos
<img loading=lazy src=https://user-images.githubusercontent.com/21993717/177515470-bb79d8e1-2ab6-4c42-bc7a-af026223c273.png alt=image>
</p>
<h2 id=使用-middleware-來進行檢核使用者角色>使用 middleware 來進行檢核使用者角色<a hidden class=anchor aria-hidden=true href=#使用-middleware-來進行檢核使用者角色>#</a></h2>
<p>將 app/routes/todo.routes.js 內容修改成如下：</p>
<ul>
<li>第五行：create 功能加入 authJwt.verifyToken middleware 檢核，必須是已登入的使用者才能執行</li>
<li>第六行：findall 功能加入 authJwt.verifyToken 以及 authJwt.isAdmin middleware 檢核，必須是已登入的使用者且具有管理者身份才能執行</li>
</ul>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>).<span style=color:#a6e22e>Router</span>();
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>todo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../services/todo.service&#34;</span>);
<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>authJwt</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../middleware&#34;</span>);

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>authJwt</span>.<span style=color:#a6e22e>verifyToken</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>create</span>);
</span><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/&#34;</span>, [<span style=color:#a6e22e>authJwt</span>.<span style=color:#a6e22e>verifyToken</span>, <span style=color:#a6e22e>authJwt</span>.<span style=color:#a6e22e>isAdmin</span>], <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>findAll</span>);
</span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/done&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>findAllDoneTodos</span>);
<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/:id&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>findOne</span>);
<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;/:id&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>update</span>);
<span style=color:#a6e22e>router</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#e6db74>&#34;/:id&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>deleteOne</span>);
<span style=color:#a6e22e>router</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>todo</span>.<span style=color:#a6e22e>deleteAll</span>);

<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</code></pre></td></tr></table>
</div>
</div><p>再次執行 create Todo API endpoint，發現未登入的使用者已無法執行。</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/177521297-f257b33f-3967-4436-a55e-06edab783dc8.png alt=image>
</p>
<p>以一般使用者進行登入</p>
<p>打開 Postman 先使用已註冊的使用者帳號登入，取得 token</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/177533670-c3ea5553-ec9c-4ef7-9590-40c2d004f048.png alt=image>
</p>
<p>再將這個 token (使表使用者是 tom) 加入 request authorization header 中，再次造再次執行 create Todo API endpoint，結果可正常新建一個 Todo</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/177534063-d9bae9ad-6a0a-4e69-9d32-57426e053b2a.png alt=image>
</p>
<p>再以相同 token (代表使用者是 tom) 造訪 get All Todos API endpoint ，結果回傳 &ldquo;須為管理者角色者"才能造訪。</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/177535624-61a23f25-1dae-4629-95d7-1c4a47b0dfff.png alt=image>
</p>
<p>註冊一個新使用者且具備有 admin 角色</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/177520131-c0017c60-7e73-4f2c-b8ee-8e7c7ca8da96.png alt=image>
</p>
<p>改用新註冊的使用者 Jeff 來重新登入，並取得回傳的 token</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/177536382-a474d1b9-b5a7-4e91-9a3f-dd3d608131d8.png alt=image>
</p>
<p>改採此 token (代表使用者是 jeff) 再次造訪 get All Todos API endpoint ，結果顯示可正常顯示所有的 Todos。</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/177536553-e160f1fc-2b5e-4ef8-bfd9-4bef8a0ad298.png alt=image>
</p>
<h2 id=使用-middleware-來進行其他資料檢核>使用 middleware 來進行其他資料檢核<a hidden class=anchor aria-hidden=true href=#使用-middleware-來進行其他資料檢核>#</a></h2>
<p>程式至此已經可以透過 JWT 相關功能查核使用者是否已正確登入系統、是以何種身份（角色）登入的。</p>
<p>最後要再呈現的是使用 middleware 功能來查核其他資料正確性，如：使用者註冊時是否使用了相同的使用者名稱？是否 email 已經被其他使用者使用過？</p>
<p>在 app/middleware 目錄下新增 verify.signup.js，內容如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../models&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ROLES</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Roles</span>;
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>user</span>;

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#a6e22e>checkDuplicateUsernameOrEmail</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span>  <span style=color:#75715e>// Username
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({
    <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>username</span>
    }
  }).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>user</span> =&gt; {
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span>) {
      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>({
        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Failed! Username is already in use!&#34;</span>
      });
      <span style=color:#66d9ef>return</span>;
    }

    <span style=color:#75715e>// Email
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({
      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>email</span>
      }
    }).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>user</span> =&gt; {
      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span>) {
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>({
          <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Failed! Email is already in use!&#34;</span>
        });
        <span style=color:#66d9ef>return</span>;
      }

      <span style=color:#a6e22e>next</span>();
    });
  });
};

<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#a6e22e>checkRolesExisted</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>roles</span>) {
    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>ROLES</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>roles</span>[<span style=color:#a6e22e>i</span>])) {
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>({
          <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Failed! Role does not exist = &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>roles</span>[<span style=color:#a6e22e>i</span>]
        });
        <span style=color:#66d9ef>return</span>;
      }
    }
  }
  
  <span style=color:#a6e22e>next</span>();
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>verifySignUp</span> <span style=color:#f92672>=</span> {
  <span style=color:#a6e22e>checkDuplicateUsernameOrEmail</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>checkDuplicateUsernameOrEmail</span>,
  <span style=color:#a6e22e>checkRolesExisted</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>checkRolesExisted</span>
};

<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>verifySignUp</span>;
</code></pre></td></tr></table>
</div>
</div><p>修改 app/middleware/index.js 檔案如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authJwt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./auth.jwt&#34;</span>);
<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>verifySignUp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./verify.signup&#34;</span>);
</span>
<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
  <span style=color:#a6e22e>authJwt</span>,
<span style=display:block;width:100%;background-color:#3c3d38>  <span style=color:#a6e22e>verifySignUp</span>
</span>};
</code></pre></td></tr></table>
</div>
</div><p>將新的 middleware　功能放入到 SignUp 功能中。
打開　app/routes/auth.routes.js 程式檔，修改如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>).<span style=color:#a6e22e>Router</span>();
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authService</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../services/auth.service&#34;</span>);
<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>verifySignUp</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;../middleware&#34;</span>)
</span><span style=color:#75715e>// 帳號註冊
</span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/signup&#34;</span>, 
[
<span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#a6e22e>verifySignUp</span>.<span style=color:#a6e22e>checkDuplicateUsernameOrEmail</span>,
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#a6e22e>verifySignUp</span>.<span style=color:#a6e22e>checkRolesExisted</span>
</span>],
<span style=color:#a6e22e>authService</span>.<span style=color:#a6e22e>signup</span>);

<span style=color:#75715e>// 登入
</span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/signin&#34;</span>, <span style=color:#a6e22e>authService</span>.<span style=color:#a6e22e>signin</span>);

<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>router</span>;
</code></pre></td></tr></table>
</div>
</div><p>先使用已經被註冊過的 EMail來進行測試，結果回傳 EMail 已被使用。</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/172577871-acb686cd-9b5f-4018-87bb-6f3f1d1b47d7.png alt=image>
</p>
<p>再使用已被註冊過的 UserName 來進行註冊，結果回傳：</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/172578295-91688eb1-4af3-46e5-bdf9-259c61d7a3d4.png alt=image>
</p>
<h2 id=cors>cors<a hidden class=anchor aria-hidden=true href=#cors>#</a></h2>
<p>這個後端專案預計要給前端 Angular 來使用，跨域存取問題就用 cors 設定來解決。</p>
<p>先安裝 cors 套件</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ yarn add cors

yarn add v1.22.19
<span style=color:#f92672>[</span>1/4<span style=color:#f92672>]</span> Resolving packages...
<span style=color:#f92672>[</span>2/4<span style=color:#f92672>]</span> Fetching packages...
<span style=color:#f92672>[</span>3/4<span style=color:#f92672>]</span> Linking dependencies...
<span style=color:#f92672>[</span>4/4<span style=color:#f92672>]</span> Building fresh packages...
success Saved lockfile.
success Saved <span style=color:#ae81ff>2</span> new dependencies.
info Direct dependencies
└─ cors@2.8.5
info All dependencies
├─ cors@2.8.5
└─ object-assign@4.1.1
Done in 0.86s.
</code></pre></div><p>打開 server.js，修改如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dotenv</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;dotenv&#34;</span>);
<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cors</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;cors&#34;</span>);
</span><span style=color:#a6e22e>dotenv</span>.<span style=color:#a6e22e>config</span>();
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>corsOptions</span> <span style=color:#f92672>=</span> {
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#a6e22e>origin</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>
</span>};
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>cors</span>(<span style=color:#a6e22e>corsOptions</span>));

<span style=color:#75715e>//...
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://calvinegs.github.io/tags/node.js/>Node.js</a></li>
<li><a href=https://calvinegs.github.io/tags/express/>express</a></li>
<li><a href=https://calvinegs.github.io/tags/mysql/>mysql</a></li>
<li><a href=https://calvinegs.github.io/tags/jwt/>JWT</a></li>
<li><a href=https://calvinegs.github.io/tags/webapi/>webapi</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://calvinegs.github.io/posts/docker-mariadb/>
<span class=title>« Prev Page</span>
<br>
<span>使用 Docker 執行 Mariadb</span>
</a>
<a class=next href=https://calvinegs.github.io/posts/docker-mysql/>
<span class=title>Next Page »</span>
<br>
<span>使用 Docker 執行 MySQL</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 Node.js + express + MySQL 建立一個後端服務 REST API on twitter" href="https://twitter.com/intent/tweet/?text=%e4%bd%bf%e7%94%a8%20Node.js%20%2b%20express%20%2b%20MySQL%20%e5%bb%ba%e7%ab%8b%e4%b8%80%e5%80%8b%e5%be%8c%e7%ab%af%e6%9c%8d%e5%8b%99%20REST%20API&url=https%3a%2f%2fcalvinegs.github.io%2fposts%2fnodejs-restapi-mysql%2f&hashtags=Node.js%2cexpress%2cmysql%2cJWT%2cwebapi"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 Node.js + express + MySQL 建立一個後端服務 REST API on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fcalvinegs.github.io%2fposts%2fnodejs-restapi-mysql%2f&title=%e4%bd%bf%e7%94%a8%20Node.js%20%2b%20express%20%2b%20MySQL%20%e5%bb%ba%e7%ab%8b%e4%b8%80%e5%80%8b%e5%be%8c%e7%ab%af%e6%9c%8d%e5%8b%99%20REST%20API&summary=%e4%bd%bf%e7%94%a8%20Node.js%20%2b%20express%20%2b%20MySQL%20%e5%bb%ba%e7%ab%8b%e4%b8%80%e5%80%8b%e5%be%8c%e7%ab%af%e6%9c%8d%e5%8b%99%20REST%20API&source=https%3a%2f%2fcalvinegs.github.io%2fposts%2fnodejs-restapi-mysql%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 Node.js + express + MySQL 建立一個後端服務 REST API on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcalvinegs.github.io%2fposts%2fnodejs-restapi-mysql%2f&title=%e4%bd%bf%e7%94%a8%20Node.js%20%2b%20express%20%2b%20MySQL%20%e5%bb%ba%e7%ab%8b%e4%b8%80%e5%80%8b%e5%be%8c%e7%ab%af%e6%9c%8d%e5%8b%99%20REST%20API"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 Node.js + express + MySQL 建立一個後端服務 REST API on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcalvinegs.github.io%2fposts%2fnodejs-restapi-mysql%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 Node.js + express + MySQL 建立一個後端服務 REST API on whatsapp" href="https://api.whatsapp.com/send?text=%e4%bd%bf%e7%94%a8%20Node.js%20%2b%20express%20%2b%20MySQL%20%e5%bb%ba%e7%ab%8b%e4%b8%80%e5%80%8b%e5%be%8c%e7%ab%af%e6%9c%8d%e5%8b%99%20REST%20API%20-%20https%3a%2f%2fcalvinegs.github.io%2fposts%2fnodejs-restapi-mysql%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 Node.js + express + MySQL 建立一個後端服務 REST API on telegram" href="https://telegram.me/share/url?text=%e4%bd%bf%e7%94%a8%20Node.js%20%2b%20express%20%2b%20MySQL%20%e5%bb%ba%e7%ab%8b%e4%b8%80%e5%80%8b%e5%be%8c%e7%ab%af%e6%9c%8d%e5%8b%99%20REST%20API&url=https%3a%2f%2fcalvinegs.github.io%2fposts%2fnodejs-restapi-mysql%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
<div>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='calvinegs-github-io',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://calvinegs.github.io/>永誌不忘 • 筆記簿</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>