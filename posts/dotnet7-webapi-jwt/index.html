<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料） | 永誌不忘 • 筆記簿</title>
<meta name=keywords content="dotnet 7,webapi,jwt,docker,PostgreSQL DB,openapi,swagger">
<meta name=description content="本篇將要紀錄如何使用　.NET 7.0 來建立 一個可方便擴展 Web API">
<meta name=author content="Theme PaperMod">
<link rel=canonical href=https://calvinegs.github.io/posts/dotnet7-webapi-jwt/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://calvinegs.github.io/img/favicon.png>
<link rel=icon type=image/png sizes=16x16 href=https://calvinegs.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://calvinegs.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://calvinegs.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://calvinegs.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料）">
<meta property="og:description" content="本篇將要紀錄如何使用　.NET 7.0 來建立 一個可方便擴展 Web API">
<meta property="og:type" content="article">
<meta property="og:url" content="https://calvinegs.github.io/posts/dotnet7-webapi-jwt/"><meta property="og:image" content="https://calvinegs.github.io/papermod-cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-03-06T00:00:00+00:00">
<meta property="article:modified_time" content="2023-03-06T00:00:00+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://calvinegs.github.io/papermod-cover.png">
<meta name=twitter:title content="使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料）">
<meta name=twitter:description content="本篇將要紀錄如何使用　.NET 7.0 來建立 一個可方便擴展 Web API">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://calvinegs.github.io/posts/"},{"@type":"ListItem","position":2,"name":"使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料）","item":"https://calvinegs.github.io/posts/dotnet7-webapi-jwt/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料）","name":"使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料）","description":"本篇將要紀錄如何使用　.NET 7.0 來建立 一個可方便擴展 Web API","keywords":["dotnet 7","webapi","jwt","docker","PostgreSQL DB","openapi","swagger"],"articleBody":"github Source code\n本文將記錄如何一步步從無到有，使用 Dotnet Core 7.0 建立 ASP.NET Core Web API，其中將會使用到下列技術:\n Dotnet CLI Entity Framework 7.0 Json Web Token PostgreSQL DB (Docker Version) ASP.NET Core Generator  專案完成後的檔案結構 ./專案目錄 ├── .config/ │ └── dotnet-tools.json ├── .vscode/ │ ├── launch.js │ └── tasks.json ├── Controller/ │ ├── AuthenticateController.cs │ ├── TodoController.cs │ └── WeatherForecast.cs ├── Data/ │ └── ApiDbContext.cs ├── Migrations/ ├── Models/ │ ├── AuthenticateData.cs │ └── TodoList.cs ├── obj/ ├── Properties/ │ └── launchSettings.json ├── .gitignore ├── appsettings.Development.json ├── appsettings.json ├── dotnet7-webapi-jwt.csproj ├── global.json ├── Program.cs ├── README.md └── WeatherForecast.cs 專案完成後所提供的 API 端點    Methods Urls Actions     POST /api/Authenticate/login 註冊新使用者帳號   POST /api/Authenticate/register 使用者帳號登入   POST /api/Authenticate/register-admin 管理者帳號登入   GET /api/Todos get all Todos   POST /api/Todos add New Todo   GET /api/Todos/:id get Todo by id   PUT /api/Todos/:id update Todo by id   DELETE /api/Todos/:id remove Todo by id    建置新專案 dotnet 版本管理檢查 你的 Local 可能已安裝了多個版本的 dotnet 環境，使用以下指令來檢查目前的 dotnet 版本\n$ dotnet --version # 顯示目前所使用的版本 7.0.201 # 預設是最新的版本 使用 dotnet cli 建立新專案 $ dotnet new webapi -o dotnet7-webapi-jwt 歡迎使用 .NET 7.0! --------------------- SDK 版本: 7.0.201 遙測 --------- .NET 工具會收集使用資料，協助我們改進您的體驗。資料會由 Microsoft 收集，並分享給社群使用。您可以選擇退出遙測，只要使用您慣用的殼層，將 DOTNET_CLI_TELEMETRY_OPTOUT 環境變數設定為 '1' 或 'true' 即可。 閱讀更多有關 .NET CLI 工具遙測的內容: https://aka.ms/dotnet-cli-telemetry ---------------- 已安裝 ASP.NET Core HTTPS 開發憑證。 若要信任憑證，請執行 'dotnet dev-certs https --trust' (僅限 Windows 與 macOS )。 深入了解 HTTPS: https://aka.ms/dotnet-https ---------------- 撰寫第一個應用程式: https://aka.ms/dotnet-hello-world 了解全新功能: https://aka.ms/dotnet-whats-new 探索文件: https://aka.ms/dotnet-docs 於 GitHub 回報問題和尋找來源: https://github.com/dotnet/core Use 'dotnet --help' 查看可用的命令或瀏覽: https://aka.ms/dotnet-cli -------------------------------------------------------------------------------------- 範本「ASP.NET Core Web API」已成功建立。 正在處理建立後的動作... 正在還原 /home/egs/cal-data/Sources/nhis/dotnet7-webapi-jwt/dotnet7-webapi-jwt.csproj: 正在判斷要還原的專案... 已還原 /home/egs/cal-data/Sources/nhis/dotnet7-webapi-jwt/dotnet7-webapi-jwt.csproj (4.93 sec 內)。 還原成功。 新專案\n$ cd dotnet7-webapi-jwt $ ls -al 總用量 40 drwxrwxr-x 5 egs egs 4096 3月 6 10:23 . drwxrwxr-x 5 egs egs 4096 3月 6 10:22 .. -rw-rw-r-- 1 egs egs 127 3月 6 10:22 appsettings.Development.json -rw-rw-r-- 1 egs egs 151 3月 6 10:22 appsettings.json drwxrwxr-x 2 egs egs 4096 3月 6 10:22 Controllers -rw-rw-r-- 1 egs egs 463 3月 6 10:22 dotnet7-webapi-jwt.csproj drwxrwxr-x 2 egs egs 4096 3月 6 10:23 obj -rw-rw-r-- 1 egs egs 557 3月 6 10:22 Program.cs drwxrwxr-x 2 egs egs 4096 3月 6 10:22 Properties -rw-rw-r-- 1 egs egs 267 3月 6 10:22 WeatherForecast.cs dotnet 版本管理 $ dotnet --list-sdks # 顯示已安裝的 sdk 版本資訊 5.0.408 [/usr/share/dotnet/sdk] 6.0.406 [/usr/share/dotnet/sdk] 7.0.201 [/usr/share/dotnet/sdk] $ dotnet --list-runtimes Microsoft.AspNetCore.App 5.0.17 [/usr/share/dotnet/shared/Microsoft.AspNetCore.App] Microsoft.AspNetCore.App 6.0.14 [/usr/share/dotnet/shared/Microsoft.AspNetCore.App] Microsoft.AspNetCore.App 7.0.3 [/usr/share/dotnet/shared/Microsoft.AspNetCore.App] Microsoft.NETCore.App 5.0.17 [/usr/share/dotnet/shared/Microsoft.NETCore.App] Microsoft.NETCore.App 6.0.14 [/usr/share/dotnet/shared/Microsoft.NETCore.App] Microsoft.NETCore.App 7.0.3 [/usr/share/dotnet/shared/Microsoft.NET# .App] 由於 dotnet 版本演化滿快的，所以會建議在專案目錄中要指定使用 SDK 的版本，以免當你又安裝了更新的版本（如8.0）後程式執行出問題。\n$ dotnet new globaljson --sdk-version 7.0.201 範本「global.json 檔案」已成功建立。 $ cat global.json { \"sdk\": { \"version\": \"7.0.201\" } } 版本控管 使用 dotnet cli 來產生預設的 git ignore 檔案\n$ dotnet new gitignore 建立 git 初始版本\n$ git init \u0026\u0026 git add . \u0026\u0026 git commit -m \"Initial commit\" 安裝本機工具 此方式安裝的工具，僅限本機存取(只針對目前的目錄和子目錄)， 首先透過 dotnet new tool-manifest 命令來產生工具資訊清單檔，再使用 dotnet tool install 來安裝各式工具程式。這樣的方式好處是在專案若多人協助方式時，則可利用 dotnet tool restore 命令將紀錄在 ./.config/dotnet-tools.json 的工具資訊清單檔重建在不同協助人員的電腦中。\n$ dotnet new tool-manifest #會產生 .config/dotnet-tools.json 檔案 $ dotnet tool install --local dotnet-ef #使用 local 安裝方式來安裝 Entity Framework 工具 您可使用下列命令，從此目錄叫用工具: 'dotnet tool run dotnet-ef' 或 'dotnet dotnet-ef'。 已成功安裝工具 'dotnet-ef' (版本 '7.0.3')。項目已新增至資訊清單檔 /home/egs/cal-data/Sources/nhis/dotnet7-webapi-jwt/.config/dotnet-tools.json。 $ dotnet tool install --local dotnet-aspnet-codegenerator #使用 local 安裝方式來安裝 Code Generator 工具 您可使用下列命令，從此目錄叫用工具: 'dotnet tool run dotnet-aspnet-codegenerator' 或 'dotnet dotnet-aspnet-codegenerator'。 已成功安裝工具 'dotnet-aspnet-codegenerator' (版本 '7.0.4')。項目已新增至資訊清單檔 /home/egs/cal-data/Sources/nhis/dotnet7-webapi-jwt/.config/dotnet-tools.json。 $ cat ./.config/dotnet-tools.json { \"version\": 1, \"isRoot\": true, \"tools\": { \"dotnet-ef\": { \"version\": \"7.0.3\", \"commands\": [ \"dotnet-ef\" ] }, \"dotnet-aspnet-codegenerator\": { \"version\": \"7.0.4\", \"commands\": [ \"dotnet-aspnet-codegenerator\" ] } } } 安裝程式使用的相關套件 $ dotnet add package Microsoft.EntityFrameworkCore.Tools #使用 dotnet Entity Framework 時必須安裝此套件 $ dotnet add package Microsoft.EntityFrameworkCore.Design #使用 dotnet Entity Framework 時必須安裝此套件 $ dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore #使用 Identity Framework 時必須安裝此套件 $ dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL #使用 PostgreSQL DB 當後端資料庫須安裝此套件 $ dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer #要使用 Token Base 權限管理須安裝此套件 $ dotnet add package Microsoft.EntityFrameworkCore.SqlServer #使用 dotnet aspnet-codegenerator 時必須安裝此套件  $ dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design #搭配 dotnet-aspnet-codegenerator 使用 $ dotnet add package System.Configuration.ConfigurationManager #搭配 dotnet-aspnet-codegenerator 使用 安裝的程式套件資訊紀錄在 “專案”.csproj 檔案中\n$ cat dotnet7-webapi-jwt.csproj #查看 安裝套件的相關設定值 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30   Sdk=\"Microsoft.NET.Sdk.Web\"  net7.0 enable enable dotnet7_webapi_jwt    Include=\"Microsoft.AspNetCore.Authentication.JwtBearer\" Version=\"7.0.3\" /  Include=\"Microsoft.AspNetCore.Identity.entityframeworkCore\" Version=\"7.0.3\" /  Include=\"Microsoft.AspNetCore.OpenApi\" Version=\"7.0.3\" /  Include=\"Microsoft.EntityFrameworkCore.Design\" Version=\"7.0.3\"  runtime; build; native; contentfiles; analyzers; buildtransitive all   Include=\"Microsoft.EntityFrameworkCore.SqlServer\" Version=\"7.0.3\" /  Include=\"Microsoft.EntityFrameworkCore.Tools\" Version=\"7.0.3\"  runtime; build; native; contentfiles; analyzers; buildtransitive all   Include=\"Microsoft.VisualStudio.Web.codeGeneration.Design\" Version=\"7.0.4\" /  Include=\"Npgsql.entityFrameworkCore.PostgreSQL\" Version=\"7.0.3\" /  Include=\"Swashbuckle.AspNetCore\" Version=\"6.4.0\" /  Include=\"system.Configuration.ConfigurationManager\" Version=\"7.0.0\" /      建立 git 新版本 $ git add . \u0026\u0026 git commit -m \"Add EFCore NuGet packages\" 執行程式 $ dotnet watch 打開 VS Code\n$ code . 目前産生的程式架構\n設置使用 Entity Framework相關設定 新增 database context (自動產生) 使用 dotnet ef 工具在專案目錄 ./Data 子目錄下新建立一個 ApiDbContext.cs 的 DB Context file\n註：在使用前先把 後端資料庫 環境備妥，安裝 PostGreSQL DB 可參考此篇筆紀　使用 Docker 執行 PostgresSQL \n$ dotnet ef dbcontext scaffold \"User ID =docker;Password=docker;Server=localhost;Port=5432;Database=pg_testdb; Integrated Security=true;Pooling=true\" Npgsql.entityFrameworkCore.PostgreSQL -c ApiDbContext -o Data Build started... Build succeeded. To protect potentially sensitive information in your connection string, you should move it out of source code. You can avoid scaffolding the connection string by using the Name= syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid=2131148. For more guidance on storing connection strings, see http://go.microsoft.com/fwlink/?LinkId=723263. using System; using System.Collections.Generic; using Microsoft.EntityFrameworkCore; namespace dotnet7_webapi_jwt.Data; public partial class ApiDbContext : DbContext { public ApiDbContext() { } public ApiDbContext(DbContextOptions options) : base(options) { } // protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)  // = optionsBuilder.UseNpgsql(\"User ID =docker;Password=docker;Server=localhost;Port=5432;Database=pg_testdb; Integrated Security=true;Pooling=true\");  protected override void OnModelCreating(ModelBuilder modelBuilder) { OnModelCreatingPartial(modelBuilder); } partial void OnModelCreatingPartial(ModelBuilder modelBuilder); } 在 appsettings.json 檔案中加入 Connection String\n{ \"Logging\": { \"LogLevel\": { \"Default\": \"Information\", \"Microsoft.AspNetCore\": \"Warning\" } }, \"AllowedHosts\": \"*\", \"ConnectionStrings\": { \"ConnStr\": \"User ID =docker;Password=docker;Server=localhost;Port=5432;Database=pg_testdb; Integrated Security=true;Pooling=true\" } } 使用 Asp.Net Core Identity framework 來管理使用者使用權限 ASP.NET Core Identity:\n 支援使用者介面 (UI) 登入功能的 API。 管理使用者、密碼、設定檔資料、角色、宣告、權杖、電子郵件確認等。  ASP.Net Core Identity Framework 是一個方便且還完善的使用權限管理架構。\n將相關 Asp.Net Core Identity framework 功能注入到 container 中 除了安裝相關套件外，還要調整相關程式:\n 在 Program.cs 檔案中將加入以下程式碼 (before services.AddControllers())  ConfigurationManager _configuration = builder.Configuration; // Add services to the container. builder.Services.AddDbContext( options = options.UseSqlServer( _configuration.GetConnectionString(\"ConnStr\") ) ); builder.Services.AddIdentity() .AddEntityFrameworkStores() .AddDefaultTokenProviders();  使用 AspNetCore Identity，則 DataContext (ApiDbContext.cs 中) 必須要繼承 IdentityDbContext， 同時 Model creationg 時要改成呼叫 base.OnModelCreation  1 2 3 4 5 6 7 8 9 10 11 12 13 14  public partial class ApiDbContext : IdentityDbContext { public ApiDbContext() { } // ...  protected override void OnModelCreating(ModelBuilder modelBuilder) { // OnModelCreatingPartial(modelBuilder);  base.OnModelCreating(modelBuilder);  } }   新增一個 entity framework 遷移 並 更新資料庫 完成上述程式調整後，來執行資料庫遷移(migrations)\n$ dotnet ef migrations add \"Add Identity Framework\" Build started... Build succeeded. Done. To undo this action, use 'ef migrations remove' $ dotnet ef database update 在　dotnet ef migrations add “Add Identity Framework” 指令完成後，可以在專案目錄下發生産生新的子目錄 Migrations，並有三個新檔案\n在 dotnet ef database update 指令完成後，PostgreSQL pg_testdb 資料庫中產生 Identity Framework 會使用到的資料表\n建立 git 新版本 $ git add . \u0026\u0026 git commit -m \"新增一個 entity framework 遷移 並 更新資料庫\" 使用 Jason Web Token 在 appsettings.json 中自定JWT實作會使用到的設定值 { // ...  \"ConnectionStrings\": { \"ConnStr\": \"User ID =docker;Password=docker;Server=localhost;Port=5432;Database=pg_testdb; Integrated Security=true;Pooling=true\" }, \"JwtSettings\": { \"ValidIssuer\": \"Dotnet7WebApiDemo\", \"ValidAudience\": \"Dotnet7WebApiDemo\", \"Secret\": \"Dotnet7 WebApi Demo. Using Json Web Token Technology to keep user info.\" } } 新增 使用者註冊和登入時使用的 Data model class (Models/AuthenticateData.cs) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  using System.ComponentModel.DataAnnotations; namespace dotnet7_webapi_jwt.Models; public class Response { public string? Status { get; set; } public string? Message { get; set; } } public class LoginModel { [EmailAddress] [Required(ErrorMessage = \"Eamil Address is required\")] public string? Email { get; set; } [Required(ErrorMessage = \"Password is required\")] public string? Password { get; set; } } public class RegisterModel { [Required(ErrorMessage = \"User Name is required\")] public string? Username { get; set; } [EmailAddress] [Required(ErrorMessage = \"Email Address is required\")] public string? Email { get; set; } [Required(ErrorMessage = \"Password is required\")] public string? Password { get; set; } } public static class UserRoles { public const string Admin = \"Admin\"; public const string User = \"User\"; }   新增 註冊和登入邏輯 (Controllers/AuthenticateControll.cs) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139  using System.IdentityModel.Tokens.Jwt; using System.Security.Claims; using System.Text; using dotnet7_webapi_jwt.Models; using Microsoft.AspNetCore.Identity; using Microsoft.AspNetCore.Mvc; using Microsoft.IdentityModel.Tokens; namespace dotnet7_webapi_jwt.Controllers; [Route(\"api/[controller]\")] [ApiController] public class AuthenticateController : ControllerBase { private readonly UserManager _userManager; private readonly RoleManager _roleManager; private readonly IConfiguration _configuration; public AuthenticateController( UserManager userManager, RoleManager roleManager, IConfiguration configuration) { _userManager = userManager; _roleManager = roleManager; _configuration = configuration; } [HttpPost] [Route(\"login\")] public async Task Login([FromBody] LoginModel userModel) { var user = await _userManager.FindByEmailAsync(userModel.Email); if (user != null \u0026\u0026 await _userManager.CheckPasswordAsync(user, userModel.Password)) { var userRoles = await _userManager.GetRolesAsync(user); var claims = new List { new Claim(ClaimTypes.Name, user.UserName), new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()), }; foreach (var userRole in userRoles) { claims.Add(new Claim(ClaimTypes.Role, userRole)); } var token = CreateToken(claims); return Ok(new { token = new JwtSecurityTokenHandler().WriteToken(token), expiration = token.ValidTo }); } return Unauthorized(); } [HttpPost] [Route(\"register\")] public async Task Register([FromBody] RegisterModel model) { var userExists = await _userManager.FindByEmailAsync(model.Email); if (userExists != null) return StatusCode(StatusCodes.Status500InternalServerError, new Response { Status = \"Error\", Message = \"User already exists!\" }); IdentityUser user = new() { Email = model.Email, SecurityStamp = Guid.NewGuid().ToString(), UserName = model.Username }; var result = await _userManager.CreateAsync(user, model.Password); if (!result.Succeeded) return StatusCode(StatusCodes.Status500InternalServerError, new Response { Status = \"Error\", Message = \"User creation failed! Please check user details and try again.\" }); return Ok(new Response { Status = \"Success\", Message = \"User created successfully!\" }); } [HttpPost] [Route(\"register-admin\")] public async Task RegisterAdmin([FromBody] RegisterModel model) { var userExists = await _userManager.FindByEmailAsync(model.Email); if (userExists != null) return StatusCode(StatusCodes.Status500InternalServerError, new Response { Status = \"Error\", Message = \"User already exists!\" }); IdentityUser user = new() { Email = model.Email, SecurityStamp = Guid.NewGuid().ToString(), UserName = model.Username }; var result = await _userManager.CreateAsync(user, model.Password); if (!result.Succeeded) return StatusCode(StatusCodes.Status500InternalServerError, new Response { Status = \"Error\", Message = \"User creation failed! Please check user details and try again.\" }); if (!await _roleManager.RoleExistsAsync(UserRoles.Admin)) await _roleManager.CreateAsync(new IdentityRole(UserRoles.Admin)); if (!await _roleManager.RoleExistsAsync(UserRoles.User)) await _roleManager.CreateAsync(new IdentityRole(UserRoles.User)); if (await _roleManager.RoleExistsAsync(UserRoles.Admin)) { await _userManager.AddToRoleAsync(user, UserRoles.Admin); } if (await _roleManager.RoleExistsAsync(UserRoles.Admin)) { await _userManager.AddToRoleAsync(user, UserRoles.User); } return Ok(new Response { Status = \"Success\", Message = \"User created successfully!\" }); } private JwtSecurityToken CreateToken(List claims) { var secretkey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes( _configuration.GetValuestring(\"JwtSettings:Secret\"))); // _configuration.GetSection(\"JwtSettings:Secret\").Value)  var credentials = new SigningCredentials(secretkey, SecurityAlgorithms.HmacSha512Signature); var token = new JwtSecurityToken( // 亦可使用　SecurityTokenDescriptor　來産生 Token  issuer: _configuration.GetValuestring(\"JwtSettings:ValidIssuer\"), audience: _configuration.GetValuestring(\"JwtSettings:ValidAudience\"), expires: DateTime.Now.AddDays(1), claims: claims, signingCredentials: credentials); return token; } }   有關實作 JWT 的流程 透過 JWT 的實作可以讓你的專案實現 Token-base 的身份驗證與授權。 （Json Web Token) 實作的過程大致可以分成三個部分:\n 在登入成功後産生合法的 JWT Token 每次收到 request 時驗證是否為合法有效的 JWT Token 在特定 API Endpoint 上驗證是否帶有 “合法有效的 JWT Token”，以達到權限管理的需求  産生合法的 Jason Web Token 在上述 AuthenticateController.cs 程式中，我們建立一個 CreateToken() 的 function，並在登入檢核成功時産生一個 token 回傳。\n設置驗證是否為合法有效的 JWT Token 第一步，透過 DI 將 JWT 相關設定設置好，在 Programe.cs 檔案中的 ”builder.Services.AddControllers();“ 程式碼之前加入以下有關使用 JWT 使用者授權驗證的程式邏輯：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  builder.Services.AddAuthentication(options = { options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme; options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme; options.DefaultScheme = JwtBearerDefaults.AuthenticationScheme; }) .AddJwtBearer(options = { // 當驗證失敗時，回應標頭會包含 WWW-Authenticate 標頭，這裡會顯示失敗的詳細錯誤原因  options.IncludeErrorDetails = true; // 預設值為 true，有時會特別關閉  options.TokenValidationParameters = new TokenValidationParameters { // 透過這項宣告，就可以從 \"NAME\" 取值  NameClaimType = \"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier\", // 透過這項宣告，就可以從 \"Role\" 取值，並可讓 [Authorize] 判斷角色  RoleClaimType = \"http://schemas.microsoft.com/ws/2008/06/identity/claims/role\", // 驗證 Issuer (一般都會)  ValidateIssuer = true, ValidIssuer = _configuration.GetValuestring(\"JwtSettings:ValidIssuer\"), // 驗證 Audience (通常不太需要)  ValidateAudience = false, //ValidAudience = = _configuration.GetValue(\"JwtSettings:ValidAudience\"),  // 驗證 Token 的有效期間 (一般都會)  ValidateLifetime = true, // 如果 Token 中包含 key 才需要驗證，一般都只有簽章而已  ValidateIssuerSigningKey = false, // 應該從 IConfiguration 取得  IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secret)) }; });   同時宣告一個 Secret 變數，並由 appsettings.json 系統配置檔中讀出 Jwt Secret 的設定。\n1 2 3 4  // ... ConfigurationManager _configuration = builder.Configuration; var secret = _configuration.GetValuestring(\"JwtSettings:Secret\"); // ...   第二步，要啟動 request pipeline 中的 Middleware (UseAuthentication \u0026 UseAuthorization 都需要)\n1 2 3 4  // ... app.UseAuthentication(); app.UseAuthorization(); // ...   在特定 API EndPoint 上驗證是否帶有合法有效的 JWT Token 在 WeatherForecastController.cs Get() function 上加入 “[Authorize]” 即可\n1 2 3 4 5 6 7 8 9 10 11 12  [Authorize] [HttpGet(Name = \"GetWeatherForecast\")] public IEnumerable Get() { return Enumerable.Range(1, 5).Select(index = new WeatherForecast { Date = DateTime.Now.AddDays(index), TemperatureC = Random.Shared.Next(-20, 55), Summary = Summaries[Random.Shared.Next(Summaries.Length)] }) .ToArray(); }   使用 OpenApi Swagger 來測試 API 如上程式加入[Authorize]後，以dotnet watch執行程式，進入 OpenApi Swagger 網頁瀏覽 weatherforecast endpoint，會回傳 Status: 401 Unauthorized 的錯誤訊息。\n在 OpenApi Swagger 網頁點選 register endpoint 來註冊一個新使用者\n輸入註冊資料，執行送出，畫面顯示成功！\n可查看資料庫結果，已在 AspNetUsers Table 中新建立一筆使用者資料：\nOpenApi Swagger 來測試 API 時, Swagger 測試網頁預設是沒有設定 Token 的功能,必須將程式碼中的 “builder.Services.AddSwaggerGen();”改成以下內容\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  builder.Services.AddSwaggerGen(c = { c.SwaggerDoc(\"v1\", new OpenApiInfo { Title = \"JwtDemo\", Version = \"v1\" }); c.AddSecurityDefinition(\"Bearer\", new OpenApiSecurityScheme { In = ParameterLocation.Header, Description = \"Please enter JWT with Bearer into field\", Name = \"Authorization\", Type = SecuritySchemeType.ApiKey }); c.AddSecurityRequirement(new OpenApiSecurityRequirement { { new OpenApiSecurityScheme { Reference = new OpenApiReference { Type = ReferenceType.SecurityScheme, Id = \"Bearer\"} }, new string[] {} } }); });   有了上述的程式設定，當再次 dotnet watch 啟動程式後，瀏覽器呈現的 Swagger 畫面右上角會多出了｀Authorize｀ 的按鈕。按下按鈕就是讓你填入登入成功後回傳的 Token\n使用合法（已完成註冊）使用者帳號／密碼來登入：\n登入成功後回傳的 response 中會包含 token：\n在 “Value:”\" 文字框內填入 “Bearer eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTUxMiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZ…..\"，再按下 Authorize 按鈕即表下在接下來的 Request 中都會自動帶入 Token 傳給 WebApi Server。 （請注意 Bearer後再先接著一個空白字元再加上 Token值）\n再次執行　“WeatherForecast” 的測試(Execute)　就可正常的取得回傳值了\n加入 git 版本控制 $ git commit -m \"finished JWT function\" -a 使用　aspnet-codegenerator　工具來自動産生程式碼 最後我們來看看如何使用工具來自動産生程式去維護一個新的資料表\n在 Models 目錄下新增一個 model(模型) class - TodoList 使用 dotnet cli 來新增一個 class\n$ dotnet new class -o Models -n TodoList 産生出來的空的程式框架：\n將 Models/TodoList.cs 補齊欄位設定\n1 2 3 4 5 6 7 8  namespace dotnet7_webapi_jwt.Models; public class TodoList { public int Id { get; set; } public string? Title { get; set; } public string? Details { get; set; } public bool Done { get; set; } }   在 ApiDbContext.cs 中宣告一個 TodoList table public DbSet? TodoList { get; set; } #放在程式最後面 新增一個遷移與更新資料庫 $ dotnet build $ dotnet ef migrations add \"Add New Table - TodoList\" $ dotnet ef database update 註：｀$ dotnet ef migrations remove｀ 可移除最後一個 migration\n使用 ASPNET Codegenerator 自動產生 Todo Controller $ dotnet aspnet-codegenerator controller -name TodoController -async -api -m TodoList -dc ApiDbContext -outDir Controllers Building project ... Finding the generator 'controller'... Running the generator 'controller'... Minimal hosting scenario! Attempting to compile the application in memory. Attempting to figure out the EntityFramework metadata for the model and DbContext: 'TodoList' Using database provider 'Npgsql.EntityFrameworkCore.PostgreSQL'! Added Controller : '/Controllers/TodoController.cs'. RunTime 00:00:08.68 TodoController.cs\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125  using System; using System.Collections.Generic; using System.Linq; using System.Threading.Tasks; using Microsoft.AspNetCore.Http; using Microsoft.AspNetCore.Mvc; using Microsoft.EntityFrameworkCore; using dotnet7_webapi_jwt; using dotnet7_webapi_jwt.Data; namespace dotnet7_webapi_jwt.Controllers { [Route(\"api/[controller]\")] [ApiController] public class TodoController : ControllerBase { private readonly ApiDbContext _context; public TodoController(ApiDbContext context) { _context = context; } // GET: api/Todo [HttpGet] public async Task GetTodoList() { if (_context.TodoList == null) { return NotFound(); } return await _context.TodoList.ToListAsync(); } // GET: api/Todo/5 [HttpGet(\"{id}\")] public async Task GetTodoList(int id) { if (_context.TodoList == null) { return NotFound(); } var todoList = await _context.TodoList.FindAsync(id); if (todoList == null) { return NotFound(); } return todoList; } // PUT: api/Todo/5  // To protect from overposting attacks, see https://go.microsoft.com/fwlink/?linkid=2123754 [HttpPut(\"{id}\")] public async Task PutTodoList(int id, TodoList todoList) { if (id != todoList.Id) { return BadRequest(); } _context.Entry(todoList).State = EntityState.Modified; try { await _context.SaveChangesAsync(); } catch (DbUpdateConcurrencyException) { if (!TodoListExists(id)) { return NotFound(); } else { throw; } } return NoContent(); } // POST: api/Todo  // To protect from overposting attacks, see https://go.microsoft.com/fwlink/?linkid=2123754 [HttpPost] public async Task PostTodoList(TodoList todoList) { if (_context.TodoList == null) { return Problem(\"Entity set 'ApiDbContext.TodoList' is null.\"); } _context.TodoList.Add(todoList); await _context.SaveChangesAsync(); return CreatedAtAction(\"GetTodoList\", new { id = todoList.Id }, todoList); } // DELETE: api/Todo/5 [HttpDelete(\"{id}\")] public async Task DeleteTodoList(int id) { if (_context.TodoList == null) { return NotFound(); } var todoList = await _context.TodoList.FindAsync(id); if (todoList == null) { return NotFound(); } _context.TodoList.Remove(todoList); await _context.SaveChangesAsync(); return NoContent(); } private bool TodoListExists(int id) { return (_context.TodoList?.Any(e = e.Id == id)).GetValueOrDefault(); } } }   測試新功能 在 open api - swagger 網頁上透過 POST 的 EndPoint 新增一筆 Toto list\n送出新增的資料，回覆新增成功\n由資料庫中可以查詢到新建立的 record\n!透過 GET 的 EndPoint 也可以查詢到新增 Toto list\n以上可以發現使用 ASPNET Codegenerator 自動産生的程式就可簡單的完成資料表格的新增、查詢、修改、刪除等日常功能，真是方便呢！\nCORS 議題 Web App 與 Web Api Server 若處於“不同源”時，當 App 使用 http request 呼叫 Web Api Server 上端點時就會有“同源策略“的問題，這個狀況在測試環境中尤為明顯。 要解決這個問題就必須透過 CORS (Cross-Origin Resource Sharing) 相關設定來應對。在 DotNet Core 中設定相關簡易，僅須在 Program.cs 中加入以下二段程式碼即可：\n以下程式碼放在 “builder.Services.AddControllers();” 之前：\n1 2 3 4 5 6 7 8 9  var MyAllOrigins = \"allowAll\"; builder.Services.AddCors(option = option.AddPolicy(name: MyAllOrigins, policy = { policy.WithOrigins(\"http://localhost:4200\").AllowAnyMethod().AllowAnyHeader(); } ) );   以及\n以下程式碼放在 “app.UseHttpsRedirection();” 之前：\napp.UseCors(MyAllOrigins); 完成後，當前端 Web App (如： angular 在測試環境下預設是使用 localhost:4200) 使用 http request 呼叫後端 Web Api (本例中 Web Api 使用的是 localhost:5023) 時就可避到同源策略的要求。\nProgram.cs 完整程式碼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113  using System.Text; using dotnet7_webapi_jwt.Data; using Microsoft.AspNetCore.Authentication.JwtBearer; using Microsoft.AspNetCore.Identity; using Microsoft.EntityFrameworkCore; using Microsoft.IdentityModel.Tokens; using Microsoft.OpenApi.Models; var builder = WebApplication.CreateBuilder(args); ConfigurationManager _configuration = builder.Configuration; var secret = _configuration.GetValuestring(\"JwtSettings:Secret\"); // Add services to the container. builder.Services.AddDbContext( options = options.UseNpgsql( _configuration.GetConnectionString(\"ConnStr\") ) ); builder.Services.AddIdentity() .AddEntityFrameworkStores() .AddDefaultTokenProviders(); builder.Services.AddAuthentication(options = { options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme; options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme; options.DefaultScheme = JwtBearerDefaults.AuthenticationScheme; }) .AddJwtBearer(options = { // 當驗證失敗時，回應標頭會包含 WWW-Authenticate 標頭，這裡會顯示失敗的詳細錯誤原因  options.IncludeErrorDetails = true; // 預設值為 true，有時會特別關閉  options.TokenValidationParameters = new TokenValidationParameters { // 透過這項宣告，就可以從 \"NAME\" 取值  NameClaimType = \"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier\", // 透過這項宣告，就可以從 \"Role\" 取值，並可讓 [Authorize] 判斷角色  RoleClaimType = \"http://schemas.microsoft.com/ws/2008/06/identity/claims/role\", // 驗證 Issuer (一般都會)  ValidateIssuer = true, ValidIssuer = _configuration.GetValuestring(\"JwtSettings:ValidIssuer\"), // 驗證 Audience (通常不太需要)  ValidateAudience = false, //ValidAudience = = _configuration.GetValue(\"JwtSettings:ValidAudience\"),  // 驗證 Token 的有效期間 (一般都會)  ValidateLifetime = true, // 如果 Token 中包含 key 才需要驗證，一般都只有簽章而已  ValidateIssuerSigningKey = false, // 應該從 IConfiguration 取得  IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secret)) }; }); var allOrigins = \"allowAll\"; builder.Services.AddCors(option = option.AddPolicy(name: allOrigins, policy = { policy.WithOrigins(\"http://localhost:4200\").AllowAnyMethod().AllowAnyHeader(); } ) ); builder.Services.AddControllers(); // Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle builder.Services.AddEndpointsApiExplorer(); builder.Services.AddSwaggerGen(c = { c.SwaggerDoc(\"v1\", new OpenApiInfo { Title = \"JwtDemo\", Version = \"v1\" }); c.AddSecurityDefinition(\"Bearer\", new OpenApiSecurityScheme { In = ParameterLocation.Header, Description = \"Please enter JWT with Bearer into field\", Name = \"Authorization\", Type = SecuritySchemeType.ApiKey }); c.AddSecurityRequirement(new OpenApiSecurityRequirement { { new OpenApiSecurityScheme { Reference = new OpenApiReference { Type = ReferenceType.SecurityScheme, Id = \"Bearer\"} }, new string[] {} } }); }); var app = builder.Build(); // Configure the HTTP request pipeline. if (app.Environment.IsDevelopment()) { app.UseSwagger(); app.UseSwaggerUI(); } app.UseHttpsRedirection(); app.UseCors(allOrigins); app.UseAuthentication(); app.UseAuthorization(); app.MapControllers(); app.Run();   ","wordCount":"3254","inLanguage":"en","datePublished":"2023-03-06T00:00:00Z","dateModified":"2023-03-06T00:00:00Z","author":{"@type":"Person","name":"Theme PaperMod"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://calvinegs.github.io/posts/dotnet7-webapi-jwt/"},"publisher":{"@type":"Organization","name":"永誌不忘 • 筆記簿","logo":{"@type":"ImageObject","url":"https://calvinegs.github.io/img/favicon.png"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://calvinegs.github.io/ accesskey=h title="永誌不忘 • 筆記簿 (Alt + H)">永誌不忘 • 筆記簿</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://calvinegs.github.io/posts/ title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://calvinegs.github.io/archives/ title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://calvinegs.github.io/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://calvinegs.github.io/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://calvinegs.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://calvinegs.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://calvinegs.github.io/posts/>Posts</a></div>
<h1 class=post-title>
使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料）
</h1>
<div class=post-description>
本篇將要紀錄如何使用　.NET 7.0 來建立 一個可方便擴展 Web API
</div>
<div class=post-meta><span title="2023-03-06 00:00:00 +0000 UTC">March 6, 2023</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;Theme PaperMod&nbsp;|&nbsp;<a href=https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/posts/dotnet7-webapi-jwt.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#%e5%b0%88%e6%a1%88%e5%ae%8c%e6%88%90%e5%be%8c%e7%9a%84%e6%aa%94%e6%a1%88%e7%b5%90%e6%a7%8b aria-label=專案完成後的檔案結構>專案完成後的檔案結構</a></li>
<li>
<a href=#%e5%b0%88%e6%a1%88%e5%ae%8c%e6%88%90%e5%be%8c%e6%89%80%e6%8f%90%e4%be%9b%e7%9a%84-api-%e7%ab%af%e9%bb%9e aria-label="專案完成後所提供的 API 端點">專案完成後所提供的 API 端點</a></li>
<li>
<a href=#%e5%bb%ba%e7%bd%ae%e6%96%b0%e5%b0%88%e6%a1%88 aria-label=建置新專案>建置新專案</a><ul>
<li>
<a href=#dotnet-%e7%89%88%e6%9c%ac%e7%ae%a1%e7%90%86%e6%aa%a2%e6%9f%a5 aria-label="dotnet 版本管理檢查">dotnet 版本管理檢查</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-dotnet-cli-%e5%bb%ba%e7%ab%8b%e6%96%b0%e5%b0%88%e6%a1%88 aria-label="使用 dotnet cli 建立新專案">使用 dotnet cli 建立新專案</a></li>
<li>
<a href=#dotnet-%e7%89%88%e6%9c%ac%e7%ae%a1%e7%90%86 aria-label="dotnet 版本管理">dotnet 版本管理</a></li>
<li>
<a href=#%e7%89%88%e6%9c%ac%e6%8e%a7%e7%ae%a1 aria-label=版本控管>版本控管</a></li>
<li>
<a href=#%e5%ae%89%e8%a3%9d%e6%9c%ac%e6%a9%9f%e5%b7%a5%e5%85%b7 aria-label=安裝本機工具>安裝本機工具</a></li>
<li>
<a href=#%e5%ae%89%e8%a3%9d%e7%a8%8b%e5%bc%8f%e4%bd%bf%e7%94%a8%e7%9a%84%e7%9b%b8%e9%97%9c%e5%a5%97%e4%bb%b6 aria-label=安裝程式使用的相關套件>安裝程式使用的相關套件</a></li>
<li>
<a href=#%e5%bb%ba%e7%ab%8b-git-%e6%96%b0%e7%89%88%e6%9c%ac aria-label="建立 git 新版本">建立 git 新版本</a></li></ul>
</li>
<li>
<a href=#%e5%9f%b7%e8%a1%8c%e7%a8%8b%e5%bc%8f aria-label=執行程式>執行程式</a></li>
<li>
<a href=#%e8%a8%ad%e7%bd%ae%e4%bd%bf%e7%94%a8-entity-framework%e7%9b%b8%e9%97%9c%e8%a8%ad%e5%ae%9a aria-label="設置使用 Entity Framework相關設定">設置使用 Entity Framework相關設定</a><ul>
<li>
<a href=#%e6%96%b0%e5%a2%9e-database-context-%e8%87%aa%e5%8b%95%e7%94%a2%e7%94%9f aria-label="新增 database context (自動產生)">新增 database context (自動產生)</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-aspnet-core-identity-framework-%e4%be%86%e7%ae%a1%e7%90%86%e4%bd%bf%e7%94%a8%e8%80%85%e4%bd%bf%e7%94%a8%e6%ac%8a%e9%99%90 aria-label="使用 Asp.Net Core Identity framework 來管理使用者使用權限">使用 Asp.Net Core Identity framework 來管理使用者使用權限</a></li>
<li>
<a href=#%e5%b0%87%e7%9b%b8%e9%97%9c-aspnet-core-identity-framework-%e5%8a%9f%e8%83%bd%e6%b3%a8%e5%85%a5%e5%88%b0-container-%e4%b8%ad aria-label="將相關 Asp.Net Core Identity framework 功能注入到 container 中">將相關 Asp.Net Core Identity framework 功能注入到 container 中</a></li>
<li>
<a href=#%e6%96%b0%e5%a2%9e%e4%b8%80%e5%80%8b-entity-framework-%e9%81%b7%e7%a7%bb-%e4%b8%a6-%e6%9b%b4%e6%96%b0%e8%b3%87%e6%96%99%e5%ba%ab aria-label="新增一個 entity framework 遷移 並 更新資料庫">新增一個 entity framework 遷移 並 更新資料庫</a></li>
<li>
<a href=#%e5%bb%ba%e7%ab%8b-git-%e6%96%b0%e7%89%88%e6%9c%ac-1 aria-label="建立 git 新版本">建立 git 新版本</a></li></ul>
</li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-jason-web-token aria-label="使用 Jason Web Token">使用 Jason Web Token</a><ul>
<li>
<a href=#%e5%9c%a8-appsettingsjson-%e4%b8%ad%e8%87%aa%e5%ae%9ajwt%e5%af%a6%e4%bd%9c%e6%9c%83%e4%bd%bf%e7%94%a8%e5%88%b0%e7%9a%84%e8%a8%ad%e5%ae%9a%e5%80%bc aria-label="在 appsettings.json 中自定JWT實作會使用到的設定值">在 appsettings.json 中自定JWT實作會使用到的設定值</a></li>
<li>
<a href=#%e6%96%b0%e5%a2%9e-%e4%bd%bf%e7%94%a8%e8%80%85%e8%a8%bb%e5%86%8a%e5%92%8c%e7%99%bb%e5%85%a5%e6%99%82%e4%bd%bf%e7%94%a8%e7%9a%84-data-model-class-modelsauthenticatedatacs aria-label="新增 使用者註冊和登入時使用的 Data model class (Models/AuthenticateData.cs)">新增 使用者註冊和登入時使用的 Data model class (Models/AuthenticateData.cs)</a></li>
<li>
<a href=#%e6%96%b0%e5%a2%9e-%e8%a8%bb%e5%86%8a%e5%92%8c%e7%99%bb%e5%85%a5%e9%82%8f%e8%bc%af-controllersauthenticatecontrollcs aria-label="新增 註冊和登入邏輯 (Controllers/AuthenticateControll.cs)">新增 註冊和登入邏輯 (Controllers/AuthenticateControll.cs)</a></li></ul>
</li>
<li>
<a href=#%e6%9c%89%e9%97%9c%e5%af%a6%e4%bd%9c-jwt-%e7%9a%84%e6%b5%81%e7%a8%8b aria-label="有關實作 JWT 的流程">有關實作 JWT 的流程</a><ul>
<li>
<a href=#%e7%94%a3%e7%94%9f%e5%90%88%e6%b3%95%e7%9a%84-jason-web-token aria-label="産生合法的 Jason Web Token">産生合法的 Jason Web Token</a></li>
<li>
<a href=#%e8%a8%ad%e7%bd%ae%e9%a9%97%e8%ad%89%e6%98%af%e5%90%a6%e7%82%ba%e5%90%88%e6%b3%95%e6%9c%89%e6%95%88%e7%9a%84-jwt-token aria-label="設置驗證是否為合法有效的 JWT Token">設置驗證是否為合法有效的 JWT Token</a></li>
<li>
<a href=#%e5%9c%a8%e7%89%b9%e5%ae%9a-api-endpoint-%e4%b8%8a%e9%a9%97%e8%ad%89%e6%98%af%e5%90%a6%e5%b8%b6%e6%9c%89%e5%90%88%e6%b3%95%e6%9c%89%e6%95%88%e7%9a%84-jwt-token aria-label="在特定 API EndPoint 上驗證是否帶有合法有效的 JWT Token">在特定 API EndPoint 上驗證是否帶有合法有效的 JWT Token</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-openapi-swagger-%e4%be%86%e6%b8%ac%e8%a9%a6-api aria-label="使用 OpenApi Swagger 來測試 API">使用 OpenApi Swagger 來測試 API</a></li>
<li>
<a href=#%e5%8a%a0%e5%85%a5-git-%e7%89%88%e6%9c%ac%e6%8e%a7%e5%88%b6 aria-label="加入 git 版本控制">加入 git 版本控制</a></li></ul>
</li>
<li>
<a href=#%e4%bd%bf%e7%94%a8aspnet-codegenerator%e5%b7%a5%e5%85%b7%e4%be%86%e8%87%aa%e5%8b%95%e7%94%a3%e7%94%9f%e7%a8%8b%e5%bc%8f%e7%a2%bc aria-label=使用　aspnet-codegenerator　工具來自動産生程式碼>使用　aspnet-codegenerator　工具來自動産生程式碼</a><ul>
<li>
<a href=#%e5%9c%a8-models-%e7%9b%ae%e9%8c%84%e4%b8%8b%e6%96%b0%e5%a2%9e%e4%b8%80%e5%80%8b-model%e6%a8%a1%e5%9e%8b-class---todolist aria-label="在 Models 目錄下新增一個 model(模型) class - TodoList">在 Models 目錄下新增一個 model(模型) class - TodoList</a></li>
<li>
<a href=#%e5%9c%a8-apidbcontextcs-%e4%b8%ad%e5%ae%a3%e5%91%8a%e4%b8%80%e5%80%8b-todolist-table aria-label="在 ApiDbContext.cs 中宣告一個 TodoList table">在 ApiDbContext.cs 中宣告一個 TodoList table</a></li>
<li>
<a href=#%e6%96%b0%e5%a2%9e%e4%b8%80%e5%80%8b%e9%81%b7%e7%a7%bb%e8%88%87%e6%9b%b4%e6%96%b0%e8%b3%87%e6%96%99%e5%ba%ab aria-label=新增一個遷移與更新資料庫>新增一個遷移與更新資料庫</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-aspnet-codegenerator-%e8%87%aa%e5%8b%95%e7%94%a2%e7%94%9f-todo-controller aria-label="使用 ASPNET Codegenerator 自動產生 Todo Controller">使用 ASPNET Codegenerator 自動產生 Todo Controller</a></li>
<li>
<a href=#%e6%b8%ac%e8%a9%a6%e6%96%b0%e5%8a%9f%e8%83%bd aria-label=測試新功能>測試新功能</a></li></ul>
</li>
<li>
<a href=#cors-%e8%ad%b0%e9%a1%8c aria-label="CORS 議題">CORS 議題</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p><em><a href=https://github.com/calvinegs/dotnet7-webapi-jwt.git>github Source code</a></em></p>
<p>本文將記錄如何一步步從無到有，使用 Dotnet Core 7.0 建立 ASP.NET Core Web API，其中將會使用到下列技術:</p>
<ul>
<li>Dotnet CLI</li>
<li>Entity Framework 7.0</li>
<li>Json Web Token</li>
<li>PostgreSQL DB (Docker Version)</li>
<li>ASP.NET Core Generator</li>
</ul>
<h2 id=專案完成後的檔案結構>專案完成後的檔案結構<a hidden class=anchor aria-hidden=true href=#專案完成後的檔案結構>#</a></h2>
<pre tabindex=0><code>./專案目錄
├── .config/
│   └── dotnet-tools.json
├── .vscode/
│   ├── launch.js
│   └── tasks.json
├── Controller/
│   ├── AuthenticateController.cs
│   ├── TodoController.cs
│   └── WeatherForecast.cs
├── Data/
│   └── ApiDbContext.cs
├── Migrations/
├── Models/
│   ├── AuthenticateData.cs
│   └── TodoList.cs
├── obj/
├── Properties/
│   └── launchSettings.json
├── .gitignore
├── appsettings.Development.json
├── appsettings.json
├── dotnet7-webapi-jwt.csproj
├── global.json
├── Program.cs
├── README.md
└── WeatherForecast.cs
</code></pre><h2 id=專案完成後所提供的-api-端點>專案完成後所提供的 API 端點<a hidden class=anchor aria-hidden=true href=#專案完成後所提供的-api-端點>#</a></h2>
<table>
<thead>
<tr>
<th>Methods</th>
<th>Urls</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/api/Authenticate/login</td>
<td>註冊新使用者帳號</td>
</tr>
<tr>
<td>POST</td>
<td>/api/Authenticate/register</td>
<td>使用者帳號登入</td>
</tr>
<tr>
<td>POST</td>
<td>/api/Authenticate/register-admin</td>
<td>管理者帳號登入</td>
</tr>
<tr>
<td>GET</td>
<td>/api/Todos</td>
<td>get all Todos</td>
</tr>
<tr>
<td>POST</td>
<td>/api/Todos</td>
<td>add New Todo</td>
</tr>
<tr>
<td>GET</td>
<td>/api/Todos/:id</td>
<td>get Todo by id</td>
</tr>
<tr>
<td>PUT</td>
<td>/api/Todos/:id</td>
<td>update Todo by id</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/Todos/:id</td>
<td>remove Todo by id</td>
</tr>
</tbody>
</table>
<h2 id=建置新專案>建置新專案<a hidden class=anchor aria-hidden=true href=#建置新專案>#</a></h2>
<h3 id=dotnet-版本管理檢查>dotnet 版本管理檢查<a hidden class=anchor aria-hidden=true href=#dotnet-版本管理檢查>#</a></h3>
<p>你的 Local 可能已安裝了多個版本的 dotnet 環境，使用以下指令來檢查目前的 dotnet 版本</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet --version  <span style=color:#75715e># 顯示目前所使用的版本</span>
7.0.201 <span style=color:#75715e># 預設是最新的版本</span>
</code></pre></div><h3 id=使用-dotnet-cli-建立新專案>使用 dotnet cli 建立新專案<a hidden class=anchor aria-hidden=true href=#使用-dotnet-cli-建立新專案>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet new webapi -o dotnet7-webapi-jwt
歡迎使用 .NET 7.0!
---------------------
SDK 版本: 7.0.201

遙測
---------
.NET 工具會收集使用資料，協助我們改進您的體驗。資料會由 Microsoft 收集，並分享給社群使用。您可以選擇退出遙測，只要使用您慣用的殼層，將 DOTNET_CLI_TELEMETRY_OPTOUT 環境變數設定為 <span style=color:#e6db74>&#39;1&#39;</span> 或 <span style=color:#e6db74>&#39;true&#39;</span> 即可。

閱讀更多有關 .NET CLI 工具遙測的內容: https://aka.ms/dotnet-cli-telemetry

----------------
已安裝 ASP.NET Core HTTPS 開發憑證。
若要信任憑證，請執行 <span style=color:#e6db74>&#39;dotnet dev-certs https --trust&#39;</span> <span style=color:#f92672>(</span>僅限 Windows 與 macOS <span style=color:#f92672>)</span>。
深入了解 HTTPS: https://aka.ms/dotnet-https
----------------
撰寫第一個應用程式: https://aka.ms/dotnet-hello-world
了解全新功能: https://aka.ms/dotnet-whats-new
探索文件: https://aka.ms/dotnet-docs
於 GitHub 回報問題和尋找來源: https://github.com/dotnet/core
Use <span style=color:#e6db74>&#39;dotnet --help&#39;</span> 查看可用的命令或瀏覽: https://aka.ms/dotnet-cli
--------------------------------------------------------------------------------------
範本「ASP.NET Core Web API」已成功建立。

正在處理建立後的動作...
正在還原 /home/egs/cal-data/Sources/nhis/dotnet7-webapi-jwt/dotnet7-webapi-jwt.csproj:
  正在判斷要還原的專案...
  已還原 /home/egs/cal-data/Sources/nhis/dotnet7-webapi-jwt/dotnet7-webapi-jwt.csproj <span style=color:#f92672>(</span>4.93 sec 內<span style=color:#f92672>)</span>。
還原成功。
</code></pre></div><p>新專案</p>
<pre tabindex=0><code>$ cd dotnet7-webapi-jwt
$ ls -al
總用量 40
drwxrwxr-x 5 egs egs 4096  3月  6 10:23 .
drwxrwxr-x 5 egs egs 4096  3月  6 10:22 ..
-rw-rw-r-- 1 egs egs  127  3月  6 10:22 appsettings.Development.json
-rw-rw-r-- 1 egs egs  151  3月  6 10:22 appsettings.json
drwxrwxr-x 2 egs egs 4096  3月  6 10:22 Controllers
-rw-rw-r-- 1 egs egs  463  3月  6 10:22 dotnet7-webapi-jwt.csproj
drwxrwxr-x 2 egs egs 4096  3月  6 10:23 obj
-rw-rw-r-- 1 egs egs  557  3月  6 10:22 Program.cs
drwxrwxr-x 2 egs egs 4096  3月  6 10:22 Properties
-rw-rw-r-- 1 egs egs  267  3月  6 10:22 WeatherForecast.cs
</code></pre><h3 id=dotnet-版本管理>dotnet 版本管理<a hidden class=anchor aria-hidden=true href=#dotnet-版本管理>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet --list-sdks    <span style=color:#75715e># 顯示已安裝的 sdk 版本資訊</span>
5.0.408 <span style=color:#f92672>[</span>/usr/share/dotnet/sdk<span style=color:#f92672>]</span>
6.0.406 <span style=color:#f92672>[</span>/usr/share/dotnet/sdk<span style=color:#f92672>]</span>
7.0.201 <span style=color:#f92672>[</span>/usr/share/dotnet/sdk<span style=color:#f92672>]</span>

$ dotnet --list-runtimes
Microsoft.AspNetCore.App 5.0.17 <span style=color:#f92672>[</span>/usr/share/dotnet/shared/Microsoft.AspNetCore.App<span style=color:#f92672>]</span>
Microsoft.AspNetCore.App 6.0.14 <span style=color:#f92672>[</span>/usr/share/dotnet/shared/Microsoft.AspNetCore.App<span style=color:#f92672>]</span>
Microsoft.AspNetCore.App 7.0.3 <span style=color:#f92672>[</span>/usr/share/dotnet/shared/Microsoft.AspNetCore.App<span style=color:#f92672>]</span>
Microsoft.NETCore.App 5.0.17 <span style=color:#f92672>[</span>/usr/share/dotnet/shared/Microsoft.NETCore.App<span style=color:#f92672>]</span>
Microsoft.NETCore.App 6.0.14 <span style=color:#f92672>[</span>/usr/share/dotnet/shared/Microsoft.NETCore.App<span style=color:#f92672>]</span>
Microsoft.NETCore.App 7.0.3 <span style=color:#f92672>[</span>/usr/share/dotnet/shared/Microsoft.NET# .App<span style=color:#f92672>]</span>
</code></pre></div><p>由於 dotnet 版本演化滿快的，所以會建議在專案目錄中要指定使用 SDK 的版本，以免當你又安裝了更新的版本（如8.0）後程式執行出問題。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet new globaljson --sdk-version 7.0.201
範本「global.json 檔案」已成功建立。

$ cat global.json
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;sdk&#34;</span>: <span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;7.0.201&#34;</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=版本控管>版本控管<a hidden class=anchor aria-hidden=true href=#版本控管>#</a></h3>
<p>使用 dotnet cli 來產生預設的 git ignore 檔案</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet new gitignore
</code></pre></div><p>建立 git 初始版本</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ git init <span style=color:#f92672>&amp;&amp;</span> git add . <span style=color:#f92672>&amp;&amp;</span> git commit -m <span style=color:#e6db74>&#34;Initial commit&#34;</span>
</code></pre></div><h3 id=安裝本機工具>安裝本機工具<a hidden class=anchor aria-hidden=true href=#安裝本機工具>#</a></h3>
<p>此方式安裝的工具，僅限本機存取(只針對目前的目錄和子目錄)， 首先透過 dotnet new tool-manifest 命令來產生工具資訊清單檔，再使用 dotnet tool install 來安裝各式工具程式。這樣的方式好處是在專案若多人協助方式時，則可利用 dotnet tool restore 命令將紀錄在 ./.config/dotnet-tools.json 的工具資訊清單檔重建在不同協助人員的電腦中。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet new tool-manifest <span style=color:#75715e>#會產生 .config/dotnet-tools.json 檔案</span>
$ dotnet tool install --local dotnet-ef <span style=color:#75715e>#使用 local 安裝方式來安裝 Entity Framework 工具</span>
您可使用下列命令，從此目錄叫用工具: <span style=color:#e6db74>&#39;dotnet tool run dotnet-ef&#39;</span> 或 <span style=color:#e6db74>&#39;dotnet dotnet-ef&#39;</span>。
已成功安裝工具 <span style=color:#e6db74>&#39;dotnet-ef&#39;</span> <span style=color:#f92672>(</span>版本 <span style=color:#e6db74>&#39;7.0.3&#39;</span><span style=color:#f92672>)</span>。項目已新增至資訊清單檔 /home/egs/cal-data/Sources/nhis/dotnet7-webapi-jwt/.config/dotnet-tools.json。

$ dotnet tool install --local dotnet-aspnet-codegenerator <span style=color:#75715e>#使用 local 安裝方式來安裝 Code Generator 工具</span>
您可使用下列命令，從此目錄叫用工具: <span style=color:#e6db74>&#39;dotnet tool run dotnet-aspnet-codegenerator&#39;</span> 或 <span style=color:#e6db74>&#39;dotnet dotnet-aspnet-codegenerator&#39;</span>。
已成功安裝工具 <span style=color:#e6db74>&#39;dotnet-aspnet-codegenerator&#39;</span> <span style=color:#f92672>(</span>版本 <span style=color:#e6db74>&#39;7.0.4&#39;</span><span style=color:#f92672>)</span>。項目已新增至資訊清單檔 /home/egs/cal-data/Sources/nhis/dotnet7-webapi-jwt/.config/dotnet-tools.json。

$ cat ./.config/dotnet-tools.json 
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;version&#34;</span>: 1,
  <span style=color:#e6db74>&#34;isRoot&#34;</span>: true,
  <span style=color:#e6db74>&#34;tools&#34;</span>: <span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;dotnet-ef&#34;</span>: <span style=color:#f92672>{</span>
      <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;7.0.3&#34;</span>,
      <span style=color:#e6db74>&#34;commands&#34;</span>: <span style=color:#f92672>[</span>
        <span style=color:#e6db74>&#34;dotnet-ef&#34;</span>
      <span style=color:#f92672>]</span>
    <span style=color:#f92672>}</span>,
    <span style=color:#e6db74>&#34;dotnet-aspnet-codegenerator&#34;</span>: <span style=color:#f92672>{</span>
      <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;7.0.4&#34;</span>,
      <span style=color:#e6db74>&#34;commands&#34;</span>: <span style=color:#f92672>[</span>
        <span style=color:#e6db74>&#34;dotnet-aspnet-codegenerator&#34;</span>
      <span style=color:#f92672>]</span>
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=安裝程式使用的相關套件>安裝程式使用的相關套件<a hidden class=anchor aria-hidden=true href=#安裝程式使用的相關套件>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet add package Microsoft.EntityFrameworkCore.Tools <span style=color:#75715e>#使用 dotnet Entity Framework 時必須安裝此套件</span>
$ dotnet add package Microsoft.EntityFrameworkCore.Design <span style=color:#75715e>#使用 dotnet Entity Framework 時必須安裝此套件</span>

$ dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore <span style=color:#75715e>#使用 Identity Framework 時必須安裝此套件</span>
$ dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL <span style=color:#75715e>#使用 PostgreSQL DB 當後端資料庫須安裝此套件</span>
$ dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer <span style=color:#75715e>#要使用 Token Base 權限管理須安裝此套件</span>

$ dotnet add package Microsoft.EntityFrameworkCore.SqlServer <span style=color:#75715e>#使用 dotnet aspnet-codegenerator 時必須安裝此套件 </span>
$ dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design <span style=color:#75715e>#搭配 dotnet-aspnet-codegenerator 使用</span>
$ dotnet add package System.Configuration.ConfigurationManager  <span style=color:#75715e>#搭配 dotnet-aspnet-codegenerator 使用</span>
</code></pre></div><p>安裝的程式套件資訊紀錄在 &ldquo;專案&rdquo;.csproj 檔案中</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cat dotnet7-webapi-jwt.csproj <span style=color:#75715e>#查看 安裝套件的相關設定值</span>
</code></pre></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;Project</span> <span style=color:#a6e22e>Sdk=</span><span style=color:#e6db74>&#34;Microsoft.NET.Sdk.Web&#34;</span><span style=color:#f92672>&gt;</span>

  <span style=color:#f92672>&lt;PropertyGroup&gt;</span>
    <span style=color:#f92672>&lt;TargetFramework&gt;</span>net7.0<span style=color:#f92672>&lt;/TargetFramework&gt;</span>
    <span style=color:#f92672>&lt;Nullable&gt;</span>enable<span style=color:#f92672>&lt;/Nullable&gt;</span>
    <span style=color:#f92672>&lt;ImplicitUsings&gt;</span>enable<span style=color:#f92672>&lt;/ImplicitUsings&gt;</span>
    <span style=color:#f92672>&lt;RootNamespace&gt;</span>dotnet7_webapi_jwt<span style=color:#f92672>&lt;/RootNamespace&gt;</span>
  <span style=color:#f92672>&lt;/PropertyGroup&gt;</span>

  <span style=color:#f92672>&lt;ItemGroup&gt;</span>
<span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;PackageReference</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;Microsoft.AspNetCore.Authentication.JwtBearer&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;7.0.3&#34;</span> <span style=color:#f92672>/&gt;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;PackageReference</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;Microsoft.AspNetCore.Identity.entityframeworkCore&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;7.0.3&#34;</span> <span style=color:#f92672>/&gt;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;PackageReference</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;Microsoft.AspNetCore.OpenApi&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;7.0.3&#34;</span> <span style=color:#f92672>/&gt;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;PackageReference</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;Microsoft.EntityFrameworkCore.Design&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;7.0.3&#34;</span><span style=color:#f92672>&gt;</span>
</span>      <span style=color:#f92672>&lt;IncludeAssets&gt;</span>runtime; build; native; contentfiles; analyzers; buildtransitive<span style=color:#f92672>&lt;/IncludeAssets&gt;</span>
      <span style=color:#f92672>&lt;PrivateAssets&gt;</span>all<span style=color:#f92672>&lt;/PrivateAssets&gt;</span>
    <span style=color:#f92672>&lt;/PackageReference&gt;</span>
<span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;PackageReference</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;Microsoft.EntityFrameworkCore.SqlServer&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;7.0.3&#34;</span> <span style=color:#f92672>/&gt;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;PackageReference</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;Microsoft.EntityFrameworkCore.Tools&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;7.0.3&#34;</span><span style=color:#f92672>&gt;</span>
</span>      <span style=color:#f92672>&lt;IncludeAssets&gt;</span>runtime; build; native; contentfiles; analyzers; buildtransitive<span style=color:#f92672>&lt;/IncludeAssets&gt;</span>
      <span style=color:#f92672>&lt;PrivateAssets&gt;</span>all<span style=color:#f92672>&lt;/PrivateAssets&gt;</span>
    <span style=color:#f92672>&lt;/PackageReference&gt;</span>
<span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;PackageReference</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;Microsoft.VisualStudio.Web.codeGeneration.Design&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;7.0.4&#34;</span> <span style=color:#f92672>/&gt;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;PackageReference</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;Npgsql.entityFrameworkCore.PostgreSQL&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;7.0.3&#34;</span> <span style=color:#f92672>/&gt;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;PackageReference</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;Swashbuckle.AspNetCore&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;6.4.0&#34;</span> <span style=color:#f92672>/&gt;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;PackageReference</span> <span style=color:#a6e22e>Include=</span><span style=color:#e6db74>&#34;system.Configuration.ConfigurationManager&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;7.0.0&#34;</span> <span style=color:#f92672>/&gt;</span>
</span>  <span style=color:#f92672>&lt;/ItemGroup&gt;</span>

<span style=color:#f92672>&lt;/Project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id=建立-git-新版本>建立 git 新版本<a hidden class=anchor aria-hidden=true href=#建立-git-新版本>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ git add . <span style=color:#f92672>&amp;&amp;</span> git commit -m <span style=color:#e6db74>&#34;Add EFCore NuGet packages&#34;</span>
</code></pre></div><h2 id=執行程式>執行程式<a hidden class=anchor aria-hidden=true href=#執行程式>#</a></h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet watch
</code></pre></div><p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223012544-e88e0fb2-6d40-4fe5-8233-b9ae9a702912.png alt=image>
</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223012745-4c2b8f14-2bb6-41cd-87e7-3f9ae6362cbd.png alt=image>
</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223012875-d96bf10f-d83e-4991-9220-74306cb08c66.png alt=image>
</p>
<p>打開 VS Code</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ code .
</code></pre></div><p>目前産生的程式架構</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223013649-3ec7ac4a-1ef4-42f6-b127-64a7965ae227.png alt=image>
</p>
<h2 id=設置使用-entity-framework相關設定>設置使用 Entity Framework相關設定<a hidden class=anchor aria-hidden=true href=#設置使用-entity-framework相關設定>#</a></h2>
<h3 id=新增-database-context-自動產生>新增 database context (自動產生)<a hidden class=anchor aria-hidden=true href=#新增-database-context-自動產生>#</a></h3>
<p>使用 dotnet ef 工具在專案目錄 ./Data 子目錄下新建立一個 ApiDbContext.cs 的 DB Context file</p>
<p>註：在使用前先把 後端資料庫 環境備妥，安裝 PostGreSQL DB 可參考此篇筆紀　<em><a href=https://calvinegs.github.io/posts/docker-postgres-pgadmin/>使用 Docker 執行 PostgresSQL </a></em></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet ef dbcontext scaffold <span style=color:#e6db74>&#34;User ID =docker;Password=docker;Server=localhost;Port=5432;Database=pg_testdb; Integrated Security=true;Pooling=true&#34;</span> Npgsql.entityFrameworkCore.PostgreSQL -c ApiDbContext -o Data

Build started...
Build succeeded.
To protect potentially sensitive information in your connection string, you should move it out of source code. You can avoid scaffolding the connection string by using the Name<span style=color:#f92672>=</span> syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid<span style=color:#f92672>=</span>2131148. For more guidance on storing connection strings, see http://go.microsoft.com/fwlink/?LinkId<span style=color:#f92672>=</span>723263.
</code></pre></div><p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223016661-69c446de-4f58-4eaf-af8d-8718b72cfd76.png alt=image>
</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>using</span> System;
<span style=color:#66d9ef>using</span> System.Collections.Generic;
<span style=color:#66d9ef>using</span> Microsoft.EntityFrameworkCore;

<span style=color:#66d9ef>namespace</span> dotnet7_webapi_jwt.Data;

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>partial</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ApiDbContext</span> : DbContext
{
    <span style=color:#66d9ef>public</span> ApiDbContext()
    {
    }

    <span style=color:#66d9ef>public</span> ApiDbContext(DbContextOptions&lt;ApiDbContext&gt; options)
        : <span style=color:#66d9ef>base</span>(options)
    {
    }

    <span style=color:#75715e>// protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
</span><span style=color:#75715e></span>    <span style=color:#75715e>//     =&gt; optionsBuilder.UseNpgsql(&#34;User ID =docker;Password=docker;Server=localhost;Port=5432;Database=pg_testdb; Integrated Security=true;Pooling=true&#34;);
</span><span style=color:#75715e></span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> OnModelCreating(ModelBuilder modelBuilder)
    {
        OnModelCreatingPartial(modelBuilder);
    }

    <span style=color:#66d9ef>partial</span> <span style=color:#66d9ef>void</span> OnModelCreatingPartial(ModelBuilder modelBuilder);
}
</code></pre></div><p>在 appsettings.json 檔案中加入 Connection String</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;Logging&#34;</span>: <span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;LogLevel&#34;</span>: <span style=color:#f92672>{</span>
      <span style=color:#e6db74>&#34;Default&#34;</span>: <span style=color:#e6db74>&#34;Information&#34;</span>,
      <span style=color:#e6db74>&#34;Microsoft.AspNetCore&#34;</span>: <span style=color:#e6db74>&#34;Warning&#34;</span>
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>,
  <span style=color:#e6db74>&#34;AllowedHosts&#34;</span>: <span style=color:#e6db74>&#34;*&#34;</span>,
  <span style=color:#e6db74>&#34;ConnectionStrings&#34;</span>: <span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;ConnStr&#34;</span>: <span style=color:#e6db74>&#34;User ID =docker;Password=docker;Server=localhost;Port=5432;Database=pg_testdb; Integrated Security=true;Pooling=true&#34;</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=使用-aspnet-core-identity-framework-來管理使用者使用權限>使用 Asp.Net Core Identity framework 來管理使用者使用權限<a hidden class=anchor aria-hidden=true href=#使用-aspnet-core-identity-framework-來管理使用者使用權限>#</a></h3>
<p>ASP.NET Core Identity:</p>
<ul>
<li>支援使用者介面 (UI) 登入功能的 API。</li>
<li>管理使用者、密碼、設定檔資料、角色、宣告、權杖、電子郵件確認等。</li>
</ul>
<p>ASP.Net Core Identity Framework 是一個方便且還完善的使用權限管理架構。</p>
<h3 id=將相關-aspnet-core-identity-framework-功能注入到-container-中>將相關 Asp.Net Core Identity framework 功能注入到 container 中<a hidden class=anchor aria-hidden=true href=#將相關-aspnet-core-identity-framework-功能注入到-container-中>#</a></h3>
<p>除了安裝相關套件外，還要調整相關程式:</p>
<ul>
<li>在 Program.cs 檔案中將加入以下程式碼 (before services.AddControllers())</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>ConfigurationManager <span style=color:#ae81ff>_</span>configuration = builder.Configuration;

<span style=color:#75715e>// Add services to the container.
</span><span style=color:#75715e></span>builder.Services.AddDbContext&lt;ApiDbContext&gt;(
    options =&gt; options.UseSqlServer(
        <span style=color:#ae81ff>_</span>configuration.GetConnectionString(<span style=color:#e6db74>&#34;ConnStr&#34;</span>)
    )
);
builder.Services.AddIdentity&lt;IdentityUser, IdentityRole&gt;()
    .AddEntityFrameworkStores&lt;ApiDbContext&gt;()
    .AddDefaultTokenProviders();
</code></pre></div><ul>
<li>使用 AspNetCore Identity，則 DataContext (ApiDbContext.cs 中) 必須要繼承
IdentityDbContext， 同時 Model creationg 時要改成呼叫 base.OnModelCreation</li>
</ul>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>partial</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ApiDbContext</span> : IdentityDbContext&lt;IdentityUser&gt;
</span>{
    <span style=color:#66d9ef>public</span> ApiDbContext()
    {
    }

<span style=color:#75715e>// ...
</span><span style=color:#75715e></span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> OnModelCreating(ModelBuilder modelBuilder)
    {
      <span style=color:#75715e>// OnModelCreatingPartial(modelBuilder);
</span><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#75715e></span>      <span style=color:#66d9ef>base</span>.OnModelCreating(modelBuilder);
</span>    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id=新增一個-entity-framework-遷移-並-更新資料庫>新增一個 entity framework 遷移 並 更新資料庫<a hidden class=anchor aria-hidden=true href=#新增一個-entity-framework-遷移-並-更新資料庫>#</a></h3>
<p>完成上述程式調整後，來執行資料庫遷移(migrations)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet ef migrations add <span style=color:#e6db74>&#34;Add Identity Framework&#34;</span>

Build started...
Build succeeded.
Done. To undo this action, use <span style=color:#e6db74>&#39;ef migrations remove&#39;</span>

$ dotnet ef database update
</code></pre></div><p>在　dotnet ef migrations add &ldquo;Add Identity Framework&rdquo; 指令完成後，可以在專案目錄下發生産生新的子目錄 Migrations，並有三個新檔案</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223018638-a1478c5a-6fff-4959-b339-f74beba970ff.png alt=image>
</p>
<p>在 dotnet ef database update 指令完成後，PostgreSQL pg_testdb 資料庫中產生 Identity Framework 會使用到的資料表</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223018710-dfe253c8-a9b4-43b2-ba04-77d9cf8ad458.png alt=image>
</p>
<h3 id=建立-git-新版本-1>建立 git 新版本<a hidden class=anchor aria-hidden=true href=#建立-git-新版本-1>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ git add . <span style=color:#f92672>&amp;&amp;</span> git commit -m <span style=color:#e6db74>&#34;新增一個 entity framework 遷移 並 更新資料庫&#34;</span>
</code></pre></div><h2 id=使用-jason-web-token>使用 Jason Web Token<a hidden class=anchor aria-hidden=true href=#使用-jason-web-token>#</a></h2>
<h3 id=在-appsettingsjson-中自定jwt實作會使用到的設定值>在 appsettings.json 中自定JWT實作會使用到的設定值<a hidden class=anchor aria-hidden=true href=#在-appsettingsjson-中自定jwt實作會使用到的設定值>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
<span style=color:#75715e>// ...  
</span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;ConnectionStrings&#34;</span>: {
    <span style=color:#f92672>&#34;ConnStr&#34;</span>: <span style=color:#e6db74>&#34;User ID =docker;Password=docker;Server=localhost;Port=5432;Database=pg_testdb; Integrated Security=true;Pooling=true&#34;</span>
  },
  <span style=color:#f92672>&#34;JwtSettings&#34;</span>: {
    <span style=color:#f92672>&#34;ValidIssuer&#34;</span>: <span style=color:#e6db74>&#34;Dotnet7WebApiDemo&#34;</span>,
    <span style=color:#f92672>&#34;ValidAudience&#34;</span>: <span style=color:#e6db74>&#34;Dotnet7WebApiDemo&#34;</span>,
    <span style=color:#f92672>&#34;Secret&#34;</span>: <span style=color:#e6db74>&#34;Dotnet7 WebApi Demo. Using Json Web Token Technology to keep user info.&#34;</span>
  }
}
</code></pre></div><h3 id=新增-使用者註冊和登入時使用的-data-model-class-modelsauthenticatedatacs>新增 使用者註冊和登入時使用的 Data model class (Models/AuthenticateData.cs)<a hidden class=anchor aria-hidden=true href=#新增-使用者註冊和登入時使用的-data-model-class-modelsauthenticatedatacs>#</a></h3>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>using</span> System.ComponentModel.DataAnnotations;

<span style=color:#66d9ef>namespace</span> dotnet7_webapi_jwt.Models;

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Response</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string?</span> Status { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string?</span> Message { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
}

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoginModel</span>
{
<span style=color:#a6e22e>    [EmailAddress]</span>
<span style=color:#a6e22e>    [Required(ErrorMessage = &#34;Eamil Address is required&#34;)]</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string?</span> Email { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [Required(ErrorMessage = &#34;Password is required&#34;)]</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string?</span> Password { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
}

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RegisterModel</span>
{
<span style=color:#a6e22e>    [Required(ErrorMessage = &#34;User Name is required&#34;)]</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string?</span> Username { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [EmailAddress]</span>
<span style=color:#a6e22e>    [Required(ErrorMessage = &#34;Email Address is required&#34;)]</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string?</span> Email { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [Required(ErrorMessage = &#34;Password is required&#34;)]</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string?</span> Password { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
}

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserRoles</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>string</span> Admin = <span style=color:#e6db74>&#34;Admin&#34;</span>;
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>string</span> User = <span style=color:#e6db74>&#34;User&#34;</span>;
}
</code></pre></td></tr></table>
</div>
</div><h3 id=新增-註冊和登入邏輯-controllersauthenticatecontrollcs>新增 註冊和登入邏輯 (Controllers/AuthenticateControll.cs)<a hidden class=anchor aria-hidden=true href=#新增-註冊和登入邏輯-controllersauthenticatecontrollcs>#</a></h3>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>using</span> System.IdentityModel.Tokens.Jwt;
<span style=color:#66d9ef>using</span> System.Security.Claims;
<span style=color:#66d9ef>using</span> System.Text;
<span style=color:#66d9ef>using</span> dotnet7_webapi_jwt.Models;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Identity;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Mvc;
<span style=color:#66d9ef>using</span> Microsoft.IdentityModel.Tokens;

<span style=color:#66d9ef>namespace</span> dotnet7_webapi_jwt.Controllers;
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>[Route(&#34;api/[controller]</span><span style=color:#e6db74>&#34;)]
</span><span style=color:#e6db74></span><span style=color:#a6e22e>[ApiController]</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuthenticateController</span> : ControllerBase
{
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> UserManager&lt;IdentityUser&gt; <span style=color:#ae81ff>_</span>userManager;
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> RoleManager&lt;IdentityRole&gt; <span style=color:#ae81ff>_</span>roleManager;
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IConfiguration <span style=color:#ae81ff>_</span>configuration;

    <span style=color:#66d9ef>public</span> AuthenticateController(
        UserManager&lt;IdentityUser&gt; userManager,
        RoleManager&lt;IdentityRole&gt; roleManager,
        IConfiguration configuration)
    {
        <span style=color:#ae81ff>_</span>userManager = userManager;
        <span style=color:#ae81ff>_</span>roleManager = roleManager;
        <span style=color:#ae81ff>_</span>configuration = configuration;
    }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [HttpPost]</span>
<span style=color:#a6e22e>    [Route(&#34;login&#34;)]</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;IActionResult&gt; Login([FromBody] LoginModel userModel)
    {
        <span style=color:#66d9ef>var</span> user = <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>userManager.FindByEmailAsync(userModel.Email);
        <span style=color:#66d9ef>if</span> (user != <span style=color:#66d9ef>null</span> &amp;&amp; <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>userManager.CheckPasswordAsync(user, userModel.Password))
        {
            <span style=color:#66d9ef>var</span> userRoles = <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>userManager.GetRolesAsync(user);

            <span style=color:#66d9ef>var</span> claims = <span style=color:#66d9ef>new</span> List&lt;Claim&gt;
                {
                    <span style=color:#66d9ef>new</span> Claim(ClaimTypes.Name, user.UserName),
                    <span style=color:#66d9ef>new</span> Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()),
                };

            <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> userRole <span style=color:#66d9ef>in</span> userRoles)
            {
                claims.Add(<span style=color:#66d9ef>new</span> Claim(ClaimTypes.Role, userRole));
            }

            <span style=color:#66d9ef>var</span> token = CreateToken(claims);

            <span style=color:#66d9ef>return</span> Ok(<span style=color:#66d9ef>new</span>
            {
                token = <span style=color:#66d9ef>new</span> JwtSecurityTokenHandler().WriteToken(token),
                expiration = token.ValidTo
            });
        }
        <span style=color:#66d9ef>return</span> Unauthorized();
    }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [HttpPost]</span>
<span style=color:#a6e22e>    [Route(&#34;register&#34;)]</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;IActionResult&gt; Register([FromBody] RegisterModel model)
    {
        <span style=color:#66d9ef>var</span> userExists = <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>userManager.FindByEmailAsync(model.Email);
        <span style=color:#66d9ef>if</span> (userExists != <span style=color:#66d9ef>null</span>)
            <span style=color:#66d9ef>return</span> StatusCode(StatusCodes.Status500InternalServerError, <span style=color:#66d9ef>new</span> Response { 
                Status = <span style=color:#e6db74>&#34;Error&#34;</span>, Message = <span style=color:#e6db74>&#34;User already exists!&#34;</span> 
            });

        IdentityUser user = <span style=color:#66d9ef>new</span>()
        {
            Email = model.Email,
            SecurityStamp = Guid.NewGuid().ToString(),
            UserName = model.Username
        };
        <span style=color:#66d9ef>var</span> result = <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>userManager.CreateAsync(user, model.Password);
        <span style=color:#66d9ef>if</span> (!result.Succeeded)
            <span style=color:#66d9ef>return</span> StatusCode(StatusCodes.Status500InternalServerError, <span style=color:#66d9ef>new</span> Response { 
                Status = <span style=color:#e6db74>&#34;Error&#34;</span>, Message = <span style=color:#e6db74>&#34;User creation failed! Please check user details and try again.&#34;</span> 
            });

        <span style=color:#66d9ef>return</span> Ok(<span style=color:#66d9ef>new</span> Response { Status = <span style=color:#e6db74>&#34;Success&#34;</span>, Message = <span style=color:#e6db74>&#34;User created successfully!&#34;</span> });
    }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [HttpPost]</span>
<span style=color:#a6e22e>    [Route(&#34;register-admin&#34;)]</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;IActionResult&gt; RegisterAdmin([FromBody] RegisterModel model)
    {
        <span style=color:#66d9ef>var</span> userExists = <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>userManager.FindByEmailAsync(model.Email);
        <span style=color:#66d9ef>if</span> (userExists != <span style=color:#66d9ef>null</span>)
            <span style=color:#66d9ef>return</span> StatusCode(StatusCodes.Status500InternalServerError, <span style=color:#66d9ef>new</span> Response { 
                Status = <span style=color:#e6db74>&#34;Error&#34;</span>, Message = <span style=color:#e6db74>&#34;User already exists!&#34;</span> 
            });

        IdentityUser user = <span style=color:#66d9ef>new</span>()
        {
            Email = model.Email,
            SecurityStamp = Guid.NewGuid().ToString(),
            UserName = model.Username
        };
        <span style=color:#66d9ef>var</span> result = <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>userManager.CreateAsync(user, model.Password);
        <span style=color:#66d9ef>if</span> (!result.Succeeded)
            <span style=color:#66d9ef>return</span> StatusCode(StatusCodes.Status500InternalServerError, <span style=color:#66d9ef>new</span> Response { 
                Status = <span style=color:#e6db74>&#34;Error&#34;</span>, Message = <span style=color:#e6db74>&#34;User creation failed! Please check user details and try again.&#34;</span> 
            });

        <span style=color:#66d9ef>if</span> (!<span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>roleManager.RoleExistsAsync(UserRoles.Admin))
            <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>roleManager.CreateAsync(<span style=color:#66d9ef>new</span> IdentityRole(UserRoles.Admin));
        <span style=color:#66d9ef>if</span> (!<span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>roleManager.RoleExistsAsync(UserRoles.User))
            <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>roleManager.CreateAsync(<span style=color:#66d9ef>new</span> IdentityRole(UserRoles.User));

        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>roleManager.RoleExistsAsync(UserRoles.Admin))
        {
            <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>userManager.AddToRoleAsync(user, UserRoles.Admin);
        }
        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>roleManager.RoleExistsAsync(UserRoles.Admin))
        {
            <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>userManager.AddToRoleAsync(user, UserRoles.User);
        }
        <span style=color:#66d9ef>return</span> Ok(<span style=color:#66d9ef>new</span> Response { Status = <span style=color:#e6db74>&#34;Success&#34;</span>, Message = <span style=color:#e6db74>&#34;User created successfully!&#34;</span> });
    }

    <span style=color:#66d9ef>private</span> JwtSecurityToken CreateToken(List&lt;Claim&gt; claims)
    {
        <span style=color:#66d9ef>var</span> secretkey = <span style=color:#66d9ef>new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(
            <span style=color:#ae81ff>_</span>configuration.GetValue&lt;<span style=color:#66d9ef>string</span>&gt;(<span style=color:#e6db74>&#34;JwtSettings:Secret&#34;</span>)));    <span style=color:#75715e>// _configuration.GetSection(&#34;JwtSettings:Secret&#34;).Value)
</span><span style=color:#75715e></span>
        <span style=color:#66d9ef>var</span> credentials = <span style=color:#66d9ef>new</span> SigningCredentials(secretkey, SecurityAlgorithms.HmacSha512Signature);

        <span style=color:#66d9ef>var</span> token = <span style=color:#66d9ef>new</span> JwtSecurityToken(   <span style=color:#75715e>// 亦可使用　SecurityTokenDescriptor　來産生 Token
</span><span style=color:#75715e></span>            issuer: <span style=color:#ae81ff>_</span>configuration.GetValue&lt;<span style=color:#66d9ef>string</span>&gt;(<span style=color:#e6db74>&#34;JwtSettings:ValidIssuer&#34;</span>),
            audience: <span style=color:#ae81ff>_</span>configuration.GetValue&lt;<span style=color:#66d9ef>string</span>&gt;(<span style=color:#e6db74>&#34;JwtSettings:ValidAudience&#34;</span>),
            expires: DateTime.Now.AddDays(<span style=color:#ae81ff>1</span>),
            claims: claims,
            signingCredentials: credentials);

        <span style=color:#66d9ef>return</span> token;
    }
}
</code></pre></td></tr></table>
</div>
</div><h2 id=有關實作-jwt-的流程>有關實作 JWT 的流程<a hidden class=anchor aria-hidden=true href=#有關實作-jwt-的流程>#</a></h2>
<p>透過 JWT 的實作可以讓你的專案實現 Token-base 的身份驗證與授權。 （Json Web Token) 實作的過程大致可以分成三個部分:</p>
<ul>
<li>在登入成功後産生合法的 JWT Token</li>
<li>每次收到 request 時驗證是否為合法有效的 JWT Token</li>
<li>在特定 API Endpoint 上驗證是否帶有 “合法有效的 JWT Token”，以達到權限管理的需求</li>
</ul>
<h3 id=産生合法的-jason-web-token>産生合法的 Jason Web Token<a hidden class=anchor aria-hidden=true href=#産生合法的-jason-web-token>#</a></h3>
<p>在上述 AuthenticateController.cs 程式中，我們建立一個 CreateToken() 的 function，並在登入檢核成功時産生一個 token 回傳。</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/169645083-9cbe450b-e30e-490e-8b66-1c05ea0c9a31.png alt=image>
</p>
<h3 id=設置驗證是否為合法有效的-jwt-token>設置驗證是否為合法有效的 JWT Token<a hidden class=anchor aria-hidden=true href=#設置驗證是否為合法有效的-jwt-token>#</a></h3>
<p>第一步，透過 DI 將 JWT 相關設定設置好，在 Programe.cs 檔案中的 ”<code>builder.Services.AddControllers();</code>“
程式碼之前加入以下有關使用 JWT 使用者授權驗證的程式邏輯：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>builder.Services.AddAuthentication(options =&gt;
    {
        options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
        options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
        options.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;

    })
    .AddJwtBearer(options =&gt;
    {
        <span style=color:#75715e>// 當驗證失敗時，回應標頭會包含 WWW-Authenticate 標頭，這裡會顯示失敗的詳細錯誤原因
</span><span style=color:#75715e></span>        options.IncludeErrorDetails = <span style=color:#66d9ef>true</span>; <span style=color:#75715e>// 預設值為 true，有時會特別關閉
</span><span style=color:#75715e></span>
        options.TokenValidationParameters = <span style=color:#66d9ef>new</span> TokenValidationParameters
        {
            <span style=color:#75715e>// 透過這項宣告，就可以從 &#34;NAME&#34; 取值
</span><span style=color:#75715e></span>            NameClaimType = <span style=color:#e6db74>&#34;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier&#34;</span>,
            <span style=color:#75715e>// 透過這項宣告，就可以從 &#34;Role&#34; 取值，並可讓 [Authorize] 判斷角色
</span><span style=color:#75715e></span>            RoleClaimType = <span style=color:#e6db74>&#34;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&#34;</span>,

            <span style=color:#75715e>// 驗證 Issuer (一般都會)
</span><span style=color:#75715e></span>            ValidateIssuer = <span style=color:#66d9ef>true</span>,
            ValidIssuer = <span style=color:#ae81ff>_</span>configuration.GetValue&lt;<span style=color:#66d9ef>string</span>&gt;(<span style=color:#e6db74>&#34;JwtSettings:ValidIssuer&#34;</span>),

            <span style=color:#75715e>// 驗證 Audience (通常不太需要)
</span><span style=color:#75715e></span>            ValidateAudience = <span style=color:#66d9ef>false</span>,
            <span style=color:#75715e>//ValidAudience = = _configuration.GetValue&lt;string&gt;(&#34;JwtSettings:ValidAudience&#34;),
</span><span style=color:#75715e></span>
            <span style=color:#75715e>// 驗證 Token 的有效期間 (一般都會)
</span><span style=color:#75715e></span>            ValidateLifetime = <span style=color:#66d9ef>true</span>,

            <span style=color:#75715e>// 如果 Token 中包含 key 才需要驗證，一般都只有簽章而已
</span><span style=color:#75715e></span>            ValidateIssuerSigningKey = <span style=color:#66d9ef>false</span>,

            <span style=color:#75715e>// 應該從 IConfiguration 取得
</span><span style=color:#75715e></span>            IssuerSigningKey = <span style=color:#66d9ef>new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(secret))
        };
    });
</code></pre></td></tr></table>
</div>
</div><p>同時宣告一個 Secret 變數，並由 appsettings.json 系統配置檔中讀出 Jwt Secret 的設定。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// ...
</span><span style=color:#75715e></span>ConfigurationManager <span style=color:#ae81ff>_</span>configuration = builder.Configuration;
<span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>var</span> secret = <span style=color:#ae81ff>_</span>configuration.GetValue&lt;<span style=color:#66d9ef>string</span>&gt;(<span style=color:#e6db74>&#34;JwtSettings:Secret&#34;</span>);
</span><span style=color:#75715e>// ...
</span></code></pre></td></tr></table>
</div>
</div><p>第二步，要啟動 request pipeline 中的 Middleware (UseAuthentication & UseAuthorization 都需要)</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// ...
</span><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#75715e></span>app.UseAuthentication();
</span>app.UseAuthorization();
<span style=color:#75715e>// ...
</span></code></pre></td></tr></table>
</div>
</div><h3 id=在特定-api-endpoint-上驗證是否帶有合法有效的-jwt-token>在特定 API EndPoint 上驗證是否帶有合法有效的 JWT Token<a hidden class=anchor aria-hidden=true href=#在特定-api-endpoint-上驗證是否帶有合法有效的-jwt-token>#</a></h3>
<p>在 WeatherForecastController.cs Get() function 上加入 “<code>[Authorize]</code>” 即可</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#a6e22e>    [Authorize]</span>
</span><span style=color:#a6e22e>    [HttpGet(Name = &#34;GetWeatherForecast&#34;)]</span>
    <span style=color:#66d9ef>public</span> IEnumerable&lt;WeatherForecast&gt; Get()
    {
        <span style=color:#66d9ef>return</span> Enumerable.Range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>5</span>).Select(index =&gt; <span style=color:#66d9ef>new</span> WeatherForecast
        {
            Date = DateTime.Now.AddDays(index),
            TemperatureC = Random.Shared.Next(-<span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>55</span>),
            Summary = Summaries[Random.Shared.Next(Summaries.Length)]
        })
        .ToArray();
    }
</code></pre></td></tr></table>
</div>
</div><h3 id=使用-openapi-swagger-來測試-api>使用 OpenApi Swagger 來測試 API<a hidden class=anchor aria-hidden=true href=#使用-openapi-swagger-來測試-api>#</a></h3>
<p>如上程式加入<code>[Authorize]</code>後，以<code>dotnet watch</code>執行程式，進入 OpenApi Swagger 網頁瀏覽 weatherforecast endpoint，會回傳 Status: 401 Unauthorized 的錯誤訊息。</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223022987-6142887b-11be-4d23-88d7-39adc27ca45a.png alt=image>
</p>
<p>在 OpenApi Swagger 網頁點選 register endpoint 來註冊一個新使用者</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223023581-bfa2d47e-39ca-4c3b-b9de-36b2890b9bf8.png alt=image>
</p>
<p>輸入註冊資料，執行送出，畫面顯示成功！</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223023730-995193d9-dec8-40ee-9afc-7aff1fbeddf0.png alt=image>
</p>
<p>可查看資料庫結果，已在 AspNetUsers Table 中新建立一筆使用者資料：</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223023969-40466f8b-efb5-4ea9-b730-dac3e2d0bae7.png alt=image>
</p>
<p>OpenApi Swagger 來測試 API 時, Swagger 測試網頁預設是沒有設定 Token 的功能,必須將程式碼中的 “<code>builder.Services.AddSwaggerGen();</code>”改成以下內容</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>builder.Services.AddSwaggerGen(c =&gt;
{
    c.SwaggerDoc(<span style=color:#e6db74>&#34;v1&#34;</span>, <span style=color:#66d9ef>new</span> OpenApiInfo { Title = <span style=color:#e6db74>&#34;JwtDemo&#34;</span>, Version = <span style=color:#e6db74>&#34;v1&#34;</span> });
    c.AddSecurityDefinition(<span style=color:#e6db74>&#34;Bearer&#34;</span>, <span style=color:#66d9ef>new</span> OpenApiSecurityScheme
    {
        In = ParameterLocation.Header,
        Description = <span style=color:#e6db74>&#34;Please enter JWT with Bearer into field&#34;</span>,
        Name = <span style=color:#e6db74>&#34;Authorization&#34;</span>,
        Type = SecuritySchemeType.ApiKey
    });
    c.AddSecurityRequirement(<span style=color:#66d9ef>new</span> OpenApiSecurityRequirement
    {
        {
            <span style=color:#66d9ef>new</span> OpenApiSecurityScheme
                {
                    Reference = <span style=color:#66d9ef>new</span> OpenApiReference { Type = ReferenceType.SecurityScheme, Id = <span style=color:#e6db74>&#34;Bearer&#34;</span>}
                },
            <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>string</span>[] {}
        }
    });
});
</code></pre></td></tr></table>
</div>
</div><p>有了上述的程式設定，當再次 dotnet watch 啟動程式後，瀏覽器呈現的 Swagger 畫面右上角會多出了｀Authorize｀ 的按鈕。按下按鈕就是讓你填入登入成功後回傳的 Token</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/168768593-f2dde2f9-d4b2-43dd-85f5-ef080ff8c13a.png alt=image>
</p>
<p>使用合法（已完成註冊）使用者帳號／密碼來登入：</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223043509-22f879fe-83f5-47c0-ab6e-131797212e7b.png alt=image>
登入成功後回傳的 response 中會包含 token：</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223041748-d99925fe-afbe-484c-818b-32a933719a02.png alt=image>
</p>
<p>在 &ldquo;Value:&rdquo;" 文字框內填入 &ldquo;Bearer eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTUxMiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZ&mldr;.."，再按下 Authorize 按鈕即表下在接下來的 Request 中都會自動帶入 Token 傳給 WebApi Server。 （請注意 Bearer後再先接著一個空白字元再加上 Token值）</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/168768975-0274c3cf-eba6-49bc-a696-36df5b2a97db.png alt=image>
</p>
<p>再次執行　&ldquo;WeatherForecast&rdquo; 的測試(Execute)　就可正常的取得回傳值了</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223042216-89d313db-adc3-4659-87b7-afac0d57ff62.png alt=image>
</p>
<h3 id=加入-git-版本控制>加入 git 版本控制<a hidden class=anchor aria-hidden=true href=#加入-git-版本控制>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ git commit -m <span style=color:#e6db74>&#34;finished JWT function&#34;</span> -a
</code></pre></div><h2 id=使用aspnet-codegenerator工具來自動産生程式碼>使用　aspnet-codegenerator　工具來自動産生程式碼<a hidden class=anchor aria-hidden=true href=#使用aspnet-codegenerator工具來自動産生程式碼>#</a></h2>
<p>最後我們來看看如何使用工具來自動産生程式去維護一個新的資料表</p>
<h3 id=在-models-目錄下新增一個-model模型-class---todolist>在 Models 目錄下新增一個 model(模型) class - TodoList<a hidden class=anchor aria-hidden=true href=#在-models-目錄下新增一個-model模型-class---todolist>#</a></h3>
<p>使用 dotnet cli 來新增一個 class</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet new class -o Models -n TodoList
</code></pre></div><p>産生出來的空的程式框架：</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/223054862-53a8302f-f529-4d29-9874-a0946a249dab.png alt=image>
</p>
<p>將 Models/TodoList.cs 補齊欄位設定</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>namespace</span> dotnet7_webapi_jwt.Models;
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoList</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> Id { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string?</span> Title { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string?</span> Details { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> Done { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
}
</code></pre></td></tr></table>
</div>
</div><h3 id=在-apidbcontextcs-中宣告一個-todolist-table>在 ApiDbContext.cs 中宣告一個 TodoList table<a hidden class=anchor aria-hidden=true href=#在-apidbcontextcs-中宣告一個-todolist-table>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>        <span style=color:#66d9ef>public</span> DbSet&lt;TodoList&gt;? TodoList { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }  <span style=color:#960050;background-color:#1e0010>#放在程式最後面</span>
</code></pre></div><h3 id=新增一個遷移與更新資料庫>新增一個遷移與更新資料庫<a hidden class=anchor aria-hidden=true href=#新增一個遷移與更新資料庫>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet build
$ dotnet ef migrations add <span style=color:#e6db74>&#34;Add New Table - TodoList&#34;</span>
$ dotnet ef database update 
</code></pre></div><p>註：｀$ dotnet ef migrations remove｀ 可移除最後一個 migration</p>
<h3 id=使用-aspnet-codegenerator-自動產生-todo-controller>使用 ASPNET Codegenerator 自動產生 Todo Controller<a hidden class=anchor aria-hidden=true href=#使用-aspnet-codegenerator-自動產生-todo-controller>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dotnet aspnet-codegenerator controller -name TodoController -async -api -m TodoList -dc ApiDbContext -outDir Controllers

Building project ...
Finding the generator <span style=color:#e6db74>&#39;controller&#39;</span>...
Running the generator <span style=color:#e6db74>&#39;controller&#39;</span>...

Minimal hosting scenario!
Attempting to compile the application in memory.
Attempting to figure out the EntityFramework metadata <span style=color:#66d9ef>for</span> the model and DbContext: <span style=color:#e6db74>&#39;TodoList&#39;</span>

Using database provider <span style=color:#e6db74>&#39;Npgsql.EntityFrameworkCore.PostgreSQL&#39;</span>!

Added Controller : <span style=color:#e6db74>&#39;/Controllers/TodoController.cs&#39;</span>.
RunTime 00:00:08.68
</code></pre></div><p>TodoController.cs</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>using</span> System;
<span style=color:#66d9ef>using</span> System.Collections.Generic;
<span style=color:#66d9ef>using</span> System.Linq;
<span style=color:#66d9ef>using</span> System.Threading.Tasks;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Http;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Mvc;
<span style=color:#66d9ef>using</span> Microsoft.EntityFrameworkCore;
<span style=color:#66d9ef>using</span> dotnet7_webapi_jwt;
<span style=color:#66d9ef>using</span> dotnet7_webapi_jwt.Data;

<span style=color:#66d9ef>namespace</span> dotnet7_webapi_jwt.Controllers
{
<span style=color:#a6e22e>    [Route(&#34;api/[controller]</span><span style=color:#e6db74>&#34;)]
</span><span style=color:#e6db74></span><span style=color:#a6e22e>    [ApiController]</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoController</span> : ControllerBase
    {
        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> ApiDbContext <span style=color:#ae81ff>_</span>context;

        <span style=color:#66d9ef>public</span> TodoController(ApiDbContext context)
        {
            <span style=color:#ae81ff>_</span>context = context;
        }

        <span style=color:#75715e>// GET: api/Todo
</span><span style=color:#75715e></span><span style=color:#a6e22e>        [HttpGet]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;ActionResult&lt;IEnumerable&lt;TodoList&gt;&gt;&gt; GetTodoList()
        {
          <span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>_</span>context.TodoList == <span style=color:#66d9ef>null</span>)
          {
              <span style=color:#66d9ef>return</span> NotFound();
          }
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>context.TodoList.ToListAsync();
        }

        <span style=color:#75715e>// GET: api/Todo/5
</span><span style=color:#75715e></span><span style=color:#a6e22e>        [HttpGet(&#34;{id}&#34;)]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;ActionResult&lt;TodoList&gt;&gt; GetTodoList(<span style=color:#66d9ef>int</span> id)
        {
          <span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>_</span>context.TodoList == <span style=color:#66d9ef>null</span>)
          {
              <span style=color:#66d9ef>return</span> NotFound();
          }
            <span style=color:#66d9ef>var</span> todoList = <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>context.TodoList.FindAsync(id);

            <span style=color:#66d9ef>if</span> (todoList == <span style=color:#66d9ef>null</span>)
            {
                <span style=color:#66d9ef>return</span> NotFound();
            }

            <span style=color:#66d9ef>return</span> todoList;
        }

        <span style=color:#75715e>// PUT: api/Todo/5
</span><span style=color:#75715e></span>        <span style=color:#75715e>// To protect from overposting attacks, see https://go.microsoft.com/fwlink/?linkid=2123754
</span><span style=color:#75715e></span><span style=color:#a6e22e>        [HttpPut(&#34;{id}&#34;)]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;IActionResult&gt; PutTodoList(<span style=color:#66d9ef>int</span> id, TodoList todoList)
        {
            <span style=color:#66d9ef>if</span> (id != todoList.Id)
            {
                <span style=color:#66d9ef>return</span> BadRequest();
            }

            <span style=color:#ae81ff>_</span>context.Entry(todoList).State = EntityState.Modified;

            <span style=color:#66d9ef>try</span>
            {
                <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>context.SaveChangesAsync();
            }
            <span style=color:#66d9ef>catch</span> (DbUpdateConcurrencyException)
            {
                <span style=color:#66d9ef>if</span> (!TodoListExists(id))
                {
                    <span style=color:#66d9ef>return</span> NotFound();
                }
                <span style=color:#66d9ef>else</span>
                {
                    <span style=color:#66d9ef>throw</span>;
                }
            }

            <span style=color:#66d9ef>return</span> NoContent();
        }

        <span style=color:#75715e>// POST: api/Todo
</span><span style=color:#75715e></span>        <span style=color:#75715e>// To protect from overposting attacks, see https://go.microsoft.com/fwlink/?linkid=2123754
</span><span style=color:#75715e></span><span style=color:#a6e22e>        [HttpPost]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;ActionResult&lt;TodoList&gt;&gt; PostTodoList(TodoList todoList)
        {
          <span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>_</span>context.TodoList == <span style=color:#66d9ef>null</span>)
          {
              <span style=color:#66d9ef>return</span> Problem(<span style=color:#e6db74>&#34;Entity set &#39;ApiDbContext.TodoList&#39;  is null.&#34;</span>);
          }
            <span style=color:#ae81ff>_</span>context.TodoList.Add(todoList);
            <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>context.SaveChangesAsync();

            <span style=color:#66d9ef>return</span> CreatedAtAction(<span style=color:#e6db74>&#34;GetTodoList&#34;</span>, <span style=color:#66d9ef>new</span> { id = todoList.Id }, todoList);
        }

        <span style=color:#75715e>// DELETE: api/Todo/5
</span><span style=color:#75715e></span><span style=color:#a6e22e>        [HttpDelete(&#34;{id}&#34;)]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;IActionResult&gt; DeleteTodoList(<span style=color:#66d9ef>int</span> id)
        {
            <span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>_</span>context.TodoList == <span style=color:#66d9ef>null</span>)
            {
                <span style=color:#66d9ef>return</span> NotFound();
            }
            <span style=color:#66d9ef>var</span> todoList = <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>context.TodoList.FindAsync(id);
            <span style=color:#66d9ef>if</span> (todoList == <span style=color:#66d9ef>null</span>)
            {
                <span style=color:#66d9ef>return</span> NotFound();
            }

            <span style=color:#ae81ff>_</span>context.TodoList.Remove(todoList);
            <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>context.SaveChangesAsync();

            <span style=color:#66d9ef>return</span> NoContent();
        }

        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>bool</span> TodoListExists(<span style=color:#66d9ef>int</span> id)
        {
            <span style=color:#66d9ef>return</span> (<span style=color:#ae81ff>_</span>context.TodoList?.Any(e =&gt; e.Id == id)).GetValueOrDefault();
        }
    }
}

</code></pre></td></tr></table>
</div>
</div><h3 id=測試新功能>測試新功能<a hidden class=anchor aria-hidden=true href=#測試新功能>#</a></h3>
<p>在 open api - swagger 網頁上透過 POST 的 EndPoint 新增一筆 Toto list</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/169677520-3cba411e-f4e1-421c-88a9-0db52a981b47.png alt=image>
</p>
<p>送出新增的資料，回覆新增成功</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/169677538-55e9ca68-5bf1-49ce-9bd1-4fa6a0f1fe53.png alt=image>
</p>
<p>由資料庫中可以查詢到新建立的 record</p>
<p>!<img loading=lazy src=https://user-images.githubusercontent.com/21993717/223059310-a4ec3825-325e-4bbd-8465-c67ab2bf1e46.png alt=image>
</p>
<p>透過 GET 的 EndPoint 也可以查詢到新增 Toto list</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/21993717/169677646-1d086a10-8230-46ae-97f3-2ce4b0d249ea.png alt=image>
</p>
<p>以上可以發現使用 ASPNET Codegenerator 自動産生的程式就可簡單的完成資料表格的新增、查詢、修改、刪除等日常功能，真是方便呢！</p>
<h2 id=cors-議題>CORS 議題<a hidden class=anchor aria-hidden=true href=#cors-議題>#</a></h2>
<p>Web App 與 Web Api Server 若處於“不同源”時，當 App 使用 http request 呼叫 Web Api Server 上端點時就會有“同源策略“的問題，這個狀況在測試環境中尤為明顯。
要解決這個問題就必須透過 CORS (Cross-Origin Resource Sharing) 相關設定來應對。在 DotNet Core 中設定相關簡易，僅須在 Program.cs 中加入以下二段程式碼即可：</p>
<p>以下程式碼放在 “<code>builder.Services.AddControllers();</code>” 之前：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>var</span> MyAllOrigins = <span style=color:#e6db74>&#34;allowAll&#34;</span>;
builder.Services.AddCors(option =&gt; 
    option.AddPolicy(name: MyAllOrigins, 
        policy =&gt;
        {
            policy.WithOrigins(<span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>).AllowAnyMethod().AllowAnyHeader();
        }
    )
);
</code></pre></td></tr></table>
</div>
</div><p>以及</p>
<p>以下程式碼放在 “<code>app.UseHttpsRedirection();</code>” 之前：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>app.UseCors(MyAllOrigins);
</code></pre></div><p>完成後，當前端 Web App (如： angular 在測試環境下預設是使用 localhost:4200) 使用 http request 呼叫後端 Web Api (本例中 Web Api 使用的是 localhost:5023) 時就可避到同源策略的要求。</p>
<p>Program.cs 完整程式碼</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>using</span> System.Text;
<span style=color:#66d9ef>using</span> dotnet7_webapi_jwt.Data;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Authentication.JwtBearer;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Identity;
<span style=color:#66d9ef>using</span> Microsoft.EntityFrameworkCore;
<span style=color:#66d9ef>using</span> Microsoft.IdentityModel.Tokens;
<span style=color:#66d9ef>using</span> Microsoft.OpenApi.Models;

<span style=color:#66d9ef>var</span> builder = WebApplication.CreateBuilder(args);

ConfigurationManager <span style=color:#ae81ff>_</span>configuration = builder.Configuration;
<span style=color:#66d9ef>var</span> secret = <span style=color:#ae81ff>_</span>configuration.GetValue&lt;<span style=color:#66d9ef>string</span>&gt;(<span style=color:#e6db74>&#34;JwtSettings:Secret&#34;</span>);

<span style=color:#75715e>// Add services to the container.
</span><span style=color:#75715e></span>builder.Services.AddDbContext&lt;ApiDbContext&gt;(
    options =&gt; options.UseNpgsql(
        <span style=color:#ae81ff>_</span>configuration.GetConnectionString(<span style=color:#e6db74>&#34;ConnStr&#34;</span>)
    )
);
builder.Services.AddIdentity&lt;IdentityUser, IdentityRole&gt;()
    .AddEntityFrameworkStores&lt;ApiDbContext&gt;()
    .AddDefaultTokenProviders();

builder.Services.AddAuthentication(options =&gt;
    {
        options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
        options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
        options.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;

    })
    .AddJwtBearer(options =&gt;
    {
        <span style=color:#75715e>// 當驗證失敗時，回應標頭會包含 WWW-Authenticate 標頭，這裡會顯示失敗的詳細錯誤原因
</span><span style=color:#75715e></span>        options.IncludeErrorDetails = <span style=color:#66d9ef>true</span>; <span style=color:#75715e>// 預設值為 true，有時會特別關閉
</span><span style=color:#75715e></span>
        options.TokenValidationParameters = <span style=color:#66d9ef>new</span> TokenValidationParameters
        {
            <span style=color:#75715e>// 透過這項宣告，就可以從 &#34;NAME&#34; 取值
</span><span style=color:#75715e></span>            NameClaimType = <span style=color:#e6db74>&#34;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier&#34;</span>,
            <span style=color:#75715e>// 透過這項宣告，就可以從 &#34;Role&#34; 取值，並可讓 [Authorize] 判斷角色
</span><span style=color:#75715e></span>            RoleClaimType = <span style=color:#e6db74>&#34;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&#34;</span>,

            <span style=color:#75715e>// 驗證 Issuer (一般都會)
</span><span style=color:#75715e></span>            ValidateIssuer = <span style=color:#66d9ef>true</span>,
            ValidIssuer = <span style=color:#ae81ff>_</span>configuration.GetValue&lt;<span style=color:#66d9ef>string</span>&gt;(<span style=color:#e6db74>&#34;JwtSettings:ValidIssuer&#34;</span>),

            <span style=color:#75715e>// 驗證 Audience (通常不太需要)
</span><span style=color:#75715e></span>            ValidateAudience = <span style=color:#66d9ef>false</span>,
            <span style=color:#75715e>//ValidAudience = = _configuration.GetValue&lt;string&gt;(&#34;JwtSettings:ValidAudience&#34;),
</span><span style=color:#75715e></span>
            <span style=color:#75715e>// 驗證 Token 的有效期間 (一般都會)
</span><span style=color:#75715e></span>            ValidateLifetime = <span style=color:#66d9ef>true</span>,

            <span style=color:#75715e>// 如果 Token 中包含 key 才需要驗證，一般都只有簽章而已
</span><span style=color:#75715e></span>            ValidateIssuerSigningKey = <span style=color:#66d9ef>false</span>,

            <span style=color:#75715e>// 應該從 IConfiguration 取得
</span><span style=color:#75715e></span>            IssuerSigningKey = <span style=color:#66d9ef>new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(secret))
        };
    });
        
<span style=color:#66d9ef>var</span> allOrigins = <span style=color:#e6db74>&#34;allowAll&#34;</span>;
builder.Services.AddCors(option =&gt; 
    option.AddPolicy(name: allOrigins, 
        policy =&gt;
        {
            policy.WithOrigins(<span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>).AllowAnyMethod().AllowAnyHeader();
        }
    )
);

builder.Services.AddControllers();
<span style=color:#75715e>// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
</span><span style=color:#75715e></span>builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =&gt;
{
    c.SwaggerDoc(<span style=color:#e6db74>&#34;v1&#34;</span>, <span style=color:#66d9ef>new</span> OpenApiInfo { Title = <span style=color:#e6db74>&#34;JwtDemo&#34;</span>, Version = <span style=color:#e6db74>&#34;v1&#34;</span> });
    c.AddSecurityDefinition(<span style=color:#e6db74>&#34;Bearer&#34;</span>, <span style=color:#66d9ef>new</span> OpenApiSecurityScheme
    {
        In = ParameterLocation.Header,
        Description = <span style=color:#e6db74>&#34;Please enter JWT with Bearer into field&#34;</span>,
        Name = <span style=color:#e6db74>&#34;Authorization&#34;</span>,
        Type = SecuritySchemeType.ApiKey
    });
    c.AddSecurityRequirement(<span style=color:#66d9ef>new</span> OpenApiSecurityRequirement
    {
        {
            <span style=color:#66d9ef>new</span> OpenApiSecurityScheme
                {
                    Reference = <span style=color:#66d9ef>new</span> OpenApiReference { Type = ReferenceType.SecurityScheme, Id = <span style=color:#e6db74>&#34;Bearer&#34;</span>}
                },
            <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>string</span>[] {}
        }
    });
});

<span style=color:#66d9ef>var</span> app = builder.Build();

<span style=color:#75715e>// Configure the HTTP request pipeline.
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseCors(allOrigins);
app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();
</code></pre></td></tr></table>
</div>
</div>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://calvinegs.github.io/tags/dotnet-7/>dotnet 7</a></li>
<li><a href=https://calvinegs.github.io/tags/webapi/>webapi</a></li>
<li><a href=https://calvinegs.github.io/tags/jwt/>JWT</a></li>
<li><a href=https://calvinegs.github.io/tags/docker/>docker</a></li>
<li><a href=https://calvinegs.github.io/tags/postgresql-db/>PostgreSQL DB</a></li>
<li><a href=https://calvinegs.github.io/tags/openapi/>openapi</a></li>
<li><a href=https://calvinegs.github.io/tags/swagger/>swagger</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://calvinegs.github.io/posts/angular-standalone-component/>
<span class=title>« Prev Page</span>
<br>
<span>How to using Angular Standalone Component</span>
</a>
<a class=next href=https://calvinegs.github.io/posts/docker-compose-mssql/>
<span class=title>Next Page »</span>
<br>
<span>使用 Docker Compose 執行 MSSQL Server 2022</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料） on twitter" href="https://twitter.com/intent/tweet/?text=%e4%bd%bf%e7%94%a8%20.NET%207.0%20%e5%bb%ba%e7%ab%8b%e4%bd%bf%e7%94%a8%20%e4%bb%a5%20JWT%20%e8%ba%ab%e4%bb%bd%e9%a9%97%e8%ad%89%e6%a9%9f%e5%88%b6%e7%9a%84%20ASP.NET%20Web%20Api%ef%bc%88%e4%b8%a6%e4%bd%bf%e7%94%a8%20Microsoft%20Identity%20%e6%a1%86%e6%9e%b6%e4%be%86%e5%ad%98%e5%84%b2%e4%bd%bf%e7%94%a8%e8%80%85%e5%92%8c%e8%a7%92%e8%89%b2%e7%ad%89%e8%b3%87%e6%96%99%ef%bc%89&url=https%3a%2f%2fcalvinegs.github.io%2fposts%2fdotnet7-webapi-jwt%2f&hashtags=dotnet7%2cwebapi%2cjwt%2cdocker%2cPostgreSQLDB%2copenapi%2cswagger"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料） on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fcalvinegs.github.io%2fposts%2fdotnet7-webapi-jwt%2f&title=%e4%bd%bf%e7%94%a8%20.NET%207.0%20%e5%bb%ba%e7%ab%8b%e4%bd%bf%e7%94%a8%20%e4%bb%a5%20JWT%20%e8%ba%ab%e4%bb%bd%e9%a9%97%e8%ad%89%e6%a9%9f%e5%88%b6%e7%9a%84%20ASP.NET%20Web%20Api%ef%bc%88%e4%b8%a6%e4%bd%bf%e7%94%a8%20Microsoft%20Identity%20%e6%a1%86%e6%9e%b6%e4%be%86%e5%ad%98%e5%84%b2%e4%bd%bf%e7%94%a8%e8%80%85%e5%92%8c%e8%a7%92%e8%89%b2%e7%ad%89%e8%b3%87%e6%96%99%ef%bc%89&summary=%e4%bd%bf%e7%94%a8%20.NET%207.0%20%e5%bb%ba%e7%ab%8b%e4%bd%bf%e7%94%a8%20%e4%bb%a5%20JWT%20%e8%ba%ab%e4%bb%bd%e9%a9%97%e8%ad%89%e6%a9%9f%e5%88%b6%e7%9a%84%20ASP.NET%20Web%20Api%ef%bc%88%e4%b8%a6%e4%bd%bf%e7%94%a8%20Microsoft%20Identity%20%e6%a1%86%e6%9e%b6%e4%be%86%e5%ad%98%e5%84%b2%e4%bd%bf%e7%94%a8%e8%80%85%e5%92%8c%e8%a7%92%e8%89%b2%e7%ad%89%e8%b3%87%e6%96%99%ef%bc%89&source=https%3a%2f%2fcalvinegs.github.io%2fposts%2fdotnet7-webapi-jwt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料） on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcalvinegs.github.io%2fposts%2fdotnet7-webapi-jwt%2f&title=%e4%bd%bf%e7%94%a8%20.NET%207.0%20%e5%bb%ba%e7%ab%8b%e4%bd%bf%e7%94%a8%20%e4%bb%a5%20JWT%20%e8%ba%ab%e4%bb%bd%e9%a9%97%e8%ad%89%e6%a9%9f%e5%88%b6%e7%9a%84%20ASP.NET%20Web%20Api%ef%bc%88%e4%b8%a6%e4%bd%bf%e7%94%a8%20Microsoft%20Identity%20%e6%a1%86%e6%9e%b6%e4%be%86%e5%ad%98%e5%84%b2%e4%bd%bf%e7%94%a8%e8%80%85%e5%92%8c%e8%a7%92%e8%89%b2%e7%ad%89%e8%b3%87%e6%96%99%ef%bc%89"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料） on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcalvinegs.github.io%2fposts%2fdotnet7-webapi-jwt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料） on whatsapp" href="https://api.whatsapp.com/send?text=%e4%bd%bf%e7%94%a8%20.NET%207.0%20%e5%bb%ba%e7%ab%8b%e4%bd%bf%e7%94%a8%20%e4%bb%a5%20JWT%20%e8%ba%ab%e4%bb%bd%e9%a9%97%e8%ad%89%e6%a9%9f%e5%88%b6%e7%9a%84%20ASP.NET%20Web%20Api%ef%bc%88%e4%b8%a6%e4%bd%bf%e7%94%a8%20Microsoft%20Identity%20%e6%a1%86%e6%9e%b6%e4%be%86%e5%ad%98%e5%84%b2%e4%bd%bf%e7%94%a8%e8%80%85%e5%92%8c%e8%a7%92%e8%89%b2%e7%ad%89%e8%b3%87%e6%96%99%ef%bc%89%20-%20https%3a%2f%2fcalvinegs.github.io%2fposts%2fdotnet7-webapi-jwt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 使用 .NET 7.0 建立使用 以 JWT 身份驗證機制的 ASP.NET Web Api（並使用 Microsoft Identity 框架來存儲使用者和角色等資料） on telegram" href="https://telegram.me/share/url?text=%e4%bd%bf%e7%94%a8%20.NET%207.0%20%e5%bb%ba%e7%ab%8b%e4%bd%bf%e7%94%a8%20%e4%bb%a5%20JWT%20%e8%ba%ab%e4%bb%bd%e9%a9%97%e8%ad%89%e6%a9%9f%e5%88%b6%e7%9a%84%20ASP.NET%20Web%20Api%ef%bc%88%e4%b8%a6%e4%bd%bf%e7%94%a8%20Microsoft%20Identity%20%e6%a1%86%e6%9e%b6%e4%be%86%e5%ad%98%e5%84%b2%e4%bd%bf%e7%94%a8%e8%80%85%e5%92%8c%e8%a7%92%e8%89%b2%e7%ad%89%e8%b3%87%e6%96%99%ef%bc%89&url=https%3a%2f%2fcalvinegs.github.io%2fposts%2fdotnet7-webapi-jwt%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
<div>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='calvinegs-github-io',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</article>
</main>
<footer class=footer>
<span>&copy; 2023 <a href=https://calvinegs.github.io/>永誌不忘 • 筆記簿</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>